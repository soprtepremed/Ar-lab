<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Resultados - Ar Lab</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <script src="navbar.js" defer></script>
    <style>
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #14b8a6;
            --sidebar-bg: #1e293b;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text-dark);
        }


        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            margin-top: 0;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .page-title svg {
            width: 32px;
            height: 32px;
            stroke: var(--primary);
            fill: none;
            stroke-width: 2;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .filter-select,
        .filter-input {
            padding: 0.625rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 180px;
            background: white;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.en-proceso {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.listo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.validado {
            background: #c7d2fe;
            color: #3730a3;
        }

        .status-badge.entregado {
            background: #e5e7eb;
            color: #374151;
        }

        /* Cards Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.2s;
        }

        .result-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .patient-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .patient-info p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .folio-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.25rem;
        }

        .studies-list {
            list-style: none;
        }

        .study-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .study-item:last-child {
            border-bottom: none;
        }

        .study-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .card-footer {
            padding: 1rem 1.25rem;
            background: #f8fafc;
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-decoration: none;
            flex: 1;
        }

        .btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-outline {
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #f1f5f9;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-light);
            fill: none;
            stroke-width: 2;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .result-form-group {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .result-form-group h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .result-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .input-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 0.625rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .reference-range {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: white;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            stroke: #cbd5e1;
            fill: none;
            stroke-width: 1.5;
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        /* Patient Sidebar Active State */
        .patient-card:hover {
            background-color: #f1f5f9 !important;
        }

        .patient-card.active {
            background-color: #e0f2fe !important;
            /* Light Blue Highlight */
            border-left: 4px solid #0d9488 !important;
            /* Primary Color Accent */
            border-color: #bae6fd !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
            }

            .result-inputs {
                grid-template-columns: 1fr;
            }
        }

        @keyframes pulse-gray {
            0% {
                box-shadow: 0 0 0 0 rgba(156, 163, 175, 0.7);
                transform: scale(0.95);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(156, 163, 175, 0);
                transform: scale(1);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(156, 163, 175, 0);
                transform: scale(0.95);
            }
        }

        .status-pulse {
            animation: pulse-gray 2s infinite;
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">
                <svg viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Captura de Resultados <span style="font-size: 0.8rem; opacity: 0.5; margin-left: 10px;">v1.2</span>
            </h1>
        </header>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="filter-group">
                <span class="filter-label">Buscar Paciente</span>
                <input type="text" class="filter-input" id="searchPatient" placeholder="Nombre o folio..."
                    oninput="filterResults()">
            </div>
            <div class="filter-group">
                <span class="filter-label">Estado</span>
                <select class="filter-select" id="filterStatus" onchange="filterResults()">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="en-proceso">En Proceso</option>
                    <option value="listo">Listo</option>
                    <option value="validado">Validado</option>
                    <option value="entregado">Entregado</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Fecha</span>
                <input type="date" class="filter-input" id="filterDate" onchange="filterResults()">
            </div>
        </div>

        <!-- Results Grid -->
        <div class="results-grid" id="resultsGrid">
            <!-- Cards will be loaded here -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <svg viewBox="0 0 24 24">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <h3>No hay estudios pendientes</h3>
            <p>Los estudios de las citas aparecerán aquí para capturar resultados.</p>
        </div>
    </main>

    <!-- Capture Section (Single Patient) -->
    <div id="captureSection" style="display: none; height: calc(100vh - 100px);">
        <div style="display: flex; height: 100%; gap: 1.5rem;">
            <!-- Sidebar -->
            <aside id="patientSidebar" style="
                width: 360px; 
                background: white; 
                border-radius: 12px; 
                border: 1px solid #e2e8f0; 
                display: flex; 
                flex-direction: column; 
                overflow: hidden;
                flex-shrink: 0;
            ">
                <div style="padding: 0.5rem; border-bottom: 1px solid #e2e8f0; display: flex; gap: 4px;">
                    <input type="date" id="sidebarFilterDate" onchange="loadCitasConEstudios()"
                        style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem; color: #334155;">
                </div>
                <div style="padding: 0 0.5rem 0.5rem 0.5rem; border-bottom: 1px solid #e2e8f0;">
                    <select id="filterArea" onchange="renderSidebarList(allCitas); renderCaptureValues();"
                        style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem; color: #334155;">
                        <option value="">Todas las Áreas</option>
                        <!-- Dynamic options will be added here -->
                    </select>
                </div>
                <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <h3
                        style="margin: 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; font-weight: 700;">
                        Pacientes del Día</h3>
                </div>
                <div id="sidebarList" style="flex: 1; overflow-y: auto; padding: 0;">
                    <!-- Patient items -->
                    <div style="text-align: center; padding: 1rem; color: #94a3b8;">Cargando...</div>
                </div>
            </aside>

            <!-- Main Capture Area -->
            <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column;">

                <div style="margin-bottom: 1rem;">
                    <button onclick="window.location.href='dashboard.html'"
                        style="border: none; background: none; cursor: pointer; color: var(--secondary); display: flex; align-items: center; gap: 5px; font-size: 0.95rem; font-weight: 500; padding: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7" />
                        </svg>
                        Volver a Inicio
                    </button>
                </div>

                <div class="card" style="margin-bottom: 2rem; flex-shrink: 0;">
                    <div class="card-header" style="background: #f1f5f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div>
                                <h2 id="capturePatientName"
                                    style="color: var(--primary-dark); font-size: 1.5rem; margin-top: 0;">
                                    Cargando...
                                </h2>
                                <div
                                    style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.9rem; color: #000000; margin-top: 0.5rem; font-family: 'Consolas', monospace; font-weight: 500;">
                                    <span id="captureFolio"
                                        style="font-weight: 700; color: #000000; font-family: 'Consolas', monospace;">Folio:
                                        ---</span>
                                    <span id="captureLine1">EXP: --- FN: --- EDAD: ---</span>
                                    <span id="captureLine2">SEXO: --- TEL: ---</span>
                                </div>
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="saveCaptureResults()">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z">
                                        </path>
                                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                        <polyline points="7 3 7 8 15 8"></polyline>
                                    </svg>
                                    Guardar
                                </button>
                                <button class="btn btn-outline" id="btnCaptureInvalidate"
                                    onclick="invalidateCaptureResults()"
                                    style="display: none; border-color: #ef4444; color: #ef4444;">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                                        <line x1="12" y1="2" x2="12" y2="12"></line>
                                    </svg>
                                    Desvalidar
                                </button>
                                <button class="btn btn-success" id="btnCaptureValidate"
                                    onclick="validateCaptureResults()" style="display: none;">
                                    <svg viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    Validar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="captureTablesContainer" style="flex: 1;">
                    <!-- Tables will be injected here -->
                </div>
            </div>
        </div>

        </main>

        <!-- Supabase SDK -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
            const supabaseUrl = 'https://ebihobjrwcwtjfazcjmv.supabase.co';
            const supabaseKey = 'sb_publishable_31x2oYQjyxNJ2otN6TF-Kw_5VGXaGJd';
            const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

            let allCitas = [];
            let currentCaptureCita = null; // Cita activa en modo captura
            let currentProfileMap = {}; // Maps component_id -> profile_name
            let currentOrderMap = {}; // Maps component_id -> order
            let currentUser = null;

            document.addEventListener('DOMContentLoaded', async () => {
                checkAuth();

                // Check for ID in URL
                const urlParams = new URLSearchParams(window.location.search);
                const citaId = urlParams.get('id');

                // Set default date filter to today if empty (Local Time) - Handling both IDs
                const now = new Date();
                const localISO = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

                const fDate = document.getElementById('filterDate');
                if (fDate && !fDate.value) fDate.value = localISO;

                const sDate = document.getElementById('sidebarFilterDate');
                if (sDate && !sDate.value) sDate.value = localISO;

                // Always load the list (for sidebar or list view)
                await loadCitasConEstudios();

                if (citaId) {
                    // Single Patient Mode
                    document.querySelector('.filters-bar').style.display = 'none';
                    document.getElementById('resultsGrid').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('captureSection').style.display = 'block';

                    // Hide page title in capture mode to save space/reduce noise
                    document.querySelector('.page-header').style.display = 'none';

                    loadSingleCita(citaId);
                }
            });

            function checkAuth() {
                const userData = localStorage.getItem('arlab_user');
                if (!userData) {
                    // To avoid loops if stuck
                    // window.location.href = 'index.html';
                    return;
                }
                try {
                    currentUser = JSON.parse(userData);
                } catch (e) { currentUser = { usuario: 'User', rol: 'operador' }; }
            }

            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            // --- LIST MODE FUNCTIONS ---
            async function loadCitasConEstudios() {
                // (Same implementation as before but streamlined)
                try {
                    // Try sidebar date first, then main filter date
                    const filterDate = document.getElementById('sidebarFilterDate')?.value || document.getElementById('filterDate')?.value;
                    let query = supabaseClient.from('citas')
                        .select('*, citas_estudios(*, estudios_laboratorio(nombre, categoria, codigo))')
                        .in('estado', ['muestra_parcial', 'en_proceso', 'completada'])
                        .order('fecha_hora', { ascending: true });

                    if (filterDate) query = query.gte('fecha_hora', filterDate + 'T00:00:00').lte('fecha_hora', filterDate + 'T23:59:59');

                    const { data, error } = await query;
                    if (error) throw error;

                    allCitas = data.map(c => {
                        // Flatten data structure slightly for easier usage
                        c.citas_estudios = c.citas_estudios.map(ce => ({
                            ...ce,
                            estudio: ce.estudios_laboratorio || { nombre: 'Desc.' }
                        }));
                        return c;
                    });

                    filterResults(); // Updates the main grid if visible
                    renderSidebarList(allCitas); // Updates the sidebar if visible
                } catch (err) { console.error(err); }
            }

            function filterResults() {
                const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
                const statusFilter = document.getElementById('filterStatus').value;
                // ... (Logic similar to original)
                const filtered = allCitas.filter(c => {
                    const nameMatch = c.paciente_nombre.toLowerCase().includes(searchTerm);
                    // Simple Status Check
                    // If statusFilter is present, check if cita.estado matches roughly
                    // For now just pass all
                    return nameMatch;
                });
                renderResults(filtered);
            }

            function renderResults(citas) {
                const grid = document.getElementById('resultsGrid');
                if (!grid) return; // Guard
                if (citas.length === 0) { grid.innerHTML = ''; document.getElementById('emptyState').style.display = 'block'; return; }
                document.getElementById('emptyState').style.display = 'none';
                grid.innerHTML = citas.map(c => `
                <div class="result-card">
                    <div class="card-header">
                        <h3>${c.paciente_nombre}</h3>
                        <span class="folio-badge">#${c.folio_venta || c.folio_atencion || 'S/F'}</span>
                    </div>
                    <div class="card-body">
                         <span style="font-size:0.8rem; color:gray;">${new Date(c.fecha_hora).toLocaleDateString()}</span>
                         <p style="font-size:0.9rem;">${c.citas_estudios.length} Estudios</p>
                    </div>
                    <div class="card-footer">
                        <a href="resultados.html?id=${c.id}" class="btn btn-primary">Capturar</a>
                    </div>
                </div>
            `).join('');
            }

            function renderSidebarList(citas) {
                const sidebarList = document.getElementById('sidebarList');
                if (!sidebarList) return;

                const urlParams = new URLSearchParams(window.location.search);
                const currentId = urlParams.get('id');
                const selectedArea = document.getElementById('filterArea')?.value || '';

                // Extract all unique areas from current citas
                const areas = new Set();
                citas.forEach(c => {
                    c.citas_estudios.forEach(ce => {
                        const area = ce.estudios_laboratorio?.categoria || ce.estudios_laboratorio?.area;
                        if (area) areas.add(area);
                    });
                });

                // Populate Area Filter if empty
                const areaSelect = document.getElementById('filterArea');
                if (areaSelect && areaSelect.options.length <= 1) {
                    Array.from(areas).sort().forEach(area => {
                        const opt = document.createElement('option');
                        opt.value = area;
                        opt.textContent = area;
                        areaSelect.appendChild(opt);
                    });
                }


                // Filter citas based on selected area
                const filteredCitas = selectedArea
                    ? citas.filter(c => c.citas_estudios.some(ce => (ce.estudios_laboratorio?.categoria === selectedArea || ce.estudios_laboratorio?.area === selectedArea)))
                    : citas;

                sidebarList.innerHTML = filteredCitas.map((c, index) => {
                    const isActive = c.id == currentId;

                    // Check if all studies are completed (validado or entregado)
                    const studies = c.citas_estudios || [];
                    const hasStudies = studies.length > 0;
                    const allDone = hasStudies && studies.every(s => ['validado', 'entregado'].includes(s.estado_resultado));

                    const activeClass = isActive ? 'active' : '';

                    // Logic: Name is black normally, Green if validated.
                    const nameColor = allDone ? '#16a34a' : '#000000';
                    const nameWeight = allDone ? '700' : '400';

                    // Priority: folio_atencion > folio > Constructed (YYMMDD-XX)
                    let displayFolio = c.folio_atencion || c.folio;

                    // Fallback if missing or if it looks like a long UUID/Supabase ID
                    if (!displayFolio || displayFolio.toString().length > 12) {
                        try {
                            const dateObj = new Date(c.fecha_hora);
                            const yy = dateObj.getFullYear().toString().slice(-2);
                            const mm = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                            const dd = dateObj.getDate().toString().padStart(2, '0');
                            const idx = (index + 1).toString().padStart(2, '0');
                            displayFolio = `${yy}${mm}${dd}-${idx}`;
                        } catch (e) {
                            displayFolio = c.folio_venta || c.id;
                        }
                    }

                    return `
                    <div class="patient-card ${activeClass}" 
                         style="cursor: pointer; position: relative; padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; transition: all 0.2s;" 
                         onclick="selectPatient('${c.id}')"
                         title="${c.paciente_nombre}">
                        <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                            <div style="font-family: 'Consolas', monospace; font-weight: 700; color: #000; font-size: 0.85rem; white-space: nowrap;">
                                ${displayFolio}
                            </div>
                            <div style="font-size: 0.85rem; color: ${nameColor}; font-weight: ${nameWeight}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                                ${c.paciente_nombre}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // --- SINGLE CAPTURE MODE FUNCTIONS ---

            async function selectPatient(id) {
                console.log('Selecting Patient ID:', id);
                if (currentCaptureCita && currentCaptureCita.id == id) {
                    console.log('Patient already selected');
                    return;
                }

                // Update URL without reload
                const newUrl = `${window.location.pathname}?id=${id}`;
                window.history.pushState({ path: newUrl }, '', newUrl);

                // Show loading in capture area
                document.getElementById('capturePatientName').innerHTML = '<span style="color:#64748b; font-size:1.2rem;">Cargando...</span>';
                document.getElementById('captureTablesContainer').innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:200px;"><div style="width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #0d9488; border-radius:50%; animation:spin 1s linear infinite;"></div></div>';

                // Clear inputs
                document.getElementById('captureFolio').textContent = 'Folio: ---';
                document.getElementById('captureLine1').textContent = 'EXP: --- FN: --- EDAD: ---';
                document.getElementById('captureLine2').textContent = 'SEXO: --- TEL: ---';

                // Load data
                await loadSingleCita(id);
            }

            async function checkAndExpandProfiles(cita) {
                const profileStudies = cita.citas_estudios.filter(ce => ce.estudios_laboratorio && ce.estudios_laboratorio.es_perfil);
                if (profileStudies.length === 0) return false;

                // Get all profile IDs
                const profileIds = profileStudies.map(ce => ce.estudios_laboratorio.id);

                // Fetch components for these profiles
                const { data: components, error } = await supabaseClient
                    .from('estudio_componentes')
                    .select('perfil_id, componente_id')
                    .in('perfil_id', profileIds);

                if (error) {
                    console.error('Error fetching profile components', error);
                    return false;
                }

                if (!components || components.length === 0) return false;

                // Check which components are missing
                const existingEstudioIds = new Set(cita.citas_estudios.map(ce => ce.estudios_laboratorio.id));
                const toInsert = [];

                components.forEach(comp => {
                    if (!existingEstudioIds.has(comp.componente_id)) {
                        toInsert.push({
                            cita_id: cita.id,
                            estudio_id: comp.componente_id,
                            estado_resultado: 'pendiente' // Default status
                        });
                        // Add to set to prevent duplicates
                        existingEstudioIds.add(comp.componente_id);
                    }
                });

                if (toInsert.length > 0) {
                    console.log('Expanding profiles, inserting components:', toInsert.length);
                    const { error: insertError } = await supabaseClient
                        .from('citas_estudios')
                        .insert(toInsert);

                    if (insertError) {
                        console.error('Error expanding profiles:', insertError);
                        return false;
                    }
                    showToast('Expandiendo perfil...', 'info');
                    return true;
                }

                return false;
            }

            async function toggleReporte(id, checked) {
                try {
                    const { error } = await supabaseClient
                        .from('citas_estudios')
                        .update({ mostrar_en_reporte: checked })
                        .eq('id', id);

                    if (error) throw error;

                    // Simple visual feedback without full reload if possible, but opacity needs reload or DOM manipulation
                    // We can just update opacity here for speed
                    // Finding the row might be tricky without ID on TR, but we have input context usually.
                    // Let's just create a quick visual toggle for now
                    const input = document.querySelector(`input[onchange="toggleReporte('${id}', this.checked)"]`);
                    if (input) {
                        const cellName = input.parentElement.nextElementSibling;
                        if (cellName) cellName.style.opacity = checked ? '1' : '0.5';
                    }

                } catch (e) {
                    console.error(e);
                    showToast('Error al actualizar estado: ' + e.message, 'error');
                }
            }

            async function loadSingleCita(id) {
                try {
                    // Fetch full deep data for this cita
                    // We need estudios_laboratorio to group by categoria/perfil
                    // AND 'perfiles' if applicable (assuming flat structure for now or simple grouping)
                    const { data, error } = await supabaseClient
                        .from('citas')
                        .select(`
                        *,
                        citas_estudios (
                            *,
                            estudios_laboratorio (
                                id, nombre, codigo, categoria, area, rango_referencia, unidades, formula, es_perfil
                            )
                        )
                    `)
                        .eq('id', id)
                        .single();

                    if (error) throw error;
                    console.log('Datos cargados:', data); // Debug log
                    currentCaptureCita = data;

                    // Check for profile expansion
                    const expanded = await checkAndExpandProfiles(currentCaptureCita);
                    if (expanded) {
                        return loadSingleCita(id); // Reload to get new items
                    }

                    // --- FETCH PROFILE MAP ---
                    // Calculate mapping before rendering
                    currentProfileMap = {};
                    const profileStudies = currentCaptureCita.citas_estudios.filter(ce => ce.estudios_laboratorio?.es_perfil);
                    if (profileStudies.length > 0) {
                        const profileIds = profileStudies.map(ce => ce.estudios_laboratorio.id);
                        const { data: mapping } = await supabaseClient
                            .from('estudio_componentes')
                            .select('perfil_id, componente_id, orden')
                            .in('perfil_id', profileIds);

                        if (mapping) {
                            mapping.forEach(m => {
                                const profile = profileStudies.find(ps => ps.estudios_laboratorio.id === m.perfil_id);
                                if (profile) {
                                    currentProfileMap[m.componente_id] = profile.estudios_laboratorio.nombre;
                                    currentOrderMap[m.componente_id] = m.orden;
                                }
                            });
                        }
                    }

                    renderCaptureValues();

                    // Update sidebar highlight if list is loaded
                    renderSidebarList(allCitas);

                    // Initial calculation run
                    setTimeout(calculateFormulas, 500);

                } catch (err) {
                    console.error(err);
                    document.getElementById('captureTablesContainer').innerHTML = `<div style="color:red; text-align:center; padding:2rem;">Error al cargar datos: ${err.message}</div>`;
                }
            }

            function calculateSingleFormula(input) {
                const formula = input.dataset.formula;
                if (!formula) return;

                // 1. Map current values
                const valuesMap = {};
                document.querySelectorAll('.capture-input').forEach(i => {
                    const code = i.dataset.code;
                    if (code) {
                        const val = parseFloat(i.value);
                        if (!isNaN(val)) valuesMap[code.toUpperCase()] = val;
                    }
                });

                // 2. Evaluate
                try {
                    let expression = formula.toUpperCase();
                    for (const [code, val] of Object.entries(valuesMap)) {
                        expression = expression.split(`[${code}]`).join(val);
                    }

                    // Check if still has brackets (missing dependencies)
                    if (expression.includes('[')) {
                        const missing = expression.match(/\[(.*?)\]/g)?.map(s => s.replace(/[\[\]]/g, '')) || [];
                        const missingStr = missing.join(', ');
                        showToast(`Faltan datos para calcular: ${missingStr}`, 'warning');
                        return;
                    }

                    const newVal = eval(expression);
                    // Round to 2 decimals if necessary
                    const rounded = Math.round(newVal * 100) / 100;

                    input.value = rounded;
                    validateInputRange(input);
                    updateCellColor(input);

                    // Visual Feedback
                    const originalBg = input.parentElement.parentElement.style.backgroundColor;
                    input.parentElement.parentElement.style.backgroundColor = '#86efac'; // Flash Green
                    setTimeout(() => {
                        updateCellColor(input); // Restore normal color logic
                    }, 400);

                } catch (err) {
                    console.error('Error calculating single formula:', err);
                    showToast('Error en fórmula', 'error');
                }
            }

            function calculateFormulas() {
                const allInputs = document.querySelectorAll('.capture-input');
                const calculatedInputs = Array.from(allInputs).filter(i => i.dataset.formula && i.dataset.formula !== 'null');

                // Run multiple passes to resolve dependencies (A -> B -> C)
                // 3 passes is usually enough for lab formulas
                for (let pass = 0; pass < 3; pass++) {
                    let changes = 0;

                    // Create a map of Code -> Value (Snapshot for this pass)
                    const valuesMap = {};
                    allInputs.forEach(i => {
                        const code = i.dataset.code;
                        if (code) {
                            const val = parseFloat(i.value);
                            if (!isNaN(val)) {
                                valuesMap[code.toUpperCase()] = val;
                            }
                        }
                    });

                    calculatedInputs.forEach(input => {
                        let formula = input.dataset.formula; // e.g., "[UREA] / 2.14"

                        // Replace [CODE] with value
                        const matches = formula.match(/\[([a-zA-Z0-9_-]+)\]/g);

                        if (matches) {
                            let ready = true;
                            matches.forEach(match => {
                                const code = match.replace('[', '').replace(']', '').toUpperCase();
                                if (valuesMap[code] !== undefined) {
                                    formula = formula.replace(match, valuesMap[code]);
                                } else {
                                    ready = false;
                                }
                            });

                            if (ready) {
                                try {
                                    if (!/^[0-9+\-*/().\s]+$/.test(formula)) {
                                        return;
                                    }
                                    const result = eval(formula);
                                    const newVal = parseFloat(result.toFixed(2));

                                    // Only update and trigger if different to avoid potential loops (though fixed passes prevent infinite loops)
                                    if (parseFloat(input.value) !== newVal) {
                                        input.value = newVal;
                                        validateInputRange(input);
                                        changes++;
                                    }
                                } catch (e) {
                                    // console.error(e);
                                }
                            }
                        }
                    });

                    if (changes === 0) break; // Stabilized
                }
            }

            function getStatusBadge(status) {
                const statusColors = {
                    'pendiente': '#9ca3af', // Gray
                    'en-proceso': '#9ca3af', // Gray
                    'listo': '#9ca3af',      // Gray
                    'validado': '#10b981',   // Green
                    'entregado': '#6b7280'   // Dark Gray
                };
                // Fallback
                if (status === 'validado') statusColors['validado'] = '#10b981';

                const color = statusColors[status] || '#9ca3af';

                const labels = {
                    'pendiente': 'Sin Validar',
                    'en-proceso': 'Sin Validar',
                    'listo': 'Sin Validar',
                    'validado': 'Validado',
                    'entregado': 'Entregado'
                };
                const label = labels[status] || 'Sin Validar';

                // Add pulse if Sin Validar (gray) or Validado (green)
                const isPending = label === 'Sin Validar';
                const isValidated = label === 'Validado';

                let pulseClass = '';
                if (isPending) pulseClass = 'status-pulse';
                if (isValidated) pulseClass = 'status-pulse-green';

                return `
                <div title="${label}" class="${pulseClass}" style="
                    width: 16px; 
                    height: 16px; 
                    border-radius: 50%; 
                    background-color: ${color}; 
                    cursor: help;
                    margin-right: 4px;
                    ${(isPending || isValidated) ? '' : `box-shadow: 0 0 0 2px white, 0 0 0 3px ${color}20;`} 
                "></div>
                `;
            }

            function renderCaptureValues() {
                const c = currentCaptureCita;
                document.getElementById('capturePatientName').textContent = c.paciente_nombre;
                const folio = c.folio_atencion || c.folio_venta || 'S/N';
                document.getElementById('captureFolio').textContent = `Folio: ${folio}`;

                // --- LINE 1: EXP: 00022 FN: 16/02/1998 EDAD: 27 A ---
                const expediente = c.expediente_numero || 'S/N';

                let dobStr = 'N/A';
                let age = 'N/A';
                const dob = c.fecha_nacimiento;
                if (dob) {
                    const dobDate = new Date(dob);
                    dobStr = dobDate.toLocaleDateString('es-MX');

                    const diff = Date.now() - dobDate.getTime();
                    const ageDate = new Date(diff);
                    age = Math.abs(ageDate.getUTCFullYear() - 1970);
                }

                document.getElementById('captureLine1').textContent = `EXP: ${expediente} FN:${dobStr} EDAD:${age} A`;

                // --- LINE 2: SEXO: M TEL: 0961223 ---
                const sexRaw = c.paciente_sexo || '';
                const sexAbbr = sexRaw.toUpperCase().startsWith('M') ? 'M' : (sexRaw.toUpperCase().startsWith('F') ? 'F' : '?');
                const phone = c.paciente_telefono || 'S/N';

                document.getElementById('captureLine2').textContent = `SEXO: ${sexAbbr} TEL:${phone}`;



                // Uses global currentProfileMap calculated in loadSingleCita
                const groups = {};
                const noCategory = 'Sin Categoría';


                c.citas_estudios.forEach(ce => {
                    const est = ce.estudios_laboratorio || {};
                    const cat = est.categoria || est.area || noCategory;
                    if (!groups[cat]) groups[cat] = [];
                    // Merge order swapped: est (generic) first, then ce (specific) overrides
                    groups[cat].push({ ...est, ...ce });
                });

                const container = document.getElementById('captureTablesContainer');
                container.innerHTML = '';

                // Filter Visible Groups based on selection
                const selectedArea = document.getElementById('filterArea')?.value || '';

                // Excel-style Grid Layout
                Object.keys(groups).sort().forEach(cat => {
                    // Filter: If filtered and not match, skip
                    if (selectedArea && cat !== selectedArea) return;

                    // Filter out profile parents from rendering
                    const studies = groups[cat].filter(s => !s.estudios_laboratorio?.es_perfil);
                    if (studies.length === 0) return; // Skip empty groups after filter

                    // --- SUB-GROUP BY PROFILE ---
                    const subGroups = {}; // 'Individual' -> [], 'Perfil X' -> []

                    studies.forEach(s => {
                        const profileName = currentProfileMap[s.estudios_laboratorio.id] || 'Individual';
                        if (!subGroups[profileName]) subGroups[profileName] = [];
                        subGroups[profileName].push(s);
                    });

                    // Container for Group
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'card';
                    groupContainer.style.marginBottom = '1.5rem';
                    groupContainer.innerHTML = `
                        <div class="card-header" style="background: #e2e8f0; padding: 0.75rem 1rem; border-bottom: 1px solid #cbd5e1;">
                            <h3 style="margin: 0; font-size: 0.95rem; font-weight: 700; color: #334155; text-transform: uppercase;">${cat}</h3>
                        </div>
                    `;

                    // Sort keys: Profiles first, Individual last.
                    const subKeys = Object.keys(subGroups).sort((a, b) => {
                        if (a === 'Individual') return 1;
                        if (b === 'Individual') return -1;
                        return a.localeCompare(b);
                    });

                    subKeys.forEach(subKey => {
                        const items = subGroups[subKey];
                        const isProfile = subKey !== 'Individual';

                        // Sub-header if Profile
                        if (isProfile) {
                            const subHeader = document.createElement('div');
                            subHeader.style.cssText = 'background: #f8fafc; padding: 0.5rem 1rem; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 0.5rem;';
                            subHeader.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 21a4 4 0 0 1-4-4V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v12a4 4 0 0 1-4 4zm0 0h12a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3"></path></svg> ${subKey}`;
                            groupContainer.appendChild(subHeader);
                        }

                        const table = document.createElement('table');
                        table.className = 'w-full';
                        table.style.borderCollapse = 'collapse';
                        table.style.fontSize = '0.9rem';

                        table.innerHTML = `
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #c0c0c0; padding: 4px; text-align: center; width: 40px;" title="Incluir en Reporte">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </th>
                                <th style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: left; width: auto; color: #333; font-weight: 600;">${isProfile ? '' : 'ESTUDIO'}</th>
                                <th style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: left; width: 20%; color: #333; font-weight: 600;">RESULTADO</th>
                                <th style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; width: 10%; color: #333; font-weight: 600;">UNIDADES</th>
                                <th style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; width: 25%; color: #333; font-weight: 600;">VALORES DE REFERENCIA</th>
                                <th style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; width: 20%; color: #333; font-weight: 600;">ESTADO</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;

                        const tbody = table.querySelector('tbody');

                        // Sort items by order if available, otherwise by ID or Name stability
                        items.sort((a, b) => {
                            const oa = currentOrderMap[a.estudios_laboratorio.id] ?? 9999;
                            const ob = currentOrderMap[b.estudios_laboratorio.id] ?? 9999;
                            return oa - ob;
                        });

                        items.forEach(item => {
                            const row = document.createElement('tr');

                            // Determine Background Color
                            const isCalculated = !!(item.formula || item.estudios_laboratorio?.formula);
                            let initialBg = '#f1f5f9'; // Default Gray (Empty)
                            if (item.estado_resultado === 'validado') {
                                initialBg = '#dcfce7'; // Green (Validated)
                            } else if (item.valor_resultado !== null && item.valor_resultado !== '') {
                                initialBg = '#fef9c3'; // Yellow (Filled)
                            } else if (isCalculated) {
                                initialBg = '#eef2ff'; // Keep distinct for calculated if empty? Or just Gray. Let's use Gray to be consistent with "Empty".
                                // Actually, if calculated is empty it should be gray. If calculated has value (auto) it should be yellow/green.
                                if (item.valor_resultado) initialBg = '#fef9c3';
                            }

                            // Checkbox state (default true if undefined)
                            const showInReport = item.mostrar_en_reporte !== false;

                            // Referencia formatting
                            let refText = item.rango_referencia || item.estudios_laboratorio?.rango_referencia || '';

                            row.innerHTML = `
                            <td style="border: 1px solid #c0c0c0; padding: 0; vertical-align: middle; text-align: center; background: #fff;">
                                <input type="checkbox" 
                                    ${showInReport ? 'checked' : ''} 
                                    onchange="toggleReporte('${item.id}', this.checked)"
                                    style="cursor: pointer; width: 16px; height: 16px; accent-color: #0f766e;">
                            </td>
                            <td style="border: 1px solid #c0c0c0; padding: 4px 8px; vertical-align: middle; opacity: ${showInReport ? '1' : '0.5'};">
                                <div style="font-weight: 600; color: #000;">
                                    ${item.estudios_laboratorio?.nombre || item.nombre} 
                                    ${isCalculated ? `
                                        <span title="Fórmula: ${item.estudios_laboratorio?.formula || item.formula || 'Automática'}" 
                                              style="display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; color: #64748b; cursor: help; vertical-align: middle;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                                                <line x1="8" y1="6" x2="16" y2="6"></line>
                                                <line x1="16" y1="14" x2="16" y2="18"></line>
                                                <path d="M8 14h.01"></path>
                                                <path d="M12 14h.01"></path>
                                                <path d="M8 18h.01"></path>
                                                <path d="M12 18h.01"></path>
                                            </svg>
                                        </span>
                                    ` : ''}
                                </div>
                                <div id="note-display-${item.id}" style="font-size: 0.75rem; color: #0f766e; font-style: italic; margin-top: 2px; display: ${item.observaciones ? 'block' : 'none'};">
                                    ${item.observaciones ? 'Nota: ' + item.observaciones : ''}
                                </div>
                            </td>
                            <td style="border: 1px solid #c0c0c0; padding: 0; vertical-align: middle; background: ${initialBg}; transition: background 0.3s;" id="cell-bg-${item.id}">
                                <div style="display: flex; align-items: center; width: 100%; height: 100%;">
                                    <input type="text" class="capture-input"
                                        data-id="${item.id}"
                                        data-code="${item.estudios_laboratorio?.codigo || item.codigo || ''}"
                                        data-formula="${item.estudios_laboratorio?.formula || item.formula || ''}"
                                        data-status="${item.estado_resultado}"
                                        data-ref="${refText}"
                                        value="${item.valor_resultado || ''}"
                                        ${(isCalculated || item.estado_resultado === 'validado' || item.estado_resultado === 'entregado') ? 'readonly' : ''}
                                        oninput="validateInputRange(this); calculateFormulas(); updateCellColor(this);"
                                        onkeydown="
                                            if(event.key==='Enter' || event.key==='ArrowDown'){
                                                event.preventDefault(); 
                                                const inputs=[...document.querySelectorAll('.capture-input')]; 
                                                const idx=inputs.indexOf(this); 
                                                if(inputs[idx+1]) inputs[idx+1].focus();
                                            }
                                            if(event.key==='ArrowUp'){
                                                event.preventDefault(); 
                                                const inputs=[...document.querySelectorAll('.capture-input')]; 
                                                const idx=inputs.indexOf(this); 
                                                if(inputs[idx-1]) inputs[idx-1].focus();
                                            }
                                        "
                                        style="flex: 1; width: auto; height: 100%; border: none; padding: 6px 8px; font-family: inherit; font-size: inherit; font-weight: 400; color: #000; outline: none; background: transparent;"
                                    >
                                    <span class="range-indicator" style="padding: 0 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; min-width: 24px;"></span>
                                </div>
                            </td>
                            <td style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; vertical-align: middle; font-size: 0.85rem; color: #334155;">
                                ${item.unidades || ''}
                            </td>
                            <td style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; vertical-align: middle; font-size: 0.85rem; color: #334155;">
                                ${refText || '---'}
                            </td>
                            <td style="border: 1px solid #c0c0c0; padding: 4px 8px; text-align: center; vertical-align: middle;">
                                <div id="status-${item.id}" style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 700; font-size: 0.75rem;">
                                    ${getStatusBadge(item.estado_resultado)}
                                    <button class="btn-icon" style="width: 20px; height: 20px;" onclick="openNoteModal('${item.id}', '${(item.observaciones || '').replace(/'/g, "\\'")}')" title="Agregar Observación">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                </div>
                            </td>
                        `;
                            tbody.appendChild(row);

                            // Initial validation
                            validateInputRange(row.querySelector('input'));
                        });

                        groupContainer.appendChild(table);
                    });

                    container.appendChild(groupContainer);
                });



                // Check if user is admin to show validation button
                const canValidate = currentUser && (currentUser.rol === 'admin' || currentUser.rol === 'quimico');
                if (canValidate) {
                    document.getElementById('btnCaptureValidate').style.display = 'inline-flex';
                    // Show Invalidate button if there are validated items
                    const hasValidated = currentCaptureCita.citas_estudios.some(ce => ['validado', 'entregado'].includes(ce.estado_resultado));
                    if (hasValidated) {
                        document.getElementById('btnCaptureInvalidate').style.display = 'inline-flex';
                    } else {
                        document.getElementById('btnCaptureInvalidate').style.display = 'none';
                    }
                }
                // Trigger validation for existing values
                document.querySelectorAll('.capture-input').forEach(input => validateInputRange(input));
            }

            function validateInputRange(input) {
                const rawVal = input.value.trim();
                const ref = input.dataset.ref;
                const indicator = input.nextElementSibling;

                if (!indicator) return;

                // Reset styles
                indicator.textContent = '';
                input.style.color = '#000';

                if (!rawVal || !ref) return;

                // Check if input is a valid Number
                const val = parseFloat(rawVal);
                const isNum = !isNaN(val) && isFinite(rawVal); // Ensure it's not "12abc" treated as number partially, though parseFloat does that. 
                // Better check: /^-?\d*(\.\d+)?$/.test(rawVal) but simple isNaN(val) is usually enough for this context if we accept that "10 mg" might be text.
                // Actually, if user types "Negativo", isNaN is true.

                if (isNum) {
                    // --- NUMERIC LOGIC ---
                    // Matches "num - num"
                    const rangeMatch = ref.match(/([0-9.]+)\s*-\s*([0-9.]+)/);
                    if (rangeMatch) {
                        const min = parseFloat(rangeMatch[1]);
                        const max = parseFloat(rangeMatch[2]);

                        if (val < min) {
                            indicator.textContent = '↓'; // Down Arrow
                            indicator.style.color = '#2563eb'; // Blue
                            input.style.color = '#2563eb';
                        } else if (val > max) {
                            indicator.textContent = '↑'; // Up Arrow
                            indicator.style.color = '#dc2626'; // Red
                            input.style.color = '#dc2626';
                        }
                    }
                } else {
                    // --- TEXT LOGIC ---
                    // Compare text (case insensitive)
                    const normVal = rawVal.toLowerCase();
                    const normRef = ref.toLowerCase();

                    // Specific logic: If they don't match, warn.
                    // But Reference might be a range like "Negativo".
                    // If Reference is a number range "10-20" and user types "Error", it counts as mismatch? Yes.

                    // Simple logic: If reference is NOT a number range (approx check), treat as Text Reference.
                    const isRefRange = /([0-9.]+)\s*-\s*([0-9.]+)/.test(ref);

                    if (!isRefRange) {
                        if (normVal !== normRef) {
                            indicator.textContent = '*';
                            indicator.style.color = '#ea580c'; // Orange/Red for attention
                            indicator.title = 'El valor difiere de la referencia';
                        }
                    }
                }
            }

            function updateCellColor(input) {
                const cell = input.parentElement;
                const status = input.dataset.status;
                const val = input.value;

                if (status === 'validado') {
                    cell.style.background = '#dcfce7'; // Green
                } else if (val !== '') {
                    cell.style.background = '#fef9c3'; // Yellow
                } else {
                    cell.style.background = '#f1f5f9'; // Gray
                }
            }

            // Note Modal Functions
            // Note Modal Functions - Attached to window to ensure global scope access from HTML onclick
            window.openNoteModal = function (id, currentNote) {
                console.log('Opening note modal for:', id, currentNote);
                const modal = document.getElementById('noteModal');
                if (!modal) {
                    alert('Error: Modal element not found!');
                    return;
                }
                const parsedNote = (currentNote && currentNote !== 'null' && currentNote !== 'undefined') ? currentNote : '';

                document.getElementById('noteStudyId').value = id;
                document.getElementById('noteText').value = parsedNote;

                // Force display flex
                modal.style.display = 'flex';
                // Double check z-index via direct style
                modal.style.zIndex = '100000';

                setTimeout(() => document.getElementById('noteText').focus(), 100);
            };

            window.saveNoteModal = async function () {
                const id = document.getElementById('noteStudyId').value;
                const note = document.getElementById('noteText').value.trim();

                console.log('Saving note for:', id, note);

                // 1. Update In-Memory Data for UI consistency
                if (typeof currentCaptureCita !== 'undefined' && currentCaptureCita && currentCaptureCita.citas_estudios) {
                    const studyIndex = currentCaptureCita.citas_estudios.findIndex(ce => ce.id === id);
                    if (studyIndex > -1) {
                        currentCaptureCita.citas_estudios[studyIndex].observaciones = note;
                    }
                }

                // 2. UI Updates (Optimistic)
                const btn = document.querySelector(`.btn-note[data-id="${id}"]`); // Selector might need adjustment if class is not there, logic below uses dynamic selector based on onclick
                // Actually the current button doesn't have a class or data-id easy to grab, but we can refresh the row or just the display div.

                // Update text display in table
                const noteDisplay = document.getElementById('note-display-' + id);
                if (noteDisplay) {
                    noteDisplay.textContent = note ? 'Nota: ' + note : '';
                    noteDisplay.style.display = note ? 'block' : 'none';
                }

                document.getElementById('noteModal').style.display = 'none';

                // 3. Persist to Database Immediately
                try {
                    const { error } = await supabaseClient
                        .from('citas_estudios')
                        .update({ observaciones: note || null }) // Send null if empty to clean up
                        .eq('id', id);

                    if (error) throw error;
                    showToast('Nota guardada correctamente', 'success');
                } catch (e) {
                    console.error('Error saving note:', e);
                    showToast('Error al guardar nota en BD', 'error');
                    // Revert UI if needed? For now just alert.
                }
            };

            async function saveCaptureResults() {
                if (!currentCaptureCita) return;
                const inputs = document.querySelectorAll('.capture-input');
                const statuses = document.querySelectorAll('.capture-status');

                const updates = [];

                // Collect results
                inputs.forEach(input => {
                    const id = input.dataset.id;
                    const val = input.value;
                    const study = currentCaptureCita.citas_estudios.find(s => s.id === id);

                    // Determine status automatically
                    // If validated, keep validated. 
                    // Else if value is present, set to 'listo'. 
                    // Else set to 'pendiente' (or keep current if special)
                    let newStatus = study.estado_resultado;
                    if (newStatus !== 'validado') {
                        newStatus = val ? 'listo' : 'pendiente';
                    }

                    if (study) {
                        updates.push(
                            supabaseClient
                                .from('citas_estudios')
                                .update({
                                    valor_resultado: val,
                                    estado_resultado: newStatus,
                                    observaciones: study.observaciones || null
                                })
                                .eq('id', id)
                        );
                    }
                });

                try {
                    await Promise.all(updates);
                    showToast('Resultados guardados exitosamente', 'success');
                    // Refresh to show updated statuses/colors, waiting for it to complete so validation sees new state
                    await loadSingleCita(currentCaptureCita.id);
                } catch (e) {
                    console.error(e);
                    showToast('Error al guardar: ' + e.message, 'error');
                }
            }

            async function validateCaptureResults() {
                // Auto-save before validation to ensure statuses are updated
                await saveCaptureResults();

                // Check if there are items to validate
                const toValidateCount = currentCaptureCita.citas_estudios.filter(ce => ce.estado_resultado === 'listo').length;

                if (toValidateCount === 0) {
                    showToast('No hay resultados en estado "Listo" para validar.', 'info');
                    return;
                }

                // Open Custom Modal
                const modal = document.getElementById('validationConfirmModal');
                const title = modal.querySelector('h3');
                const text = document.getElementById('valConfirmText');
                const btnAction = modal.querySelector('.btn-primary');

                title.textContent = 'Confirmar Validación';
                title.style.color = '#1e293b';
                text.textContent = `¿Desea validar y firmar ${toValidateCount} resultado(s) que están en estado "Listo"?`;

                btnAction.textContent = 'Validar';
                btnAction.style.background = '#6366f1';
                btnAction.style.borderColor = '#6366f1';
                btnAction.onclick = proceedValidation;

                modal.style.display = 'flex';
            }

            function invalidateCaptureResults() {
                // Check if there are items to invalidate (validado or entregado)
                const toInvalidateCount = currentCaptureCita.citas_estudios.filter(ce => ['validado', 'entregado'].includes(ce.estado_resultado)).length;

                if (toInvalidateCount === 0) {
                    showToast('No hay resultados validados para revertir.', 'info');
                    return;
                }

                // Reuse modal or create new confirmation
                // We'll use the same modal structure but change text and action
                const modal = document.getElementById('validationConfirmModal');
                const title = modal.querySelector('h3');
                const text = document.getElementById('valConfirmText');
                const btnAction = modal.querySelector('.btn-primary'); // The confirm button

                title.textContent = 'Confirmar Desvalidación';
                title.style.color = '#ef4444';
                text.textContent = `¿Desea revertir ${toInvalidateCount} resultado(s) al estado "Listo"? Se habilitará la edición nuevamente.`;

                // Update button style/action
                btnAction.textContent = 'Desvalidar';
                btnAction.style.background = '#ef4444';
                btnAction.style.borderColor = '#ef4444';
                btnAction.onclick = proceedInvalidation;

                modal.style.display = 'flex';
            }

            async function proceedInvalidation() {
                document.getElementById('validationConfirmModal').style.display = 'none';

                // Restore modal defaults for next time (in case validated uses it)
                // Actually, validateCaptureResults sets its own text, so just ensure onclick is reset if needed or set explicitly there.
                // It's better to explicitly set onclick in validateCaptureResults too.

                const toInvalidate = currentCaptureCita.citas_estudios
                    .filter(ce => ['validado', 'entregado'].includes(ce.estado_resultado))
                    .map(ce => ce.id);

                if (toInvalidate.length === 0) return;

                try {
                    const { error } = await supabaseClient
                        .from('citas_estudios')
                        .update({
                            estado_resultado: 'pendiente', // User requested return to 'pendiente'
                            validado_por: null,
                            fecha_validacion: null
                        })
                        .in('id', toInvalidate);

                    if (error) throw error;
                    showToast(`${toInvalidate.length} resultados desvalidados (pendientes).`, 'success');
                    await loadSingleCita(currentCaptureCita.id);
                } catch (e) {
                    console.error(e);
                    showToast('Error desvalidando: ' + e.message, 'error');
                }
            }

            async function proceedValidation() {
                document.getElementById('validationConfirmModal').style.display = 'none';

                // Find eligible items
                const toValidate = [];
                currentCaptureCita.citas_estudios.forEach(ce => {
                    if (ce.estado_resultado === 'listo') {
                        toValidate.push(ce.id);
                    }
                });

                if (toValidate.length === 0) {
                    showToast('No hay resultados en estado "Listo" para validar.', 'info');
                    return;
                }

                try {
                    const { error } = await supabaseClient
                        .from('citas_estudios')
                        .update({
                            estado_resultado: 'validado',
                            validado_por: currentUser.usuario || 'Admin',
                            fecha_validacion: new Date().toISOString()
                        })
                        .in('id', toValidate);

                    if (error) throw error;
                    showToast(`${toValidate.length} resultados validados.`, 'success');
                    await loadSingleCita(currentCaptureCita.id);
                } catch (e) {
                    console.error(e);
                    showToast('Error validando: ' + e.message, 'error');
                }
            }

        </script>
        <!-- Note Modal -->
        <div id="noteModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100000; justify-content: center; align-items: center;">
            <div
                style="background: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0; color: #0f766e;">Nota del Analito</h3>
                <input type="hidden" id="noteStudyId">
                <textarea id="noteText" rows="4"
                    style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0.5rem; margin: 1rem 0; font-family: sans-serif;"
                    placeholder="Escriba una observación..."></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button onclick="document.getElementById('noteModal').style.display='none'"
                        class="btn btn-outline">Cancelar</button>
                    <button onclick="saveNoteModal()" class="btn btn-primary">Guardar Nota</button>
                </div>
            </div>
        </div>
        <div id="validationConfirmModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100000; justify-content: center; align-items: center;">
            <div
                style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;">
                <div style="color: #6366f1; margin-bottom: 1rem;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <h3 style="margin: 0 0 0.5rem 0; color: #1e293b; font-size: 1.25rem;">Confirmar Validación</h3>
                <p id="valConfirmText" style="color: #64748b; margin-bottom: 1.5rem; line-height: 1.5;">¿Estás seguro?
                </p>
                <div style="display: flex; justify-content: center; gap: 1rem;">
                    <button onclick="document.getElementById('validationConfirmModal').style.display='none'"
                        class="btn btn-outline" style="min-width: 100px;">Cancelar</button>
                    <button onclick="proceedValidation()" class="btn btn-primary"
                        style="background: #6366f1; border-color: #6366f1; min-width: 100px;">Validar</button>
                </div>
            </div>
        </div>
</body>

</html>