<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ar Lab - Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700&family=Roboto:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <script src="navbar.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-bar">
            <h1 class="page-title" id="pageTitle">Inicio</h1>
            <div class="top-bar-actions">
                <button class="btn btn-secondary" onclick="window.location.href='nueva_cita.html?mode=directo'"
                    style="background: white; color: var(--primary-dark); border: 1px solid var(--primary);">
                    <svg viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <line x1="19" y1="8" x2="19" y2="14"></line>
                        <line x1="16" y1="11" x2="22" y2="11"></line>
                    </svg>
                    Registrar Paciente
                </button>
                <button class="btn btn-primary" onclick="window.location.href='nueva_cita.html'">
                    <svg viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Nueva Cita
                </button>
            </div>
        </header>

        <div class="content-area">
            <!-- VISTA INICIO -->
            <div id="viewInicio">
                <div class="home-grid">
                    <!-- Widget Control de Caja -->
                    <div class="widget-caja" id="widgetCaja" style="display:none;">
                        <div class="caja-status">
                            <div class="status-icon" id="cajaStatusIcon">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" fill="none"
                                    stroke-width="2">
                                    <rect x="2" y="4" width="20" height="16" rx="2" />
                                    <path d="M12 12v4M10 14h4" />
                                </svg>
                            </div>
                            <div class="caja-info">
                                <h2 id="cajaStatusText">Caja Cerrada</h2>
                                <p id="cajaStatusSub">GestiÃ³n de Efectivo</p>
                                <div class="caja-balance" id="cajaBalance">$0.00</div>
                            </div>
                        </div>
                        <button class="btn" id="btnCajaAction" onclick="abrirCajaModal()">Abrir Caja</button>
                    </div>

                    <!-- Stats Widgets -->
                    <div class="widget-stat">
                        <div class="widget-stat-icon"><svg viewBox="0 0 24 24" width="24" height="24"
                                stroke="currentColor" fill="none" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <line x1="19" y1="8" x2="19" y2="14"></line>
                                <line x1="19" y1="11" x2="22" y2="11"></line>
                            </svg></div>
                        <div class="widget-stat-value" id="homeCitasHoy">0</div>
                        <div class="widget-stat-label">Citas de Hoy</div>
                    </div>
                    <!-- <div class="widget-stat">
                    <div class="widget-stat-icon"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                    <div class="widget-stat-value" id="homePacientesNuevos">0</div>
                    <div class="widget-stat-label">Pacientes Nuevos</div>
                </div> -->
                    <div class="widget-stat">
                        <div class="widget-stat-icon"><svg viewBox="0 0 24 24" width="24" height="24"
                                stroke="currentColor" fill="none" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg></div>
                        <div class="widget-stat-value" id="homeVentasHoy">$0.00</div>
                        <div class="widget-stat-label">Ventas Hoy</div>
                    </div>
                    <div class="widget-stat">
                        <div class="widget-stat-icon"><svg viewBox="0 0 24 24" width="24" height="24"
                                stroke="currentColor" fill="none" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg></div>
                        <div class="widget-stat-value" id="homePendientes">0</div>
                        <div class="widget-stat-label">Resultados Pendientes</div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="nueva_cita.html" class="action-card">
                            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                <line x1="12" y1="14" x2="12" y2="18"></line>
                                <line x1="10" y1="16" x2="14" y2="16"></line>
                            </svg>
                            <h3>Nueva Cita</h3>
                        </a>
                        <a href="nueva_cita.html?mode=directo" class="action-card">
                            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <line x1="19" y1="8" x2="19" y2="14"></line>
                                <line x1="16" y1="11" x2="22" y2="11"></line>
                            </svg>
                            <h3>Registrar Paciente</h3>
                        </a>
                        <a href="#" class="action-card" onclick="alert('MÃ³dulo en desarrollo')">
                            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <h3>Entrega Resultados</h3>
                        </a>
                    </div>
                </div>
            </div>

            <!-- VISTA LISTA DE PACIENTES DEL DÍA (SALA DE ESPERA) -->
            <div id="viewAnalitica" style="display:none;">
                <div class="card" style="width: 100%; overflow: hidden; margin-bottom: 2rem;">
                    <!-- Header simplificado -->
                    <div
                        style="padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <!-- Buscador -->
                        <div style="flex: 1; max-width: 400px;">
                            <div style="position: relative;">
                                <svg viewBox="0 0 24 24" width="18" height="18" stroke="#94a3b8" fill="none"
                                    stroke-width="2"
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                                <input type="text" id="searchSalaEspera" placeholder="Buscar paciente..."
                                    oninput="filterSalaEspera(this.value)"
                                    style="width: 100%; padding: 0.6rem 0.75rem 0.6rem 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;"
                                    onfocus="this.style.borderColor='#0d9488'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                        </div>

                        <!-- Centro: Contador -->
                        <div style="text-align: center;">
                            <span id="workListCount"
                                style="font-size: 1.75rem; font-weight: 700; color: #0f766e;">0</span>
                            <span style="font-size: 0.75rem; display: block; color: #64748b;">En Espera</span>
                        </div>

                        <!-- Derecha: Fecha y Actualizar -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="date" id="workListDate" class="form-input"
                                style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.85rem; color: #334155;"
                                onchange="loadWorkList()">
                            <button onclick="loadWorkList()" title="Actualizar lista"
                                style="background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" width="18" height="18" stroke="#64748b" fill="none"
                                    stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"></path>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="appointments-table">
                            <thead>
                                <!-- Fila de leyenda del semáforo -->
                                <tr style="background: transparent;">
                                    <th colspan="3" style="border: none; background: transparent;"></th>
                                    <th colspan="2"
                                        style="border: none; background: transparent; padding: 0.4rem 0.5rem;">
                                        <div
                                            style="display: flex; align-items: center; gap: 1rem; font-size: 0.7rem; font-weight: 500; color: #64748b;">
                                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                                <span
                                                    style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></span>
                                                <span>Tomada</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                                <span
                                                    style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span>
                                                <span>Llamado</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                                <span
                                                    style="width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1;"></span>
                                                <span>Pendiente</span>
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                                <!-- Encabezados de columnas -->
                                <tr>
                                    <th style="width: 10%;">Folio</th>
                                    <th style="width: 20%;">Paciente</th>
                                    <th style="width: 42%;">Estudios</th>
                                    <th style="width: 8%;">Estado</th>
                                    <th style="width: 20%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="workListTableBody"></tbody>
                        </table>
                        <div id="noWorkListMessage" class="empty-state" style="display: none; padding: 4rem 2rem;">
                            <div
                                style="background: #f1f5f9; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                                <svg viewBox="0 0 24 24"
                                    style="width: 40px; height: 40px; color: #94a3b8; stroke: currentColor; fill: none; stroke-width: 2;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            </div>
                            <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 0.5rem;">Sala de Espera Vacía
                            </h3>
                            <p style="font-size: 0.9rem; color: #64748b;">No hay pacientes verificados esperando turno.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA FASE ANALITICA -->
            <div id="viewProcesoAnalitico" style="display:none;">
                <div class="card" style="width: 100%; overflow: hidden;">
                    <!-- Header simplificado -->
                    <div
                        style="padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                        <!-- Buscador -->
                        <div style="flex: 1; max-width: 300px;">
                            <div style="position: relative;">
                                <svg viewBox="0 0 24 24" width="16" height="16" stroke="#94a3b8" fill="none"
                                    stroke-width="2"
                                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%);">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                                <input type="text" id="searchAnalitica" placeholder="Buscar paciente..."
                                    oninput="filterAnalitica(this.value)"
                                    style="width: 100%; padding: 0.5rem 0.5rem 0.5rem 2.25rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; outline: none;"
                                    onfocus="this.style.borderColor='#3b82f6'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                        </div>

                        <!-- Select de Área -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-size: 0.8rem; color: #64748b; font-weight: 500;">Área:</label>
                            <select id="selectCategoria" onchange="filterByCategory(this.value)"
                                style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; color: #334155; background: white; min-width: 180px; cursor: pointer;">
                                <option value="all">Todas las áreas</option>
                                <!-- Opciones se llenan dinámicamente -->
                            </select>
                        </div>

                        <!-- Leyenda del Semáforo -->
                        <div
                            style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.7rem; color: #64748b;">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                                <span>Pend.</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: #f97316;"></span>
                                <span>Tomado</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: #eab308;"></span>
                                <span>En área</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                                <span>Liberada</span>
                            </div>
                        </div>

                        <!-- Contador y Fecha -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="text-align: center;">
                                <span id="analiticaCount"
                                    style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">0</span>
                                <span style="font-size: 0.65rem; display: block; color: #64748b;">Pacientes</span>
                            </div>
                            <input type="date" id="analiticaDate" class="form-input"
                                style="padding: 0.4rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; color: #334155;"
                                onchange="loadFaseAnalitica()">
                            <button onclick="loadFaseAnalitica()" title="Actualizar"
                                style="background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.4rem; cursor: pointer; display: flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" stroke="#64748b" fill="none"
                                    stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"></path>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Procesamiento -->
                    <div style="overflow-x: auto;">
                        <table class="appointments-table" id="analiticaTable">
                            <thead>
                                <tr>
                                    <th style="width: 8%;">Folio</th>
                                    <th style="width: 22%;">Paciente</th>
                                    <th style="width: 55%;">Áreas</th>
                                    <th style="width: 15%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="analiticaTableBody">
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mensaje vacío -->
                    <div id="analiticaEmpty" style="display: none; text-align: center; padding: 3rem; color: #64748b;">
                        <svg viewBox="0 0 24 24" width="48" height="48" stroke="#cbd5e1" fill="none" stroke-width="1.5"
                            style="margin: 0 auto 1rem;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 15h8M9 9h.01M15 9h.01"></path>
                        </svg>
                        <p>No hay muestras para procesar</p>
                    </div>
                </div>
            </div>

            <!-- VISTA GESTION CITAS -->
            <div id="viewCitas" style="display:none;">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <svg viewBox="0 0 24 24">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="statToday">0</h3>
                            <p>Citas Hoy</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPending">0</h3>
                            <p>Pendientes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <svg viewBox="0 0 24 24">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="statCompleted">0</h3>
                            <p>Completadas</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="statCancelled">0</h3>
                            <p>Canceladas</p>
                        </div>
                    </div>
                </div>

                <!-- Calendar and Appointments - Clean Layout -->
                <!-- Calendar and Appointments - Clean Layout -->
                <!-- HEADER DE CONTROLES Y FECHA -->
                <div class="appointments-controls"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background: var(--primary-light); color: var(--primary-dark); padding: 0.5rem; border-radius: 8px;">
                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" fill="none"
                                stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div>
                            <h2 id="currentDateDisplay"
                                style="font-size: 1.25rem; font-weight: 700; color: var(--text-dark); margin: 0;">Citas
                                de
                                Hoy</h2>
                            <p style="font-size: 0.85rem; color: var(--text-light); margin: 0;">Mostrando agenda
                                seleccionada</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="openCalendarModal()">
                        <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none"
                            stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Cambiar Fecha
                    </button>
                </div>

                <!-- FULL WIDTH TABLE -->
                <div class="card" style="width: 100%; overflow: hidden; margin-bottom: 2rem;">
                    <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid var(--border);">
                        <h2 class="card-title" style="color: #0d9488;">Listado de Pacientes</h2>
                        <div style="font-size: 0.85rem; color: #64748b;">
                            Total: <span id="totalCitasDia">0</span> citas
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="appointments-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Hora</th>
                                    <th style="width: 30%;">Paciente</th>
                                    <th style="width: 25%;">Estudios</th>
                                    <th style="width: 15%;">Estado</th>
                                    <th style="width: 15%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody"></tbody>
                        </table>
                        <div id="noAppointmentsMessage" class="empty-state" style="display: none; padding: 4rem 2rem;">
                            <div
                                style="background: #f1f5f9; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                                <svg viewBox="0 0 24 24"
                                    style="width: 40px; height: 40px; color: #94a3b8; stroke: currentColor; fill: none; stroke-width: 2;">
                                    <path
                                        d="M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H5V8h14v10z" />
                                </svg>
                            </div>
                            <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 0.5rem;">Sin citas registradas
                            </h3>
                            <p style="font-size: 0.9rem; color: #64748b;">No hay pacientes citados para la fecha
                                seleccionada.</p>
                            <button class="btn btn-primary" onclick="window.location.href='nueva_cita.html'"
                                style="margin-top: 1.5rem;">
                                Agendar Nueva Cita
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MODAL CALENDARIO -->
                <div id="modalCalendar" class="modal-overlay">
                    <div class="modal" style="max-width: 400px; border-radius: 20px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Seleccionar Fecha</h3>
                            <button class="modal-close" onclick="closeCalendarModal()">
                                <svg viewBox="0 0 24 24">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: 0;">
                            <!-- Calendar Component Inside Modal -->
                            <div class="card calendar-card" style="box-shadow: none; border: none;">
                                <div class="card-header">
                                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                                        <svg viewBox="0 0 24 24">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </button>
                                    <h2 class="card-title" id="calendarMonth" style="font-size: 1rem;">Enero 2026</h2>
                                    <button class="calendar-nav-btn" onclick="changeMonth(1)">
                                        <svg viewBox="0 0 24 24">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                <div class="calendar-grid">
                                    <div class="calendar-header">
                                        <span>D</span><span>L</span><span>M</span><span>X</span><span>J</span><span>V</span><span>S</span>
                                    </div>
                                    <div class="calendar-days" id="calendarDays"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- ========== VISTA COTIZACIONES ========== -->
            <div id="viewCotizaciones" style="display:none;">
                <!-- Tabs -->
                <div style="display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0;">
                    <button id="tabCotNuevo" onclick="switchCotizacionTab('nuevo')" class="active"
                        style="padding: 1rem 2rem; border: none; background: transparent; font-weight: 600; font-size: 0.95rem; cursor: pointer; border-bottom: 3px solid #0f766e; color: #0f766e; margin-bottom: -2px;">
                        Nueva Cotización
                    </button>
                    <button id="tabCotHistorial" onclick="switchCotizacionTab('historial')"
                        style="padding: 1rem 2rem; border: none; background: transparent; font-weight: 600; font-size: 0.95rem; cursor: pointer; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px;">
                        Historial
                    </button>
                </div>

                <!-- Tab: Nueva Cotización -->
                <div id="cotizadorNuevo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Panel Izquierdo -->
                    <div class="card" style="padding: 1.5rem;">
                        <h3 style="font-size: 1.1rem; color: #0f766e; margin-bottom: 1.5rem;">Datos del Cliente</h3>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label">Nombre del Cliente</label>
                            <input type="text" id="cotPaciente" class="form-input" placeholder="Ej: María García López">
                        </div>
                        <h3 style="font-size: 1.1rem; color: #0f766e; margin-bottom: 1rem;">Buscar Estudios</h3>
                        <div style="position: relative;">
                            <input type="text" id="cotBuscarEstudio" class="form-input"
                                placeholder="Escriba para buscar...">
                            <div id="cotResultadosBusqueda"
                                style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 10px; max-height: 300px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                            </div>
                        </div>
                    </div>
                    <!-- Panel Derecho -->
                    <div class="card" style="padding: 1.5rem; display: flex; flex-direction: column;">
                        <h3 style="font-size: 1.1rem; color: #0f766e; margin-bottom: 1rem;">Estudios a Cotizar <span
                                id="cotTotalCount"
                                style="background: #0d9488; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem;">0</span>
                        </h3>
                        <div
                            style="flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid #e2e8f0; border-radius: 10px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px; text-align: left;">Código</th>
                                        <th style="padding: 12px;">Estudio</th>
                                        <th style="padding: 12px; text-align: right;">Precio</th>
                                        <th style="padding: 12px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="cotTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align:center; padding: 2rem; color: #94a3b8;">
                                            Agregue estudios</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div
                            style="margin-top: 1.5rem; background: linear-gradient(135deg, #0d9488, #0f766e); padding: 1.25rem; border-radius: 12px; color: white; text-align: center;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">TOTAL COTIZADO</div>
                            <div style="font-size: 2.5rem; font-weight: 700;">$<span id="cotTotalAmount">0.00</span>
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Válido por 15 días</div>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button onclick="limpiarCotizador()" class="btn btn-secondary"
                                style="flex: 1; justify-content: center;">Limpiar</button>
                            <button onclick="generarCotizacion()" class="btn btn-primary"
                                style="flex: 2; justify-content: center; background: #0d9488;">Generar
                                Cotización</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Historial -->
                <div id="cotizadorHistorial" style="display: none;">
                    <div class="card" style="padding: 1.5rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; color: #0f172a; margin: 0;">Cotizaciones Generadas</h3>
                            <input type="text" id="searchCotHistorial" class="form-input" placeholder="Buscar..."
                                oninput="filterCotizacionesHistory()" style="width: 300px;">
                        </div>
                        <div style="overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 10px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px;">Fecha</th>
                                        <th style="padding: 12px;">Cliente</th>
                                        <th style="padding: 12px;">Estudios</th>
                                        <th style="padding: 12px;">Total</th>
                                        <th style="padding: 12px;">Estado</th>
                                        <th style="padding: 12px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cotHistorialTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align:center; padding: 2rem; color: #94a3b8;">
                                            Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- New Appointment Modal -->
        <!-- Modal moved to nueva_cita.html -->
        <div class="modal-overlay-deprecated" id="appointmentModal_deprecated" style="display:none;">
            <div class="modal" style="max-width: 900px; width: 95%;">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Nueva Cita de Laboratorio</h3>
                    <button class="modal-close" onclick="closeModal()">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <form id="appointmentForm" onsubmit="saveAppointment(event)">
                    <div class="modal-body">
                        <!-- SecciÃ³n: Datos del Paciente -->
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; margin-bottom: 1.25rem;">
                            <h4
                                style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                Datos del Paciente</h4>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Primer Nombre *</label>
                                    <input type="text" class="form-input" id="primerNombre" required
                                        placeholder="Ej: Juan">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Segundo Nombre</label>
                                    <input type="text" class="form-input" id="segundoNombre" placeholder="Ej: Carlos">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Primer Apellido *</label>
                                    <input type="text" class="form-input" id="primerApellido" required
                                        placeholder="Ej: GarcÃ­a">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Segundo Apellido</label>
                                    <input type="text" class="form-input" id="segundoApellido" placeholder="Ej: LÃ³pez">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Fecha de Nacimiento *</label>
                                    <input type="date" class="form-input" id="fechaNacimiento" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sexo *</label>
                                    <select class="form-input" id="pacienteSexo" required>
                                        <option value="" disabled selected>Seleccione...</option>
                                        <option value="masculino">MASCULINO</option>
                                        <option value="femenino">FEMENINO</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Teléfono *</label>
                                    <input type="tel" class="form-input" id="patientPhone" required
                                        placeholder="10 dígitos">
                                </div>
                            </div>
                        </div>

                        <!-- SecciÃ³n: Datos de la Cita -->
                        <div style="background: #f0fdfa; padding: 1rem; border-radius: 12px; margin-bottom: 1.25rem;">
                            <h4
                                style="font-size: 0.85rem; color: #0d9488; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                Datos de la Cita</h4>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Fecha de Cita *</label>
                                    <input type="date" class="form-input" id="appointmentDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora *</label>
                                    <input type="time" class="form-input" id="appointmentTime" required value="08:00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">DiagnÃ³stico / Motivo de Consulta</label>
                                <input type="text" class="form-input" id="diagnostico"
                                    placeholder="Ej: Chequeo general, Control de glucosa...">
                            </div>
                        </div>

                        <!-- SecciÃ³n: Estudios de Laboratorio -->
                        <div style="background: #eff6ff; padding: 1rem; border-radius: 12px; margin-bottom: 1.25rem;">
                            <h4
                                style="font-size: 0.85rem; color: #2563eb; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                Estudios Solicitados</h4>

                            <div class="form-group">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <input type="text" class="form-input" id="buscarEstudio"
                                        placeholder="Buscar estudio..." style="flex: 1;">
                                    <select class="form-select" id="filtroCategoria" style="width: 180px;">
                                        <option value="">Todas las categorÃ­as</option>
                                    </select>
                                </div>
                                <div id="listaEstudios"
                                    style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; background: white;">
                                    <!-- Estudios se cargan dinÃ¡micamente -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Estudios Seleccionados:</label>
                                <div id="estudiosSeleccionados"
                                    style="display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 40px; padding: 0.5rem; background: white; border-radius: 10px; border: 1px solid #e2e8f0;">
                                    <span style="color: #94a3b8; font-size: 0.85rem;">NingÃºn estudio
                                        seleccionado</span>
                                </div>
                            </div>
                        </div>

                        <!-- SecciÃ³n: MÃ©dico Referente -->
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 12px; margin-bottom: 1.25rem;">
                            <h4
                                style="font-size: 0.85rem; color: #d97706; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                MÃ©dico Referente</h4>

                            <div class="form-group">
                                <label class="form-label">Buscar o agregar mÃ©dico</label>
                                <input type="text" class="form-input" id="medicoReferente"
                                    placeholder="Nombre del mÃ©dico que refiere al paciente..." list="listaMedicos">
                                <datalist id="listaMedicos">
                                    <!-- MÃ©dicos se cargan dinÃ¡micamente -->
                                </datalist>
                                <small style="color: #64748b; font-size: 0.75rem;">Escribe el nombre del mÃ©dico. Si es
                                    nuevo, se agregarÃ¡ al catÃ¡logo.</small>
                            </div>
                        </div>

                        <!-- SecciÃ³n: Caja / Pago -->
                        <div
                            style="background: #2dd4bf; background: linear-gradient(135deg, #ccfbf1 0%, #a5f3fc 100%); padding: 1.25rem; border-radius: 12px; margin-bottom: 1.25rem; border: 1px solid #99f6e4;">
                            <h4
                                style="font-size: 0.9rem; color: #0f766e; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <svg viewBox="0 0 24 24"
                                    style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                                    <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                    <line x1="2" y1="10" x2="22" y2="10"></line>
                                </svg>
                                Caja y FacturaciÃ³n
                            </h4>

                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <!-- Totales -->
                                <div
                                    style="display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 1rem; border-bottom: 1px dashed #0d9488;">
                                    <div>
                                        <div style="font-size: 0.85rem; color: #0f766e;">Total Estimado:</div>
                                        <div style="font-size: 2rem; font-weight: 700; color: #0f766e; line-height: 1;">
                                            $<span id="totalVenta">0.00</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.8rem; color: #0d9488;">Estudios: <span
                                                id="cantidadEstudiosVenta">0</span></div>
                                    </div>
                                </div>

                                <!-- Pago -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">MÃ©todo de Pago</label>
                                        <select class="form-select" id="metodoPago">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta de CrÃ©dito/DÃ©bito</option>
                                            <option value="transferencia">Transferencia</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Monto Recibido ($)</label>
                                        <input type="number" class="form-input" id="montoPagado" placeholder="0.00"
                                            step="0.50" oninput="calcularCambio()">
                                    </div>
                                </div>

                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.6); padding: 0.75rem; border-radius: 8px;">
                                    <span style="font-weight: 500; color: #0f766e;">Cambio / DevoluciÃ³n:</span>
                                    <span style="font-weight: 700; font-size: 1.2rem; color: #0f766e;">$<span
                                            id="cambioVenta">0.00</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Notas -->
                        <div class="form-group">
                            <label class="form-label">Notas Adicionales</label>
                            <textarea class="form-textarea" id="appointmentNotes"
                                placeholder="Indicaciones especiales, ayuno requerido, etc..."
                                style="min-height: 70px;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary"
                            style="background: #0f766e; border-color: #0f766e;">
                            <svg viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Cobrar y Generar Ticket
                        </button>
                    </div>
                </form>


            </div>
        </div>

        <!-- Supabase SDK -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <!-- Modal Verificar Asistencia -->
        <div id="modalVerificarAsistencia" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2); color: white;">
                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" fill="none"
                                stroke-width="2">
                                <path d="M9 11l3 3 8-8M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="modal-title" style="color: white;">Verificar Asistencia</h3>
                    </div>
                    <button class="modal-close" onclick="cerrarModalVerificarAsistencia()"
                        style="color: white; opacity: 0.8; background: transparent;"><svg viewBox="0 0 24 24" width="24"
                            height="24" stroke="currentColor" fill="none" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg></button>
                </div>
                <div class="modal-body">
                    <div id="pacienteInfoVerificar"
                        style="background: #f0fdfa; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #ccfbf1;">
                        <!-- Filled by JS -->
                    </div>

                    <p style="color: #64748b; margin-bottom: 1rem; font-weight: 500;">Seleccione el método de
                        verificación:</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button onclick="escanearQRAsistencia()" class="btn"
                            style="flex-direction: column; padding: 1.5rem; height: auto; gap: 0.75rem; border: 2px solid #e2e8f0; background: white; color: #1e293b; cursor: pointer;">
                            <div
                                style="width: 48px; height: 48px; background: #eff6ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #3b82f6;">
                                <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" fill="none"
                                    stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="9" y1="9" x2="9" y2="15"></line>
                                    <line x1="15" y1="9" x2="15" y2="15"></line>
                                </svg>
                            </div>
                            <span style="font-weight: 600;">Escanear Ticket</span>
                            <span style="font-size: 0.75rem; color: #64748b; font-weight: 400;">Usar cámara para
                                QR</span>
                        </button>

                        <button onclick="confirmarAsistenciaManual()" class="btn"
                            style="flex-direction: column; padding: 1.5rem; height: auto; gap: 0.75rem; border: 2px solid #e2e8f0; background: white; color: #1e293b; cursor: pointer;">
                            <div
                                style="width: 48px; height: 48px; background: #f0fdfa; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #0d9488;">
                                <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" fill="none"
                                    stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                            </div>
                            <span style="font-weight: 600;">Manual / Sin Ticket</span>
                            <span style="font-size: 0.75rem; color: #64748b; font-weight: 400;">Confirmar por
                                nombre</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="modalEscanearQR" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div
                            style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" fill="none"
                                stroke-width="2.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="9" y2="15"></line>
                                <line x1="15" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <h3 style="margin: 0; font-size: 1.25rem;">ESCANEAR CÓDIGO QR</h3>
                    </div>
                    <button class="modal-close" onclick="cerrarModalEscanearQR()" style="color: white; opacity: 0.9;">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" style="padding: 1.5rem;">
                    <p style="color: #64748b; text-align: center; margin-bottom: 1rem; font-size: 0.9rem;">
                        <strong style="color: #1e293b;">Instrucciones:</strong><br>
                        Coloca el cÃ³digo QR del ticket dentro del recuadro verde
                    </p>

                    <div
                        style="position: relative; width: 100%; max-width: 350px; margin: 0 auto; background: #000; border-radius: 12px; overflow: hidden;">
                        <video id="qrVideo" style="width: 100%; display: block; border-radius: 12px;" autoplay
                            playsinline></video>
                        <canvas id="qrCanvas" style="display: none;"></canvas>

                        <!-- QR Scanning Frame Overlay -->
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 220px; border: 3px solid #10b981; border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none;">
                            <!-- Corner decorations -->
                            <div
                                style="position: absolute; top: -3px; left: -3px; width: 30px; height: 30px; border-top: 4px solid #10b981; border-left: 4px solid #10b981; border-radius: 4px 0 0 0;">
                            </div>
                            <div
                                style="position: absolute; top: -3px; right: -3px; width: 30px; height: 30px; border-top: 4px solid #10b981; border-right: 4px solid #10b981; border-radius: 0 4px 0 0;">
                            </div>
                            <div
                                style="position: absolute; bottom: -3px; left: -3px; width: 30px; height: 30px; border-bottom: 4px solid #10b981; border-left: 4px solid #10b981; border-radius: 0 0 0 4px;">
                            </div>
                            <div
                                style="position: absolute; bottom: -3px; right: -3px; width: 30px; height: 30px; border-bottom: 4px solid #10b981; border-right: 4px solid #10b981; border-radius: 0 0 4px 0;">
                            </div>
                        </div>

                        <!-- Scanning animation line -->
                        <div
                            style="position: absolute; top: calc(50% - 110px); left: 50%; transform: translateX(-50%); width: 220px; height: 2px; background: linear-gradient(90deg, transparent, #10b981, transparent); animation: scanLine 2s linear infinite;">
                        </div>
                    </div>

                    <div
                        style="margin-top: 1.5rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <p
                            style="margin: 0; color: #1e40af; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span>El QR se detectarÃ¡ automÃ¡ticamente</span>
                        </p>
                    </div>

                    <button onclick="cerrarModalEscanearQR()" class="btn btn-secondary"
                        style="width: 100%; margin-top: 1rem; justify-content: center;">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal Generico -->
        <div id="genericModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div id="genericModalIcon" class="stat-icon"
                            style="width: 40px; height: 40px; border-radius: 10px;">
                        </div>
                        <h3 id="genericModalTitle" class="modal-title">TÃ­tulo</h3>
                    </div>
                    <button class="modal-close" onclick="closeGenericModal()">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="genericModalMessage" style="color: #475569; margin-bottom: 1rem; white-space: pre-line;"></p>
                    <div id="genericModalDetails"
                        style="display: none; background: #f8fafc; padding: 1rem; border-radius: 12px; margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                        <!-- Detalles aquÃ­ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeGenericModal()">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal Calendario -->
        <div id="modalCalendar" class="modal-overlay">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Seleccionar Fecha</h3>
                    <button class="modal-close" onclick="closeCalendarModal()">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="calendar-card">
                        <div class="card-header" style="border:none; padding-bottom:0;">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)"><svg viewBox="0 0 24 24">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg></button>
                            <span style="font-weight: 700; color: var(--text-dark);" id="calendarMonth">Mes AÃ±o</span>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)"><svg viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg></button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-header">
                                <span>Dom</span><span>Lun</span><span>Mar</span><span>MiÃ©</span><span>Jue</span><span>Vie</span><span>SÃ¡b</span>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Generado por JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Caja Apertura -->
        <div id="modalCajaApertura" class="modal-overlay">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Abrir Caja</h3>
                    <button class="modal-close" onclick="cerrarModalCajaApertura()"><svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="realizarApertura(event)">
                        <div class="form-group">
                            <label class="form-label">Monto de Apertura ($)</label>
                            <input type="number" id="montoApertura" class="form-input" step="0.50" value="0.00"
                                required>
                        </div>
                        <div class="modal-footer" style="padding: 0; border: none; margin-top: 1.5rem;">
                            <button type="button" class="btn btn-secondary"
                                onclick="cerrarModalCajaApertura()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Abrir Caja</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Caja Cierre -->
        <div id="modalCajaCierre" class="modal-overlay">
            <div class="modal" style="max-width: 450px;">
                <div class="modal-header">
                    <h3 class="modal-title">Cerrar Caja</h3>
                    <button class="modal-close" onclick="cerrarModalCajaCierre()"><svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg></button>
                </div>
                <div class="modal-body">
                    <div style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color:#64748b;">Ventas Sistema:</span>
                            <strong id="resumenVentasSistema">$0.00</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color:#64748b;">Efectivo en Caja Est.:</span>
                            <strong id="resumenEfectivoCaja">$0.00</strong>
                        </div>
                        <div style="border-top: 1px dashed #cbd5e1; margin: 0.5rem 0;"></div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Esperado:</span>
                            <strong id="expectedCierre" style="color: #0d9488;">$0.00</strong>
                        </div>
                    </div>
                    <form onsubmit="realizarCierre(event)">
                        <div class="form-group">
                            <label class="form-label">Monto Real en Caja ($)</label>
                            <input type="number" id="montoCierreReal" class="form-input" step="0.50" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notas / Discrepancias</label>
                            <textarea id="notasCierre" class="form-textarea"
                                placeholder="Observaciones del cierre..."></textarea>
                        </div>
                        <div class="modal-footer" style="padding: 0; border: none; margin-top: 1rem;">
                            <button type="button" class="btn btn-secondary"
                                onclick="cerrarModalCajaCierre()">Cancelar</button>
                            <button type="submit" class="btn btn-primary"
                                style="background: #ef4444; border-color: #ef4444;">Cerrar Caja</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Nueva Cita (Placeholder/Simplified) -->
        <div id="appointmentModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Nueva Cita</h3>
                    <button class="modal-close"
                        onclick="document.getElementById('appointmentModal').classList.remove('active')"><svg
                            viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg></button>
                </div>
                <div class="modal-body">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <h3>Usar Formulario Completo</h3>
                        <p>Para agendar una cita, utilice la página completa para una mejor experiencia.</p>
                        <button class="btn btn-primary" onclick="window.location.href='nueva_cita.html'">Ir a Nueva
                            Cita</button>
                    </div>
                    <!-- Form Hidden Placeholder for compatibility -->
                    <form id="appointmentForm" style="display:none;">
                        <input id="appointmentDate"><input id="appointmentTime">
                        <input id="primerNombre"><input id="segundoNombre"><input id="primerApellido"><input
                            id="segundoApellido">
                        <input id="patientPhone"><input id="medicoReferente"><textarea id="appointmentNotes"></textarea>
                        <input id="fechaNacimiento"><input id="diagnostico"><select id="metodoPago">
                            <option value="efectivo">Efectivo</option>
                        </select>
                        <input id="montoPagado" value="0">
                        <div id="listaEstudios"></div>
                        <div id="estudiosSeleccionados"></div>
                        <input id="buscarEstudio"><select id="filtroCategoria"></select>
                        <span id="totalVenta">0</span><span id="cantidadEstudiosVenta">0</span><span
                            id="cambioVenta">0</span>
                    </form>
                </div>
            </div>
        </div>
        <!-- Toasts -->
        <div id="toastContainer" class="toast-container"></div>

        <!-- Modal Confirmar Toma de Muestra -->
        <div class="modal-overlay" id="modalConfirmarMuestra">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header" style="background: #f0fdfa; border-bottom: 1px solid #ccfbf1;">
                    <h3 class="modal-title" style="color: #0d9488; display: flex; align-items: center; gap: 10px;">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" fill="none"
                            stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Confirmar Toma de Muestra
                    </h3>
                    <button class="modal-close" onclick="cerrarModalConfirmarMuestra()">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 1rem;">
                        Por favor verifica que has recolectado las muestras necesarias para el paciente:
                    </p>

                    <div
                        style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                        <div
                            style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">
                            Paciente</div>
                        <div id="confirmarMuestraPaciente"
                            style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin-bottom: 1.25rem;">
                            <!-- JS Populate -->
                        </div>

                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <div
                                    style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">
                                    Estudios Solicitados</div>
                                <div id="confirmarMuestraEstudios" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <!-- JS Populate Chips -->
                                </div>
                            </div>

                            <div
                                style="background: #fff7ed; border: 1px solid #ffedd5; border-radius: 8px; padding: 1rem;">
                                <div
                                    style="font-size: 0.85rem; color: #9a3412; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none"
                                        stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                    </svg>
                                    Tubos / Recipientes Requeridos
                                </div>
                                <ul id="confirmarMuestraTubos"
                                    style="margin: 0; padding-left: 1.5rem; color: #7c2d12; font-weight: 500; font-size: 0.95rem;">
                                    <!-- JS Populate List -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="cerrarModalConfirmarMuestra()">Cancelar</button>
                        <button class="btn" onclick="ejecutarConfirmacionMuestra()"
                            style="background: #0d9488; color: white;">
                            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Confirmar Muestra
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JsBarcode -->
        <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <!-- Modal Imprimir Etiquetas -->
        <div class="modal-overlay" id="modalImprimirEtiquetas" style="z-index: 99999;">
            <div class="modal-content"
                style="max-width: 800px; width: 95%; background: white; max-height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-icon">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                        <path d="M6 9V2h12v7"></path>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                </div>
                <h3 class="modal-title" style="text-align: center;">Etiquetas de Muestras</h3>
                <p class="modal-message" style="text-align: center;">Imprima las etiquetas para los tubos requeridos.
                </p>

                <div id="labelsContainer"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin: 2rem 0; padding: 1rem; overflow-y: auto; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <!-- Labels will be injected here -->
                </div>

                <div class="modal-actions"
                    style="margin-top: auto; padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: center; gap: 1rem;">
                    <button onclick="cerrarModalEtiquetas()"
                        style="padding: 12px 28px; border-radius: 10px; border: 1px solid #cbd5e1; background: white; color: #64748b; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Cerrar
                    </button>
                    <button onclick="imprimirEtiquetas()"
                        style="padding: 12px 32px; border-radius: 10px; border: none; background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); color: white; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 14px rgba(13, 148, 136, 0.35);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Imprimir Etiquetas
                    </button>
                </div>
            </div>
        </div>

        <script src="js/dashboard-init.js"></script>
        <script src="js/dashboard-modals.js"></script>
        <script src="js/dashboard-qr.js"></script>
        <script src="js/dashboard-caja.js"></script>
        <script src="js/dashboard-worklist-v2.js"></script>
        <script src="js/dashboard-analitica-v2.js"></script>
        <script src="js/dashboard-cotizaciones.js"></script>
        <script src="js/dashboard-main.js"></script>
</body>

</html>