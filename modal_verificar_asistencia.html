<!-- Modal Verificar Asistencia -->
<div id="modalVerificarAsistencia" class="modal-overlay">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header"
            style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div
                    style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" fill="none"
                        stroke-width="2.5">
                        <path d="M9 11l3 3 8-8M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 style="margin: 0; font-size: 1.25rem;">VERIFICAR ASISTENCIA</h3>
            </div>
            <button class="modal-close" onclick="cerrarModalVerificarAsistencia()" style="color: white; opacity: 0.9;">
                <svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <p style="color: #475569; margin-bottom: 1.5rem; text-align: center; font-size: 1rem;">¿Confirma que el
                paciente ha llegado?</p>

            <div id="pacienteInfoVerificar"
                style="background: #f1f5f9; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                <!-- Patient info will be inserted here -->
            </div>

            <p style="color: #64748b; font-size: 0.9rem; text-align: center; margin-bottom: 1.5rem;">Se asignará el
                próximo folio de atención.</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button onclick="escanearQRAsistencia()" class="btn"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; border: none; cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                    <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" fill="none" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="9" y2="15"></line>
                        <line x1="15" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span style="font-weight: 600; font-size: 0.9rem;">Escanear QR</span>
                </button>

                <button onclick="confirmarAsistenciaManual()" class="btn"
                    style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; border: none; cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                    <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" fill="none" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span style="font-weight: 600; font-size: 0.9rem;">Confirmar</span>
                </button>
            </div>

            <button onclick="cerrarModalVerificarAsistencia()" class="btn btn-secondary"
                style="width: 100%; margin-top: 1rem; justify-content: center;">Cancelar</button>
        </div>
    </div>
</div>

<script>
    let citaActualVerificar = null;

    function mostrarModalVerificarAsistencia(citaId) {
        const cita = allAppointments.find(c => c.id === citaId);
        if (!cita) return;

        citaActualVerificar = cita;

        const infoContainer = document.getElementById('pacienteInfoVerificar');
        const fecha = new Date(cita.fecha_hora).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

        infoContainer.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div style="width: 40px; height: 40px; background: rgba(13, 148, 136, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0d9488;">
                <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div>
                <div style="font-size: 0.75rem; color: #64748b;">Paciente</div>
                <div style="font-weight: 600; color: #1e293b;">${cita.paciente_nombre}</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div style="width: 40px; height: 40px; background: rgba(13, 148, 136, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0d9488;">
                <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div>
                <div style="font-size: 0.75rem; color: #64748b;">Cita programada</div>
                <div style="font-weight: 600; color: #1e293b;">${fecha}</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 40px; height: 40px; background: rgba(13, 148, 136, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0d9488;">
                <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <div>
                <div style="font-size: 0.75rem; color: #64748b;">Estudios</div>
                <div style="font-weight: 600; color: #1e293b;">${cita.estudios || 'Sin estudios'}</div>
            </div>
        </div>
    `;

        document.getElementById('modalVerificarAsistencia').classList.add('active');
    }

    function cerrarModalVerificarAsistencia() {
        document.getElementById('modalVerificarAsistencia').classList.remove('active');
        citaActualVerificar = null;
    }

    async function confirmarAsistenciaManual() {
        if (!citaActualVerificar) return;

        try {
            // Get next folio number for today
            const today = new Date().toISOString().split('T')[0];
            const { data: citasHoy, error: errorFolio } = await supabaseClient
                .from('citas')
                .select('folio_atencion')
                .gte('fecha_hora_llegada', today + 'T00:00:00')
                .lte('fecha_hora_llegada', today + 'T23:59:59')
                .order('folio_atencion', { ascending: false })
                .limit(1);

            const nextFolio = (citasHoy && citasHoy.length > 0 && citasHoy[0].folio_atencion)
                ? citasHoy[0].folio_atencion + 1
                : 1;

            // Update appointment with arrival info
            const { data, error } = await supabaseClient
                .from('citas')
                .update({
                    folio_atencion: nextFolio,
                    fecha_hora_llegada: new Date().toISOString(),
                    estado: 'verificada',
                    atendido_por: currentUser.id
                })
                .eq('id', citaActualVerificar.id)
                .select();

            if (error) throw error;

            cerrarModalVerificarAsistencia();
            showSuccessModal(
                '✅ Asistencia Verificada',
                `Paciente: ${citaActualVerificar.paciente_nombre}\nFolio de atención: #${nextFolio}`
            );

            // Refresh appointments list
            if (typeof loadAppointments === 'function') {
                await loadAppointments();
            }

        } catch (err) {
            console.error('Error verificando asistencia:', err);
            showErrorModal('Error', 'No se pudo verificar la asistencia: ' + err.message);
        }
    }

    function escanearQRAsistencia() {
        alert('Función de escaneo QR: Requiere integración de librería jsQR. Por ahora usa "Confirmar" para verificación manual.');
    }
</script>