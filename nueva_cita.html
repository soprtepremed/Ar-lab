<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Ar Lab - Nueva Cita</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700&family=Roboto:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="css/performance.css">
    <script src="navbar.js" defer></script>
    <style>
        :root {
            --primary: #0d9488;
            --primary-light: #5eead4;
            --primary-dark: #0f766e;
            --content-bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-dark);
            min-height: 100vh;
            position: relative;
        }

        #networkCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #0077b6 0%, #023e8a 50%, #03045e 100%);
        }



        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .form-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            border-color: var(--primary-light);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            font-size: 1rem;
            margin-bottom: 2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 800;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-section-blue {
            border-left: 4px solid #3b82f6;
        }

        .form-section-teal {
            border-left: 4px solid #0d9488;
        }

        .form-section-amber {
            border-left: 4px solid #d97706;
        }

        .form-section-primary {
            border-left: 4px solid var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.65rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-dark);
            transition: all 0.2s;
            background-color: #f8fafc;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: #f8fafc;
            color: var(--text-dark);
        }

        /* Payment Method Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .method-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .method-card:hover {
            border-color: var(--primary-light);
            background: #f0fdfa;
        }

        .method-card.active {
            border-color: var(--primary);
            background: #f0fdfa;
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1);
        }

        .method-card svg {
            color: #64748b;
            transition: all 0.2s;
        }

        .method-card.active svg {
            color: var(--primary);
        }

        .method-card span {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
        }

        .method-card.active span {
            color: var(--primary-dark);
        }

        #comprobanteSection {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Study Selector Styles Updated */
        .estudio-item {
            padding: 0.4rem 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
            background: #ffffff;
            height: auto;
            position: relative;
        }

        .estudio-item:hover {
            background: #f0fdfa;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.1);
            z-index: 10;
        }

        .estudio-item.selected {
            background: #ccfbf1;
            border-color: var(--primary);
        }

        .estudio-nombre {
            font-weight: 600;
            color: #1e293b;
            display: block;
            font-size: 0.75rem;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .estudio-indicaciones-tooltip {
            font-size: 0.6rem;
            color: #64748b;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .estudio-precio {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 0.75rem;
        }

        .category-group {
            margin-bottom: 1rem;
        }

        .category-title {
            font-size: 0.7rem;
            font-weight: 800;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            margin-bottom: 0.5rem;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.4rem;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            background: #f0fdfa;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-dark);
        }

        .modal-message {
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-modal {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-width: 120px;
        }

        .btn-confirm {
            background: var(--primary);
            color: white;
        }

        .btn-confirm:hover {
            background: var(--primary-dark);
        }

        .btn-cancel {
            background: #f1f5f9;
            color: var(--text-light);
        }

        .btn-cancel:hover {
            background: #e2e8f0;
            color: var(--text-dark);
        }

        /* Doctor Modal specific */
        .doctor-modal-content {
            max-width: 500px !important;
            text-align: left !important;
        }

        .doctor-modal-content .modal-title {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Doctor Selector Modal */
        .doctor-selector-modal {
            max-width: 600px !important;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .doctor-search-box {
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            width: 100%;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .doctor-search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .doctor-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }

        .doctor-list-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
        }

        .doctor-list-item:last-child {
            border-bottom: none;
        }

        .doctor-list-item:hover {
            background: #f0fdfa;
        }

        .doctor-list-item.selected {
            background: #ccfbf1;
            border-left: 3px solid var(--primary);
        }

        .doctor-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }

        .doctor-specialty {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .doctor-count-badge {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .medico-input-clickable {
            cursor: pointer;
            background: white !important;
        }

        .medico-input-clickable:hover {
            border-color: var(--primary) !important;
        }

        /* Responsive grid */
        @media (max-width: 900px) {
            .studies-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .studies-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           NUEVO LAYOUT COMPACTO 2 COLUMNAS
           ======================================== */

        /* Full viewport layout - OCUPA TODO EL ESPACIO */
        .compact-layout {
            display: grid;
            grid-template-columns: 70% 30%;
            gap: 0;
            height: calc(100vh - 70px);
            padding: 0;
            overflow: hidden;
            background: #f1f5f9;
        }

        /* Left Panel - Datos Compactos */
        .panel-left {
            background: white;
            border-radius: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            border-right: 1px solid #e2e8f0;
        }

        .panel-left .form-section {
            padding: 0.35rem 0.5rem;
            margin-bottom: 0.35rem;
            border-radius: 6px;
        }

        .panel-left .section-header {
            font-size: 0.65rem;
            margin-bottom: 0.35rem;
            padding-bottom: 0.25rem;
        }

        .panel-left .form-row {
            gap: 0.35rem;
            margin-bottom: 0.25rem;
        }

        .panel-left .form-group {
            margin-bottom: 0.25rem;
        }

        .panel-left .form-label {
            font-size: 0.6rem;
            margin-bottom: 0.15rem;
        }

        .panel-left .form-input,
        .panel-left .form-select {
            padding: 0.3rem 0.4rem;
            font-size: 0.75rem;
        }

        /* Payment compact */
        .panel-left .payment-methods {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.35rem;
            margin-bottom: 0.35rem;
        }

        .panel-left .method-card {
            padding: 0.35rem;
            border-radius: 6px;
        }

        .panel-left .method-card svg {
            width: 16px;
            height: 16px;
        }

        .panel-left .method-card span {
            font-size: 0.55rem;
        }

        /* Total and Submit Fixed */
        .panel-left-footer {
            margin-top: auto;
            padding-top: 0.5rem;
            border-top: 1px dashed #e2e8f0;
        }

        .total-display {
            text-align: center;
            padding: 0.5rem;
            background: #f0fdfa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .total-display .total-label {
            font-size: 0.6rem;
            color: #0f766e;
            font-weight: 600;
        }

        .total-display .total-amount {
            font-size: 1.4rem;
            font-weight: 800;
            color: #0f766e;
        }

        .btn-submit-compact {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.85rem;
            border-radius: 8px;
        }

        /* Right Panel - Estudios */
        .panel-right {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f8fafc;
        }

        .panel-right-header {
            background: white;
            padding: 0.6rem 1rem;
            border-radius: 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .panel-right-catalog {
            flex: 1;
            background: #f8fafc;
            border-radius: 0;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .panel-right-selected {
            background: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0;
            margin-top: 0;
            max-height: 80px;
            overflow-y: auto;
            border-top: 1px solid #e2e8f0;
        }

        /* Selected tags compact */
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #ccfbf1;
            border: 1px solid #0d9488;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #0f766e;
            margin: 0.15rem;
        }

        .selected-tag .remove-btn {
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
            margin-left: 0.25rem;
        }

        /* Estudios grid compact */
        .studies-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.35rem;
        }

        .estudio-item-compact {
            padding: 0.35rem 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            background: white;
            transition: all 0.1s;
        }

        .estudio-item-compact:hover {
            background: #f0fdfa;
            border-color: var(--primary);
        }

        .estudio-item-compact.selected {
            background: #ccfbf1;
            border-color: var(--primary);
        }

        .estudio-item-compact .nombre {
            font-size: 0.7rem;
            font-weight: 600;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .estudio-item-compact .precio {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        /* Category header compact */
        .category-title-compact {
            font-size: 0.65rem;
            font-weight: 800;
            color: #475569;
            text-transform: uppercase;
            margin: 0.5rem 0 0.25rem 0;
            padding-bottom: 0.15rem;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Hide original layout when compact is active */
        .compact-mode .main-container {
            display: none;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .compact-layout {
                grid-template-columns: 1fr;
                height: auto;
                overflow: auto;
            }

            .panel-left,
            .panel-right {
                height: auto;
                max-height: none;
            }
        }
    </style>
</head>

<body>
    <canvas id="networkCanvas"></canvas>
    <!-- Header -->
    <!-- Avatar Container -->
    <div id="navbar-container"></div>

    <!-- ========================================
         NUEVO LAYOUT COMPACTO 2 COLUMNAS
         ======================================== -->
    <form id="appointmentFormCompact" class="compact-layout" onsubmit="saveAppointment(event)"
        style="position: fixed; top: 70px; left: 0; right: 0; bottom: 0;">

        <!-- PANEL IZQUIERDO - Datos Compactos -->
        <div class="panel-left">

            <!-- GRID 2 COLUMNAS INTERNAS -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; flex: 1;">

                <!-- COLUMNA IZQUIERDA: Paciente + Detalles -->
                <div style="display: flex; flex-direction: column; gap: 0.4rem;">

                    <!-- DATOS DEL PACIENTE -->
                    <div class="form-section form-section-teal" style="padding: 0.5rem; margin-bottom: 0;">
                        <h4 class="section-header"
                            style="color: #0f766e; font-size: 0.75rem; margin-bottom: 0.4rem; padding-bottom: 0.25rem; font-family: Consolas, monospace; font-weight: 800;">
                            DATOS DEL PACIENTE
                        </h4>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label
                                style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Expediente:</label>
                            <input type="text" id="expedienteCompact" placeholder=""
                                oninput="syncField('expedienteNumero', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">F/N
                                *:</label>
                            <input type="date" id="fechaNacimientoCompact" required
                                onchange="syncField('fechaNacimiento', this.value); validarFechaNacimiento(this)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">1er Nombre
                                *:</label>
                            <input type="text" id="primerNombreCompact" required placeholder=""
                                oninput="normalizeInput(this); syncField('primerNombre', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">2do
                                Nombre:</label>
                            <input type="text" id="segundoNombreCompact" placeholder=""
                                oninput="normalizeInput(this); syncField('segundoNombre', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">1er Apellido
                                *:</label>
                            <input type="text" id="primerApellidoCompact" required placeholder=""
                                oninput="normalizeInput(this); syncField('primerApellido', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">2do
                                Apellido:</label>
                            <input type="text" id="segundoApellidoCompact" placeholder=""
                                oninput="normalizeInput(this); syncField('segundoApellido', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Sexo
                                *:</label>
                            <select id="pacienteSexoCompact" required onchange="syncField('pacienteSexo', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                                <option value="">...</option>
                                <option value="Masculino">M</option>
                                <option value="Femenino">F</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Tel√©fono
                                *:</label>
                            <input type="tel" id="patientPhoneCompact" required placeholder=""
                                oninput="syncField('patientPhone', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                    </div>

                    <!-- DETALLES -->
                    <div class="form-section form-section-teal" style="padding: 0.5rem; margin-bottom: 0;">
                        <h4 class="section-header"
                            style="color: #0f766e; font-size: 0.75rem; margin-bottom: 0.4rem; padding-bottom: 0.25rem; font-family: Consolas, monospace; font-weight: 800;">
                            DETALLES
                        </h4>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label
                                style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Diagn√≥stico:</label>
                            <input type="text" id="diagnosticoCompact" placeholder=""
                                oninput="syncField('diagnostico', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label
                                style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Procedencia:</label>
                            <select id="procedenciaCompact" onchange="syncField('procedencia', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                                <option value="">Seleccionar...</option>
                            </select>
                            <button type="button" onclick="agregarNuevaProcedencia()"
                                style="margin-left: 0.25rem; padding: 0.15rem 0.35rem; background: #0d9488; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold;"
                                title="Agregar nueva procedencia">+</button>
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Piso:</label>
                            <input type="text" id="pisoCompact" placeholder=""
                                oninput="syncField('pisoHospital', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Cama:</label>
                            <input type="text" id="camaCompact" placeholder=""
                                oninput="syncField('camaHabitacion', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label
                                style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Servicio:</label>
                            <select id="servicioHospitalCompact" onchange="syncField('servicioHospital', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                                <option value="Laboratorio">Laboratorio</option>
                                <option value="Urgencias">Urgencias</option>
                                <option value="Hospitalizaci√≥n">Hospitalizaci√≥n</option>
                                <option value="Consulta Externa">Consulta Ext.</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: Cita + M√©dico -->
                <div style="display: flex; flex-direction: column; gap: 0.4rem;">

                    <!-- CITA -->
                    <div class="form-section form-section-teal" style="padding: 0.5rem; margin-bottom: 0;">
                        <h4 class="section-header"
                            style="color: #0f766e; font-size: 0.75rem; margin-bottom: 0.4rem; padding-bottom: 0.25rem; font-family: Consolas, monospace; font-weight: 800;">
                            CITA
                        </h4>
                        <div style="display: flex; align-items: center; margin-bottom: 0.2rem;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Fecha
                                *:</label>
                            <input type="date" id="appointmentDateCompact" required
                                onchange="syncField('appointmentDate', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Hora
                                *:</label>
                            <input type="time" id="appointmentTimeCompact" required value="08:00"
                                onchange="syncField('appointmentTime', this.value)"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none;">
                        </div>
                    </div>

                    <!-- M√âDICO -->
                    <div class="form-section form-section-teal" style="padding: 0.5rem; margin-bottom: 0;">
                        <h4 class="section-header"
                            style="color: #0f766e; font-size: 0.75rem; margin-bottom: 0.4rem; padding-bottom: 0.25rem; font-family: Consolas, monospace; font-weight: 800;">
                            M√âDICO
                        </h4>
                        <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
                            <label
                                style="font-size: 0.7rem; color: #475569; width: 80px; flex-shrink: 0;">Referente:</label>
                            <input type="text" id="medicoReferenteCompact" placeholder="A quien corresponda" readonly
                                onclick="openDoctorSelectorModal()"
                                style="flex: 1; border: none; border-bottom: 1px solid #99f6e4; padding: 0.2rem 0; font-size: 0.8rem; background: transparent; outline: none; cursor: pointer;">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="nuevoMedico()"
                            style="width: 100%; padding: 0.25rem; font-size: 0.65rem;">
                            + Nuevo M√©dico
                        </button>
                    </div>
                </div>
            </div>
            <!-- FIN GRID 2 COLUMNAS -->

            <!-- PAGO - ANCHO COMPLETO ABAJO -->
            <div class="form-section"
                style="padding: 0.5rem; margin-top: 0.4rem; background: #f0fdfa; border: 1px solid #99f6e4;">
                <h4 class="section-header"
                    style="color: #0d9488; font-size: 0.8rem; margin-bottom: 0.4rem; padding-bottom: 0.25rem; border-color: #99f6e4; display: flex; align-items: center; gap: 0.4rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <rect x="2" y="6" width="20" height="12" rx="2" />
                        <circle cx="12" cy="12" r="3" />
                        <line x1="6" y1="12" x2="6" y2="12.01" />
                        <line x1="18" y1="12" x2="18" y2="12.01" />
                    </svg>
                    PAGO
                </h4>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div class="payment-methods" style="display: flex; gap: 0.5rem; flex: 1;">
                        <div class="method-card active" onclick="selectPaymentMethod('efectivo', this)"
                            style="padding: 0.4rem 0.8rem; flex: 1; text-align: center;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="6" width="20" height="12" rx="2" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <span style="font-size: 0.7rem; display: block;">Efectivo</span>
                        </div>
                        <div class="method-card" onclick="selectPaymentMethod('tarjeta', this)"
                            style="padding: 0.4rem 0.8rem; flex: 1; text-align: center;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="5" width="20" height="14" rx="2" />
                                <line x1="2" y1="10" x2="22" y2="10" />
                            </svg>
                            <span style="font-size: 0.7rem; display: block;">Tarjeta</span>
                        </div>
                        <div class="method-card" onclick="selectPaymentMethod('transferencia', this)"
                            style="padding: 0.4rem 0.8rem; flex: 1; text-align: center;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12M17 20l-4-4M17 20l4-4" />
                            </svg>
                            <span style="font-size: 0.7rem; display: block;">Transfer</span>
                        </div>
                    </div>
                    <div id="montoRecibidoGroupCompact" style="display: flex; align-items: center; gap: 0.3rem;">
                        <label style="font-size: 0.75rem; color: #0d9488; font-weight: 600;">Monto:</label>
                        <input type="number" id="montoPagadoCompact" placeholder="0.00" step="0.50"
                            oninput="calcularCambio(); syncField('montoPagado', this.value)"
                            style="width: 100px; border: 2px solid #99f6e4; border-radius: 6px; padding: 0.4rem; font-size: 0.9rem; font-weight: 700; text-align: right;">
                    </div>
                </div>
            </div>

            <!-- Footer: Total + Submit -->
            <div class="panel-left-footer">
                <div class="total-display">
                    <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: #64748b;">
                        <span>Subtotal:</span>
                        <span>$<span id="subtotalCompact">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: #64748b;">
                        <span>IVA (16%):</span>
                        <span>$<span id="ivaCompact">0.00</span></span>
                    </div>
                    <div style="border-top: 1px dashed #cbd5e1; margin: 0.25rem 0; padding-top: 0.25rem;">
                        <div class="total-label">TOTAL A PAGAR</div>
                        <div class="total-amount">$<span id="totalVentaCompact">0.00</span></div>
                    </div>
                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                        Cambio: $<span id="cambioVentaCompact">0.00</span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-submit-compact">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M20 6L9 17l-5-5" />
                    </svg>
                    Registrar Cita
                </button>
            </div>
        </div>

        <!-- PANEL DERECHO - Estudios -->
        <div class="panel-right">
            <!-- Header con b√∫squeda -->
            <div class="panel-right-header" style="padding: 0.5rem;">
                <input type="text" class="form-input" id="buscarEstudioCompact" oninput="applyFiltersCompact()"
                    placeholder="üîç Buscar..."
                    style="width: 100%; padding: 0.4rem; font-size: 0.75rem; margin-bottom: 0.35rem;">
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <select class="form-select" id="filtroCategoriaCompact"
                        style="flex: 1; padding: 0.35rem; font-size: 0.7rem;" onchange="applyFiltersCompact()">
                        <option value="">Todas</option>
                    </select>
                    <button type="button" id="btnFavoritos" onclick="toggleFiltroFavoritos()" title="Ver solo favoritos"
                        style="padding: 0.35rem 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        ‚≠ê
                    </button>
                    <button type="button" class="btn btn-primary" onclick="abrirModalEstudioManual()"
                        style="padding: 0.35rem 0.5rem; font-size: 0.7rem;">
                        +
                    </button>
                </div>
            </div>

            <!-- Cat√°logo de estudios -->
            <div class="panel-right-catalog" id="listaEstudiosCompact">
                <div style="text-align: center; padding: 2rem; color: #64748b;">Cargando estudios...</div>
            </div>

            <!-- Estudios seleccionados -->
            <div class="panel-right-selected">
                <div style="font-size: 0.7rem; font-weight: 700; color: #475569; margin-bottom: 0.35rem;">
                    SELECCIONADOS (<span id="cantidadEstudiosCompact">0</span>)
                </div>
                <div id="estudiosSeleccionadosCompact">
                    <span style="color: #94a3b8; font-size: 0.7rem;">Ning√∫n estudio seleccionado</span>
                </div>
            </div>
        </div>
    </form>

    <!-- Main Content Original (OCULTO) -->
    <main class="main-container" style="display: none;">
        <header class="top-bar"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 id="pageTitle" class="page-title"
                style="display: flex; align-items: center; gap: 0.75rem; color: white; font-family: 'Outfit', sans-serif; font-size: 1.75rem;">
                <svg viewBox="0 0 24 24" width="32" height="32" stroke="var(--primary-light)" fill="none"
                    stroke-width="2.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Nueva Cita de Laboratorio
            </h1>
            <a href="dashboard.html" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                Volver
            </a>
        </header>

        <form id="appointmentForm" onsubmit="saveAppointment(event)">

            <!-- Datos del Paciente -->
            <div class="form-section form-section-blue">
                <h4 class="section-header" style="color: #1e40af;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    Datos del Paciente
                </h4>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Primer Nombre *</label>
                        <input type="text" class="form-input" id="primerNombre" required placeholder="Ej: Juan"
                            oninput="normalizeInput(this)" onblur="checkPacienteExistente()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segundo Nombre</label>
                        <input type="text" class="form-input" id="segundoNombre" placeholder="Ej: Carlos"
                            oninput="normalizeInput(this)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Primer Apellido *</label>
                        <input type="text" class="form-input" id="primerApellido" required placeholder="Ej: Garc√≠a"
                            oninput="normalizeInput(this)" onblur="checkPacienteExistente()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segundo Apellido</label>
                        <input type="text" class="form-input" id="segundoApellido" placeholder="Ej: L√≥pez"
                            oninput="normalizeInput(this)">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Fecha de Nacimiento *</label>
                        <input type="date" class="form-input" id="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sexo *</label>
                        <select class="form-select" id="pacienteSexo" required>
                            <option value="">Seleccionar...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tel√©fono *</label>
                        <input type="tel" class="form-input" id="patientPhone" required placeholder="10 d√≠gitos">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem; border-top: 1px dashed #e2e8f0; padding-top: 1rem;">
                    <label class="form-label">Diagn√≥stico / Motivo de Consulta</label>
                    <input type="text" class="form-input" id="diagnostico"
                        placeholder="Ej: Chequeo general, Control de glucosa..." style="width: 100%;">
                </div>
            </div>

            <!-- Selecci√≥n de Estudios -->
            <div class="form-section form-section-primary">
                <h4 class="section-header" style="color: var(--primary-dark);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                    Estudios de Laboratorio
                </h4>

                <div class="form-group">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-input" id="buscarEstudio" oninput="applyFilters()"
                            placeholder="Buscar estudio por nombre o c√≥digo..." style="flex: 1;">
                        <select class="form-select" id="filtroCategoria" style="width: 250px;"
                            onchange="applyFilters()">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="abrirModalEstudioManual()"
                            style="flex-shrink: 0; padding: 0 1rem; height: auto;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5" style="margin:0">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span style="margin-left:5px">Estudio Manual</span>
                        </button>
                    </div>

                    <div
                        style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #64748b;">
                        <input type="checkbox" id="verComponentesOcultos" onchange="applyFilters()">
                        <label for="verComponentesOcultos" style="cursor: pointer; user-select: none;">Ver componentes
                            individuales (Precio $0)</label>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div>
                            <label class="form-label"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                Cat√°logo de Estudios
                                <span style="font-size: 0.7rem; color: #94a3b8; font-weight: normal;">* Click para
                                    seleccionar/quitar</span>
                            </label>
                            <div id="listaEstudios"
                                style="max-height: 800px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; padding: 1rem;">
                                <!-- Estudios se cargan din√°micamente en 3 columnas por categor√≠a -->
                            </div>
                        </div>

                        <!-- Estudios Seleccionados (Resumen m√°s compacto) -->
                        <div>
                            <label class="form-label">Estudios Seleccionados</label>
                            <div id="contenidoSeleccionados"
                                style="min-height: 60px; border: 2px dashed #cbd5e1; border-radius: 12px; background: #f1f5f9; padding: 0.75rem;">
                                <div id="estudiosSeleccionados" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <div style="padding: 1rem; text-align: center; color: #94a3b8; width: 100%;">
                                        Ning√∫n estudio seleccionado
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos de la Cita -->
            <div class="form-section form-section-teal" id="sectionDatosCita">
                <h4 class="section-header" style="color: #0f766e;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    Datos de la Cita
                </h4>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha de Cita *</label>
                        <input type="date" class="form-input" id="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora *</label>
                        <input type="time" class="form-input" id="appointmentTime" required value="08:00">
                    </div>
                </div>
            </div>



            <!-- Datos de Hospitalizaci√≥n / Segmentaci√≥n -->
            <div class="form-section form-section-amber">
                <h4 class="section-header" style="color: #92400e;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                    Ubicaci√≥n y Segmentaci√≥n
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N¬∫ Expediente</label>
                        <input type="text" class="form-input" id="expedienteNumero" placeholder="Ej: EXP-2024-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Servicio / √Årea</label>
                        <select class="form-select" id="servicioHospital">
                            <option value="Laboratorio">Laboratorio (General)</option>
                            <option value="Urgencias">Urgencias</option>
                            <option value="Hospitalizaci√≥n">Hospitalizaci√≥n</option>
                            <option value="Consulta Externa">Consulta Externa</option>
                            <option value="UCI">UCI (Cuidados Intensivos)</option>
                            <option value="Quir√≥fano">Quir√≥fano</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Piso / Nivel</label>
                        <select class="form-select" id="pisoHospital">
                            <option value="Planta Baja">Planta Baja</option>
                            <option value="Piso 1">Piso 1</option>
                            <option value="Piso 2">Piso 2</option>
                            <option value="Piso 3">Piso 3</option>
                            <option value="Anexo">Anexo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cama / Habitaci√≥n (Opcional)</label>
                        <input type="text" class="form-input" id="camaHabitacion" placeholder="Ej: 204-B">
                    </div>
                </div>
            </div>

            <!-- M√©dico Referente -->
            <div class="form-section form-section-amber">
                <h4 class="section-header" style="color: #b45309;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                        <circle cx="8.5" cy="7" r="4" />
                        <polyline points="17 11 19 13 23 9" />
                    </svg>
                    M√©dico Referente
                </h4>

                <div class="form-group">
                    <label class="form-label">Seleccionar m√©dico referente</label>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" class="form-input medico-input-clickable" id="medicoReferente"
                                placeholder="Click para seleccionar m√©dico..." readonly
                                onclick="openDoctorSelectorModal()">
                            <input type="hidden" id="medicoReferenteId">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="nuevoMedico()"
                            style="padding: 0.85rem 1.25rem; white-space: nowrap;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                            Nuevo
                        </button>
                    </div>
                    <small style="color: #64748b; margin-top: 0.5rem; display: block;">Si el m√©dico es nuevo, haz click
                        en "Nuevo" para agregarlo al cat√°logo.</small>
                </div>
            </div>

            <!-- Caja y Facturaci√≥n -->
            <div class="form-section" style="background: #f0fdfa; border: 2px solid #99f6e4;">
                <h4 class="section-header" style="color: #0d9488; border-bottom-color: #99f6e4;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <line x1="12" y1="1" x2="12" y2="23" />
                        <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />
                    </svg>
                    Caja y Facturaci√≥n
                </h4>

                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    <!-- Totales -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 1.5rem; border-bottom: 2px dashed #99f6e4;">
                        <div style="font-size: 1.1rem; color: #0f766e;">
                            Estudios seleccionados: <strong id="cantidadEstudiosVenta"
                                style="font-size: 1.4rem;">0</strong>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1rem; color: #0f766e; margin-bottom: 0.5rem; font-weight: 600;">Total
                                a Pagar</div>
                            <div
                                style="font-size: 3.5rem; font-weight: 800; color: #0f766e; line-height: 0.9; letter-spacing: -0.02em;">
                                $<span id="totalVenta">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pago -->
                    <div>
                        <label class="form-label" style="font-size: 1rem; margin-bottom: 1rem;">M√©todo de Pago</label>
                        <div class="payment-methods">
                            <div class="method-card active" onclick="selectPaymentMethod('efectivo', this)">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="2" y="6" width="20" height="12" rx="2" />
                                    <circle cx="12" cy="12" r="3" />
                                    <path d="M6 12h.01M18 12h.01" />
                                </svg>
                                <span>Efectivo</span>
                            </div>
                            <div class="method-card" onclick="selectPaymentMethod('tarjeta', this)">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="2" y="5" width="20" height="14" rx="2" />
                                    <line x1="2" y1="10" x2="22" y2="10" />
                                </svg>
                                <span>Tarjeta</span>
                            </div>
                            <div class="method-card" onclick="selectPaymentMethod('transferencia', this)">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12M17 20l-4-4M17 20l4-4" />
                                </svg>
                                <span>Transferencia</span>
                            </div>
                        </div>

                        <div class="form-group" id="montoRecibidoGroup" style="max-width: 300px;">
                            <label class="form-label">Monto Recibido ($)</label>
                            <input type="number" class="form-input" id="montoPagado" placeholder="0.00" step="0.50"
                                oninput="calcularCambio()" style="font-size: 1.2rem; font-weight: 600; padding: 1rem;">
                        </div>

                        <!-- Secci√≥n Comprobante (Hidden) -->
                        <div id="comprobanteSection">
                            <h5
                                style="font-size: 0.9rem; color: #0d9488; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                </svg>
                                Detalles del Comprobante
                            </h5>
                            <div class="form-group">
                                <label class="form-label">Cargar Comprobante (Imagen)</label>
                                <input type="file" class="form-input" id="comprobanteFile" accept="image/*">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Notas / Ref. Operaci√≥n</label>
                                    <input type="text" class="form-input" id="comprobanteNotas"
                                        placeholder="Ej: Ticket #1234">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Comentarios Extra</label>
                                    <input type="text" class="form-input" id="comprobanteComentarios"
                                        placeholder="Opcional...">
                                </div>
                            </div>
                            <div
                                style="font-size: 0.8rem; color: #0f766e; background: #ccfbf1; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600;">
                                Operador responsable: <span id="opCargador">--</span>
                            </div>
                        </div>
                    </div>

                    <div
                        style="margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #99f6e4; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                        <span
                            style="font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em;">Cambio
                            / Devoluci√≥n</span>
                        <div style="font-weight: 800; font-size: 2.2rem; color: #0f766e; margin-top: 0.25rem;">
                            $<span id="cambioVenta">0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notas -->
            <div class="form-section">
                <label class="form-label" style="font-size: 0.9rem;">Notas Adicionales</label>
                <textarea class="form-textarea" id="appointmentNotes" placeholder="Indicaciones especiales..."
                    style="min-height: 100px;"></textarea>
            </div>

            <!-- Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 1.5rem; margin-bottom: 4rem;">
                <a href="dashboard.html" class="btn btn-secondary" style="padding: 1rem 2rem;">Cancelar</a>
                <button type="submit" class="btn btn-primary"
                    style="padding: 1.25rem 3rem; font-size: 1.2rem; box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M20 6L9 17l-5-5" />
                    </svg>
                    Confirmar y Generar Ticket
                </button>
            </div>
        </form>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Hidden Capture Container -->
    <div id="ticketCaptureContainer" style="position: absolute; left: -9999px; top: -9999px;"></div>

    <!-- Modal Estudio Manual -->
    <div id="modalEstudioManual" class="modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
        <div
            style="background:white; padding:2.5rem; border-radius:24px; width:95%; max-width:500px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
            <h2
                style="font-family:'Outfit'; margin-bottom:1.5rem; color:var(--primary-dark); display:flex; align-items:center; gap:10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M12 20h9" />
                    <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
                </svg>
                A√±adir Estudio Manual
            </h2>
            <div class="form-group">
                <label class="form-label">Nombre del Estudio</label>
                <input type="text" id="manualNombre" class="form-input" placeholder="Ej: Prueba Especial Rara">
            </div>
            <div class="form-group">
                <label class="form-label">Precio ($)</label>
                <input type="number" id="manualPrecio" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalEstudioManual()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarEstudioManual()">A√±adir a la
                    Cuenta</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://ebihobjrwcwtjfazcjmv.supabase.co';
        const supabaseKey = 'sb_publishable_31x2oYQjyxNJ2otN6TF-Kw_5VGXaGJd';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // State
        let todosEstudios = [];
        let todosMedicos = [];
        let estudiosSeleccionados = [];
        let totalVenta = 0;
        let montoPagado = 0;
        let cambioVenta = 0;
        let metodoPagoActual = 'efectivo';
        let currentUser = null;
        let currentLabConfig = {
            nombre_laboratorio: 'AR LAB',
            responsable_sanitario: 'Q.F.B. Adolfo Ruiz',
            cedula_profesional: '1234567',
            direccion: 'Calle Principal #123, Veracruz, Ver.',
            telefono: '228 123 4567'
        };

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const isDirecto = params.get('mode') === 'directo';

            if (isDirecto) {
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    // Mantener el SVG
                    const svg = pageTitle.querySelector('svg').outerHTML;
                    pageTitle.innerHTML = `${svg} Registro de Paciente (Venta Directa)`;
                }
                document.querySelector('.btn-primary').innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M20 6L9 17l-5-5" />
                    </svg>
                    Registrar y Generar Ticket
                `;

                // Deshabilitar secci√≥n de fecha/hora para venta directa
                const sectionCita = document.getElementById('sectionDatosCita');
                sectionCita.style.opacity = '0.7';
                sectionCita.style.pointerEvents = 'none';
                sectionCita.style.background = '#f1f5f9';
                document.getElementById('appointmentDate').disabled = true;
                document.getElementById('appointmentTime').disabled = true;

                // Cambiar el t√≠tulo de la secci√≥n para dar claridad
                sectionCita.querySelector('h4').innerHTML += ' <span style="font-size: 0.7rem; color: #0d9488; font-weight: normal; margin-left: 10px;">(Autom√°tico: Registro Inmediato)</span>';
            }

            // Use local date to avoid UTC issues (showing tomorrow late at night)
            const localDate = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).split('/').reverse().join('-');
            document.getElementById('appointmentDate').value = localDate;

            // Set current time for appointmentTime
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('appointmentTime').value = `${hours}:${minutes}`;

            // Check auth
            const userStr = localStorage.getItem('arlab_user');
            if (!userStr) {
                window.location.href = 'index.html';
            } else {
                try {
                    currentUser = JSON.parse(userStr);
                    document.getElementById('opCargador').textContent = currentUser.nombre || currentUser.usuario || 'Admin';
                } catch (e) {
                    currentUser = { nombre: userStr };
                    document.getElementById('opCargador').textContent = userStr;
                }
            }

            await loadLabConfig();
            loadEstudios();
            loadMedicos();
            loadProcedencias();
            setupEstudioSearch();

            // INICIALIZAR LAYOUT COMPACTO
            initCompactLayout();

            // Animation init
            resize();
            animate();
        });

        // ========================================
        // FUNCIONES LAYOUT COMPACTO
        // ========================================

        function initCompactLayout() {
            // Sincronizar fecha y hora al layout compacto
            const localDate = new Date().toLocaleDateString('es-MX', {
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).split('/').reverse().join('-');

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const dateCompact = document.getElementById('appointmentDateCompact');
            const timeCompact = document.getElementById('appointmentTimeCompact');
            if (dateCompact) dateCompact.value = localDate;
            if (timeCompact) timeCompact.value = `${hours}:${minutes}`;

            // Tambi√©n sincronizar con el form original oculto
            syncField('appointmentDate', localDate);
            syncField('appointmentTime', `${hours}:${minutes}`);

            // Establecer max date en F. Nacimiento para no aceptar fechas futuras
            const fechaNacCompact = document.getElementById('fechaNacimientoCompact');
            const fechaNacOrig = document.getElementById('fechaNacimiento');
            const today = new Date().toISOString().split('T')[0];
            if (fechaNacCompact) fechaNacCompact.max = today;
            if (fechaNacOrig) fechaNacOrig.max = today;
        }

        function validarFechaNacimiento(input) {
            const today = new Date();
            const selectedDate = new Date(input.value);

            if (selectedDate > today) {
                mostrarAlerta('La fecha de nacimiento no puede ser una fecha futura.', 'Fecha inv√°lida', 'warning');
                input.value = '';
                return false;
            }
            return true;
        }

        function syncField(fieldId, value) {
            const el = document.getElementById(fieldId);
            if (el) el.value = value;
        }

        function applyFiltersCompact() {
            const searchTerm = document.getElementById('buscarEstudioCompact').value.toLowerCase();
            const categoria = document.getElementById('filtroCategoriaCompact').value;

            // Tambi√©n sincronizar con los filtros originales
            const buscarOrig = document.getElementById('buscarEstudio');
            const catOrig = document.getElementById('filtroCategoria');
            if (buscarOrig) buscarOrig.value = searchTerm;
            if (catOrig) catOrig.value = categoria;

            // Llamar al filtro original que ya existe
            applyFilters();

            // Renderizar en el cat√°logo compacto
            renderStudiesCompact(searchTerm, categoria);
        }

        // Colores por categor√≠a
        const COLORES_CATEGORIA = {
            'PERFILES': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
            'QU√çMICA CL√çNICA': { bg: '#fff7ed', border: '#ea580c', text: '#9a3412' },
            'INMUNOLOG√çA': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
            'HEMATOLOG√çA': { bg: '#fce7f3', border: '#ec4899', text: '#9d174d' },
            'COPROLOG√çA': { bg: '#d1fae5', border: '#10b981', text: '#065f46' },
            'URIAN√ÅLISIS': { bg: '#e0e7ff', border: '#6366f1', text: '#3730a3' },
            'SEROLOG√çA': { bg: '#fef9c3', border: '#eab308', text: '#854d0e' },
            'HORMONAS': { bg: '#ede9fe', border: '#8b5cf6', text: '#5b21b6' },
            'OTROS': { bg: '#f1f5f9', border: '#94a3b8', text: '#475569' }
        };

        // Sistema de favoritos (guardado en localStorage)
        let estudiosFavoritos = JSON.parse(localStorage.getItem('arlab_estudios_favoritos') || '[]');
        let mostrarSoloFavoritos = false;

        function toggleFavorito(estudioId, event) {
            event.stopPropagation();
            const idx = estudiosFavoritos.indexOf(estudioId);
            if (idx > -1) {
                estudiosFavoritos.splice(idx, 1);
            } else {
                estudiosFavoritos.push(estudioId);
            }
            localStorage.setItem('arlab_estudios_favoritos', JSON.stringify(estudiosFavoritos));
            applyFiltersCompact();
        }

        function toggleFiltroFavoritos() {
            mostrarSoloFavoritos = !mostrarSoloFavoritos;
            const btn = document.getElementById('btnFavoritos');
            if (btn) {
                btn.style.background = mostrarSoloFavoritos ? '#fef3c7' : '#f8fafc';
                btn.style.borderColor = mostrarSoloFavoritos ? '#f59e0b' : '#e2e8f0';
            }
            applyFiltersCompact();
        }

        function esFavorito(estudioId) {
            return estudiosFavoritos.includes(estudioId);
        }

        // Normalizar categor√≠a (unificar duplicados) - PERFILES tienen prioridad
        function normalizarCategoria(cat, esPerfil = false) {
            if (esPerfil) return 'PERFILES';
            if (!cat) return 'OTROS';
            const upper = cat.toUpperCase().trim();
            if (upper.includes('INMUNO')) return 'INMUNOLOG√çA';
            if (upper.includes('QU√çMICA') || upper.includes('QUIMICA')) return 'QU√çMICA CL√çNICA';
            if (upper.includes('HEMATO')) return 'HEMATOLOG√çA';
            if (upper.includes('COPRO')) return 'COPROLOG√çA';
            if (upper.includes('URIN') || upper.includes('ORIN')) return 'URIAN√ÅLISIS';
            if (upper.includes('SERO')) return 'SEROLOG√çA';
            if (upper.includes('HORMON')) return 'HORMONAS';
            return upper;
        }

        function getColorCategoria(cat) {
            const normalized = cat === 'PERFILES' ? 'PERFILES' : normalizarCategoria(cat);
            return COLORES_CATEGORIA[normalized] || COLORES_CATEGORIA['OTROS'];
        }

        function renderStudiesCompact(searchTerm = '', categoria = '') {
            const container = document.getElementById('listaEstudiosCompact');
            if (!container || !todosEstudios || todosEstudios.length === 0) return;

            // Filtrar estudios
            let estudios = todosEstudios.filter(e => {
                if (e.es_perfil === false && parseFloat(e.precio) === 0) return false;

                // Filtro de favoritos
                if (mostrarSoloFavoritos && !esFavorito(e.id)) return false;

                const matchSearch = !searchTerm ||
                    e.nombre.toLowerCase().includes(searchTerm) ||
                    (e.codigo && e.codigo.toLowerCase().includes(searchTerm));

                // Categor√≠a - PERFILES se consideran por separado
                const esPerfil = e.es_perfil === true;
                const normalizedCat = normalizarCategoria(e.categoria, esPerfil);
                const matchCat = !categoria || normalizedCat === categoria || e.categoria === categoria;

                return matchSearch && matchCat;
            });

            // Agrupar por categor√≠a normalizada - PERFILES van primero
            const grupos = {};
            estudios.forEach(e => {
                const esPerfil = e.es_perfil === true;
                const cat = esPerfil ? 'PERFILES' : normalizarCategoria(e.categoria);
                if (!grupos[cat]) grupos[cat] = [];
                grupos[cat].push(e);
            });

            // Orden deseado de categor√≠as - PERFILES SIEMPRE PRIMERO
            const ordenCategorias = ['PERFILES', 'QU√çMICA CL√çNICA', 'HEMATOLOG√çA', 'INMUNOLOG√çA', 'URIAN√ÅLISIS', 'COPROLOG√çA', 'SEROLOG√çA', 'HORMONAS', 'OTROS'];
            const categoriasOrdenadas = Object.keys(grupos).sort((a, b) => {
                const idxA = ordenCategorias.indexOf(a);
                const idxB = ordenCategorias.indexOf(b);
                return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
            });

            // Renderizar en UNA SOLA COLUMNA
            let html = '';
            categoriasOrdenadas.forEach(cat => {
                const colors = getColorCategoria(cat);
                html += `<div style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; padding: 0.35rem 0.5rem; margin-bottom: 0.15rem; border-radius: 4px;">
                    <div style="font-size: 0.65rem; font-weight: 800; color: ${colors.text}; font-family: Consolas, monospace; margin-bottom: 0.2rem;">${cat}</div>
                    <div style="display: flex; flex-direction: column; gap: 0.1rem;">`;

                grupos[cat].forEach(e => {
                    const isSelected = estudiosSeleccionados.some(s => s.id === e.id);
                    const isFav = esFavorito(e.id);
                    const starColor = isFav ? '#f59e0b' : '#cbd5e1';
                    const starFill = isFav ? '#f59e0b' : 'none';
                    html += `
                        <div class="estudio-row" data-estudio-id="${e.id}" 
                            style="display: flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.4rem; 
                               border-radius: 4px; font-size: 0.7rem; color: #1e293b;
                               background: ${isSelected ? '#dcfce7' : 'white'}; 
                               border: 1px solid ${isSelected ? '#22c55e' : '#e2e8f0'}; cursor: pointer;">
                            <svg class="fav-star" data-fav-id="${e.id}" width="14" height="14" viewBox="0 0 24 24" 
                                fill="${starFill}" stroke="${starColor}" stroke-width="2"
                                style="cursor: pointer; flex-shrink: 0;"
                                title="${isFav ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                style="width: 14px; height: 14px; accent-color: #22c55e; pointer-events: none; flex-shrink: 0;">
                            <span style="flex: 1; font-weight: ${isSelected ? '600' : '400'}; font-size: 0.7rem;">${e.nombre}</span>
                            <span style="font-weight: 700; color: #0f766e; font-size: 0.65rem; flex-shrink: 0;">$${parseFloat(e.precio || 0).toFixed(0)}</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            });

            container.innerHTML = html || '<div style="text-align:center; padding:2rem; color:#94a3b8;">No hay estudios disponibles</div>';

            // Event Delegation para clicks
            container.querySelectorAll('.estudio-row').forEach(row => {
                row.addEventListener('click', function (e) {
                    // Si clicke√≥ en la estrella de favoritos, no hacer toggle del estudio
                    if (e.target.closest('.fav-star')) {
                        return;
                    }
                    const id = this.dataset.estudioId; // UUID string, sin parseInt
                    toggleStudyCompact(id);
                });
            });

            container.querySelectorAll('.fav-star').forEach(star => {
                star.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const id = this.dataset.favId; // UUID string, sin parseInt
                    toggleFavorito(id, e);
                });
            });
        }

        function toggleStudyCompact(id) {
            // Buscar el estudio por ID
            const estudio = todosEstudios.find(e => e.id === id);
            if (!estudio) {
                console.error('Estudio no encontrado:', id);
                return;
            }

            // Toggle: agregar o quitar del array de seleccionados
            const index = estudiosSeleccionados.findIndex(s => s.id === id);
            if (index > -1) {
                estudiosSeleccionados.splice(index, 1);
            } else {
                estudiosSeleccionados.push(estudio);
            }

            // Recalcular total
            totalVenta = estudiosSeleccionados.reduce((sum, item) => sum + parseFloat(item.precio || 0), 0);

            // Actualizar UI compacta
            updateCompactSelectedUI();
            renderStudiesCompact(
                document.getElementById('buscarEstudioCompact')?.value?.toLowerCase() || '',
                document.getElementById('filtroCategoriaCompact')?.value || ''
            );
        }

        function updateCompactSelectedUI() {
            const container = document.getElementById('estudiosSeleccionadosCompact');
            const countEl = document.getElementById('cantidadEstudiosCompact');
            const totalEl = document.getElementById('totalVentaCompact');
            const cambioEl = document.getElementById('cambioVentaCompact');
            const subtotalEl = document.getElementById('subtotalCompact');
            const ivaEl = document.getElementById('ivaCompact');

            if (countEl) countEl.textContent = estudiosSeleccionados.length;

            // Calcular IVA: El total ya incluye IVA, desglosar
            // Total = Subtotal + IVA = Subtotal * 1.16
            // Subtotal = Total / 1.16
            const subtotal = totalVenta / 1.16;
            const iva = totalVenta - subtotal;

            if (subtotalEl) subtotalEl.textContent = subtotal.toFixed(2);
            if (ivaEl) ivaEl.textContent = iva.toFixed(2);
            if (totalEl) totalEl.textContent = totalVenta.toFixed(2);

            // Calcular cambio
            const montoPagado = parseFloat(document.getElementById('montoPagadoCompact')?.value) || 0;
            const cambio = Math.max(0, montoPagado - totalVenta);
            if (cambioEl) cambioEl.textContent = cambio.toFixed(2);

            // Renderizar tags
            if (container) {
                if (estudiosSeleccionados.length === 0) {
                    container.innerHTML = '<span style="color: #94a3b8; font-size: 0.7rem;">Ning√∫n estudio seleccionado</span>';
                } else {
                    container.innerHTML = estudiosSeleccionados.map(e => `
                        <span class="selected-tag">
                            ${e.nombre.substring(0, 20)}${e.nombre.length > 20 ? '...' : ''} 
                            <span class="remove-btn" onclick="toggleStudyCompact('${e.id}')">√ó</span>
                        </span>
                    `).join('');
                }
            }
        }

        // Override updateTotal para tambi√©n actualizar el compacto
        const originalUpdateTotal = typeof updateTotal === 'function' ? updateTotal : null;
        function updateTotalHook() {
            if (originalUpdateTotal) originalUpdateTotal();
            updateCompactSelectedUI();
        }

        // Hook into estudios loading
        const originalLoadEstudios = typeof loadEstudios === 'function' ? loadEstudios : null;


        // Normalizar nombres (Tipo Oraci√≥n: Juan Carlos)
        function normalizeInput(input) {
            const cursor = input.selectionStart;
            const value = input.value;
            // Capitalizar la primera letra de cada palabra y el resto min√∫sculas
            const normalized = value.toLowerCase().replace(/(^|\s)\S/g, l => l.toUpperCase());

            if (value !== normalized) {
                input.value = normalized;
                input.setSelectionRange(cursor, cursor);
            }
        }

        function nuevoMedico() {
            document.getElementById('doctorModal').classList.add('active');
        }

        function closeDoctorModal() {
            document.getElementById('doctorModal').classList.remove('active');
            document.getElementById('doctorForm').reset();
        }

        async function saveDoctor(event) {
            event.preventDefault();
            const nombre = document.getElementById('docNombre').value;
            const especialidad = document.getElementById('docEspecialidad').value;
            const cedula = document.getElementById('docCedula').value;
            const telefono = document.getElementById('docTelefono').value;

            try {
                const { data, error } = await supabaseClient
                    .from('medicos_referentes')
                    .insert([{
                        nombre: nombre,
                        especialidad: especialidad || null,
                        cedula: cedula || null,
                        telefono: telefono || null,
                        activo: true
                    }])
                    .select();

                if (error) throw error;

                // Actualizar lista local e input
                await loadMedicos();
                document.getElementById('medicoReferente').value = nombre;
                closeDoctorModal();

                showCustomModal({
                    title: '¬°M√©dico Agregado!',
                    message: `El Dr(a). ${nombre} ha sido registrado en el cat√°logo.`,
                    type: 'alert'
                });
            } catch (err) {
                console.error("Error saving doctor:", err);
                alert("Error al guardar m√©dico: " + err.message);
            }
        }

        // Detecci√≥n de Paciente Existente
        let lastAutoFillName = "";

        async function checkPacienteExistente() {
            const pNombre = document.getElementById('primerNombre').value.trim();
            const pApellido = document.getElementById('primerApellido').value.trim();

            // Solo buscar si ambos campos principales tienen contenido suficiente
            if (pNombre.length >= 3 && pApellido.length >= 3) {
                const fullNameKey = `${pNombre} ${pApellido}`;
                if (fullNameKey === lastAutoFillName) return;

                try {
                    const { data, error } = await supabaseClient
                        .from('citas')
                        .select('*')
                        .eq('primer_nombre', pNombre)
                        .eq('primer_apellido', pApellido)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (data && data.length > 0) {
                        const pac = data[0];

                        showCustomModal({
                            title: 'Paciente Registrado',
                            message: `Se encontr√≥ un registro previo de "${pac.paciente_nombre}". ¬øDeseas cargar sus datos (Fecha de Nacimiento, Tel√©fono, etc.) autom√°ticamente?`,
                            type: 'confirm',
                            onConfirm: () => {
                                document.getElementById('segundoNombre').value = pac.segundo_nombre || '';
                                document.getElementById('segundoApellido').value = pac.segundo_apellido || '';
                                document.getElementById('fechaNacimiento').value = pac.fecha_nacimiento || '';
                                document.getElementById('patientPhone').value = pac.paciente_telefono || '';
                                lastAutoFillName = fullNameKey;
                            },
                            onCancel: () => {
                                lastAutoFillName = fullNameKey; // Evitar volver a preguntar para este mismo nombre
                            }
                        });
                    }
                } catch (err) {
                    console.error("Error en checkPacienteExistente:", err);
                }
            }
        }

        async function loadLabConfig() {
            try {
                const { data, error } = await supabaseClient
                    .from('configuracion_laboratorio')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (data) {
                    currentLabConfig = data;
                }
            } catch (err) {
                console.error('Error loading lab config:', err);
            }
        }

        // --- Background Animation Code ---
        const canvas = document.getElementById('networkCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let formulas = [];

        // Chemistry formulas
        const chemistryFormulas = [
            'H‚ÇÇO', 'NaCl', 'CO‚ÇÇ', 'H‚ÇÇSO‚ÇÑ', 'NaOH', 'HCl', 'NH‚ÇÉ', 'C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ',
            'CaCO‚ÇÉ', 'Fe‚ÇÇO‚ÇÉ', 'KMnO‚ÇÑ', 'CH‚ÇÑ', 'C‚ÇÇH‚ÇÖOH', 'HNO‚ÇÉ', 'Na‚ÇÇCO‚ÇÉ',
            'MgCl‚ÇÇ', 'Al‚ÇÇO‚ÇÉ', 'K‚ÇÇSO‚ÇÑ', 'CuSO‚ÇÑ', 'ZnO', 'Pb(NO‚ÇÉ)‚ÇÇ', 'AgNO‚ÇÉ',
            'pH', 'ATP', 'DNA', 'RNA', 'O‚ÇÇ', 'N‚ÇÇ', 'Cl‚ÇÇ', 'H‚ÇÇ'
        ];

        // Config
        const particleCount = 60;
        const formulaCount = 20;
        const connectionDistance = 150;
        const moveSpeed = 0.5;
        const particleColor = 'rgba(144, 224, 239, 0.5)';
        const lineColor = 'rgba(72, 202, 228, 0.25)';

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            initParticles();
            initFormulas();
        }

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * moveSpeed;
                this.vy = (Math.random() - 0.5) * moveSpeed;
                this.size = Math.random() * 2.5 + 1;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = particleColor;
                ctx.fill();
            }
        }

        class Formula {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.3;
                this.vy = (Math.random() - 0.5) * 0.3;
                this.text = chemistryFormulas[Math.floor(Math.random() * chemistryFormulas.length)];
                this.fontSize = Math.random() * 14 + 12;
                this.opacity = Math.random() * 0.3 + 0.1;
                this.rotation = (Math.random() - 0.5) * 0.3;
                this.rotationSpeed = (Math.random() - 0.5) * 0.002;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += this.rotationSpeed;

                if (this.x < -50) this.x = width + 50;
                if (this.x > width + 50) this.x = -50;
                if (this.y < -50) this.y = height + 50;
                if (this.y > height + 50) this.y = -50;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.font = `${this.fontSize}px 'Roboto', monospace`;
                ctx.fillStyle = `rgba(202, 240, 248, ${this.opacity})`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.text, 0, 0);
                ctx.restore();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function initFormulas() {
            formulas = [];
            for (let i = 0; i < formulaCount; i++) {
                formulas.push(new Formula());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);

            formulas.forEach(f => {
                f.update();
                f.draw();
            });

            particles.forEach(p => {
                p.update();
                p.draw();
            });

            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < connectionDistance) {
                        ctx.beginPath();
                        ctx.strokeStyle = lineColor;
                        ctx.lineWidth = 1 - distance / connectionDistance;
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        // --- End Animation Code ---

        async function loadEstudios() {
            try {
                const { data, error } = await supabaseClient
                    .from('estudios_laboratorio')
                    .select('*')
                    .eq('activo', true)
                    .order('categoria', { ascending: true });

                if (error) throw error;
                todosEstudios = data || [];
                renderEstudiosList();
                loadCategorias();

                // NUEVO: Renderizar en layout compacto
                renderStudiesCompact();
                loadCategoriasCompact();

                // Verificar si viene de una cotizaci√≥n pendiente
                checkPendingQuotation();
            } catch (err) { console.error(err); }
        }

        function loadCategoriasCompact() {
            const select = document.getElementById('filtroCategoriaCompact');
            if (!select || !todosEstudios) return;

            // Verificar si hay perfiles en los estudios
            const hayPerfiles = todosEstudios.some(e => e.es_perfil === true);

            // Usar categor√≠as normalizadas y ordenadas - PERFILES primero
            const ordenCategorias = ['PERFILES', 'QU√çMICA CL√çNICA', 'HEMATOLOG√çA', 'INMUNOLOG√çA', 'URIAN√ÅLISIS', 'COPROLOG√çA', 'SEROLOG√çA', 'HORMONAS'];

            // Obtener categor√≠as normalizadas incluyendo PERFILES
            const categoriasEncontradas = new Set();
            todosEstudios.forEach(e => {
                if (e.es_perfil === true) {
                    categoriasEncontradas.add('PERFILES');
                } else {
                    categoriasEncontradas.add(normalizarCategoria(e.categoria));
                }
            });

            // Ordenar seg√∫n el orden definido
            const categoriasOrdenadas = [...categoriasEncontradas].sort((a, b) => {
                const idxA = ordenCategorias.indexOf(a);
                const idxB = ordenCategorias.indexOf(b);
                return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
            });

            let html = '<option value="">Todas</option>';
            categoriasOrdenadas.forEach(cat => {
                const colors = getColorCategoria(cat);
                html += `<option value="${cat}" style="background: ${colors.bg};">${cat}</option>`;
            });
            select.innerHTML = html;
        }

        // Funci√≥n para precargar datos de cotizaci√≥n
        function checkPendingQuotation() {
            try {
                const pendingQuotationStr = sessionStorage.getItem('pendingQuotation');
                if (!pendingQuotationStr) return;

                const quotation = JSON.parse(pendingQuotationStr);
                console.log('Cargando cotizaci√≥n pendiente:', quotation);

                // Precargar nombre del paciente
                if (quotation.nombre) {
                    const nombreParts = quotation.nombre.trim().split(' ');
                    if (nombreParts.length >= 1) {
                        document.getElementById('primerNombre').value = nombreParts[0] || '';
                    }
                    if (nombreParts.length >= 2) {
                        document.getElementById('segundoNombre').value = nombreParts[1] || '';
                    }
                    if (nombreParts.length >= 3) {
                        document.getElementById('primerApellido').value = nombreParts[2] || '';
                    }
                    if (nombreParts.length >= 4) {
                        document.getElementById('segundoApellido').value = nombreParts.slice(3).join(' ') || '';
                    }
                    // Si solo hay 2 partes, probablemente es nombre + apellido
                    if (nombreParts.length === 2) {
                        document.getElementById('primerApellido').value = nombreParts[1];
                        document.getElementById('segundoNombre').value = '';
                    }
                }

                // Precargar estudios
                if (Array.isArray(quotation.estudios) && quotation.estudios.length > 0) {
                    quotation.estudios.forEach(estCot => {
                        // Buscar el estudio en el cat√°logo por ID o por nombre
                        let estudio = todosEstudios.find(e => e.id === estCot.id);
                        if (!estudio) {
                            estudio = todosEstudios.find(e => e.nombre === estCot.nombre);
                        }
                        if (estudio && !estudiosSeleccionados.some(s => s.id === estudio.id)) {
                            estudiosSeleccionados.push(estudio);
                        }
                    });

                    // Actualizar vistas
                    renderEstudiosList();
                    renderEstudiosSeleccionados();
                    calcularTotal();
                }

                // Cambiar t√≠tulo si viene de cotizaci√≥n
                if (quotation.fromCotizacion) {
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle) {
                        const svg = pageTitle.querySelector('svg').outerHTML;
                        pageTitle.innerHTML = `${svg} Registro desde Cotizaci√≥n`;
                    }

                    // Mostrar notificaci√≥n
                    showCustomModal({
                        title: 'Datos Precargados',
                        message: `Se han cargado los datos de la cotizaci√≥n de "${quotation.nombre}" con ${quotation.estudios?.length || 0} estudio(s). Complete los datos faltantes y confirme el registro.`,
                        type: 'alert'
                    });
                }

                // Limpiar sessionStorage para evitar recargar en futuras visitas
                sessionStorage.removeItem('pendingQuotation');

            } catch (err) {
                console.error('Error cargando cotizaci√≥n pendiente:', err);
            }
        }

        async function loadMedicos() {
            try {
                const { data, error } = await supabaseClient
                    .from('medicos_referentes')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre', { ascending: true });

                if (error) throw error;
                todosMedicos = data || [];
                renderMedicosDatalist();
            } catch (err) { console.error(err); }
        }

        // ========== Procedencias ==========
        let todasProcedencias = [];

        async function loadProcedencias() {
            try {
                // Obtener procedencias √∫nicas de la tabla citas
                const { data, error } = await supabaseClient
                    .from('citas')
                    .select('procedencia')
                    .not('procedencia', 'is', null)
                    .order('procedencia', { ascending: true });

                if (error) throw error;

                // Extraer valores √∫nicos
                const uniqueProcedencias = [...new Set((data || []).map(c => c.procedencia).filter(Boolean))];

                // Valores predeterminados si no hay en BD
                const defaultProcedencias = ['CONSULTA EXTERNA', 'HOSPITALIZACI√ìN', 'URGENCIAS', 'LABORATORIO'];
                todasProcedencias = [...new Set([...defaultProcedencias, ...uniqueProcedencias])].sort();

                renderProcedenciasSelect();
            } catch (err) {
                console.error('Error cargando procedencias:', err);
                // Usar solo valores por defecto en caso de error
                todasProcedencias = ['CONSULTA EXTERNA', 'HOSPITALIZACI√ìN', 'URGENCIAS', 'LABORATORIO'];
                renderProcedenciasSelect();
            }
        }

        function renderProcedenciasSelect() {
            const select = document.getElementById('procedenciaCompact');
            if (!select) return;

            let html = '<option value="">Seleccionar...</option>';
            todasProcedencias.forEach(proc => {
                html += `<option value="${proc}">${proc}</option>`;
            });
            select.innerHTML = html;
        }

        function agregarNuevaProcedencia() {
            document.getElementById('procedenciaModal').classList.add('active');
            document.getElementById('nuevaProcedenciaInput').value = '';
            setTimeout(() => {
                document.getElementById('nuevaProcedenciaInput').focus();
            }, 100);
        }

        function cerrarProcedenciaModal() {
            document.getElementById('procedenciaModal').classList.remove('active');
            document.getElementById('nuevaProcedenciaInput').value = '';
        }

        function guardarNuevaProcedencia() {
            const input = document.getElementById('nuevaProcedenciaInput');
            const value = input.value;

            if (value && value.trim()) {
                const nuevaProcedencia = value.trim().toUpperCase();

                // Verificar si ya existe
                if (todasProcedencias.includes(nuevaProcedencia)) {
                    input.style.borderColor = '#ef4444';
                    input.placeholder = '¬°Ya existe esta procedencia!';
                    input.value = '';
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.placeholder = 'Ej: EMERGENCIAS';
                    }, 2000);
                    return;
                }

                // Agregar a la lista local
                todasProcedencias.push(nuevaProcedencia);
                todasProcedencias.sort();
                renderProcedenciasSelect();

                // Seleccionar autom√°ticamente la nueva procedencia
                const select = document.getElementById('procedenciaCompact');
                if (select) {
                    select.value = nuevaProcedencia;
                    syncField('procedencia', nuevaProcedencia);
                }

                cerrarProcedenciaModal();
            }
        }


        function loadCategorias() {
            const categorias = [...new Set(todosEstudios.map(e => e.categoria))].sort();
            const select = document.getElementById('filtroCategoria');
            categorias.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }



        // Wrapper para llamar desde el onchange del checkbox
        function applyFilters() {
            renderEstudiosList(
                document.getElementById('buscarEstudio').value,
                document.getElementById('filtroCategoria').value
            );
        }

        function renderEstudiosList(filtro = '', categoria = '') {
            const container = document.getElementById('listaEstudios');
            let estudiosFiltrados = todosEstudios.filter(e => {
                const nombre = e.nombre || '';
                const matchNombre = nombre.toLowerCase().includes(filtro.toLowerCase());
                const matchCategoria = !categoria || e.categoria === categoria;

                // Nuevo filtro: Ocultar precio 0 si no est√° marcado el checkbox
                const mostrarOcultos = document.getElementById('verComponentesOcultos')?.checked || false;
                const matchPrecio = mostrarOcultos || parseFloat(e.precio) > 0 || e.es_perfil;

                return matchNombre && matchCategoria && matchPrecio;
            });

            if (estudiosFiltrados.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;">No se encontraron estudios</div>';
                return;
            }

            // Agrupar por categor√≠a
            const grupos = {};

            // Agregar grupo de favoritos si aplica
            const frecuentes = estudiosFiltrados.filter(e => e.es_frecuente);
            if (frecuentes.length > 0 && !filtro && !categoria) {
                grupos['‚≠ê FRECUENTES'] = frecuentes;
            }

            estudiosFiltrados.forEach(e => {
                if (!grupos[e.categoria]) grupos[e.categoria] = [];
                grupos[e.categoria].push(e);
            });

            let html = '';

            // Ordenar categor√≠as, poniendo favoritos primero
            const catKeys = Object.keys(grupos).sort((a, b) => {
                if (a === '‚≠ê FRECUENTES') return -1;
                if (b === '‚≠ê FRECUENTES') return 1;
                return a.localeCompare(b);
            });

            catKeys.forEach(cat => {
                html += `
                    <div class="category-group" style="margin-bottom: 0.5rem;">
                        <div class="category-title" style="font-size: 0.7rem; font-weight: 700; color: #475569; padding: 0.25rem 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 0.3rem;">
                            ${cat}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.2rem;">
                `;

                grupos[cat].forEach(est => {
                    const isSelected = estudiosSeleccionados.some(s => s.id === est.id);
                    html += `
                        <label class="estudio-checkbox-item" 
                            onclick="toggleEstudio('${est.id}')" 
                            style="display: flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.4rem; cursor: pointer; 
                                   border-radius: 4px; font-size: 0.7rem; color: #1e293b;
                                   background: ${isSelected ? '#dcfce7' : '#f8fafc'}; 
                                   border: 1px solid ${isSelected ? '#22c55e' : '#e2e8f0'};
                                   transition: all 0.15s ease;"
                            onmouseover="this.style.background='${isSelected ? '#bbf7d0' : '#f1f5f9'}'"
                            onmouseout="this.style.background='${isSelected ? '#dcfce7' : '#f8fafc'}'">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                style="width: 14px; height: 14px; accent-color: #22c55e; pointer-events: none; cursor: pointer;">
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; font-weight: ${isSelected ? '600' : '400'};">${est.nombre}</span>
                        </label>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleEstudio(id) {
            const estudio = todosEstudios.find(e => e.id === id);
            if (!estudio) return;

            const index = estudiosSeleccionados.findIndex(s => s.id === id);
            if (index > -1) {
                estudiosSeleccionados.splice(index, 1);
            } else {
                estudiosSeleccionados.push(estudio);
            }

            renderEstudiosList(
                document.getElementById('buscarEstudio').value,
                document.getElementById('filtroCategoria').value
            );
            renderEstudiosSeleccionados();
            calcularTotal();
        }

        function renderEstudiosSeleccionados() {
            const container = document.getElementById('estudiosSeleccionados');

            if (estudiosSeleccionados.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #94a3b8; width: 100%;">Ning√∫n estudio seleccionado</div>';
                return;
            }

            let html = '';
            estudiosSeleccionados.forEach((est, index) => {
                const precio = parseFloat(est.precio || 0).toFixed(2);
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: white; padding: 0.4rem 0.75rem; border-radius: 20px; border: 1px solid var(--primary-light); font-size: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <span style="font-weight: 600; color: var(--text-dark);">${est.nombre}</span>
                        <span style="color: var(--primary-dark); font-weight: 700;">$${precio}</span>
                        <button type="button" onclick="toggleEstudio('${est.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; display: flex; align-items: center; padding: 0; margin-left: 2px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }



        function renderMedicosDatalist() {
            // Set default if empty
            const input = document.getElementById('medicoReferente');
            if (!input.value) input.value = 'A Quien Corresponda';
        }

        // ========== Doctor Selector Modal Functions ==========
        function openDoctorSelectorModal() {
            const modal = document.getElementById('doctorSelectorModal');
            modal.classList.add('active');
            document.getElementById('doctorSearchInput').value = '';
            renderDoctorList();
            setTimeout(() => document.getElementById('doctorSearchInput').focus(), 100);
        }

        function closeDoctorSelectorModal() {
            document.getElementById('doctorSelectorModal').classList.remove('active');
        }

        function renderDoctorList(filter = '') {
            const container = document.getElementById('doctorListContainer');
            const currentValue = document.getElementById('medicoReferente').value;

            // Filtrar m√©dicos
            let filteredDoctors = todosMedicos.filter(med => {
                const nombre = med.nombre || '';
                return nombre.toLowerCase().includes(filter.toLowerCase());
            });

            // Agregar "A Quien Corresponda" al inicio si coincide con el filtro
            const defaultOption = { id: null, nombre: 'A Quien Corresponda', especialidad: 'Referencia General' };
            if ('a quien corresponda'.includes(filter.toLowerCase()) || filter === '') {
                filteredDoctors = [defaultOption, ...filteredDoctors.filter(m => m.nombre !== 'A Quien Corresponda')];
            }

            // Actualizar badge de conteo
            document.getElementById('doctorCountBadge').textContent = filteredDoctors.length;

            if (filteredDoctors.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #94a3b8;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; display: block; opacity: 0.5;">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        No se encontraron m√©dicos con ese nombre
                    </div>
                `;
                return;
            }

            let html = '';
            filteredDoctors.forEach(med => {
                const isSelected = med.nombre === currentValue;
                html += `
                    <div class="doctor-list-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectDoctor('${med.nombre.replace(/'/g, "\\'")}', '${med.id || ''}')">
                        <div>
                            <div class="doctor-name">${med.nombre}</div>
                            ${med.especialidad ? `<div class="doctor-specialty">${med.especialidad}</div>` : ''}
                        </div>
                        ${isSelected ? `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterDoctorList() {
            const filter = document.getElementById('doctorSearchInput').value;
            renderDoctorList(filter);
        }

        function selectDoctor(nombre, id) {
            document.getElementById('medicoReferente').value = nombre;
            document.getElementById('medicoReferenteId').value = id || '';
            // Tambi√©n actualizar el campo compact de Venta Directa
            const medicoCompact = document.getElementById('medicoReferenteCompact');
            if (medicoCompact) medicoCompact.value = nombre;
            closeDoctorSelectorModal();
        }

        function setupEstudioSearch() {
            document.getElementById('buscarEstudio').addEventListener('input', (e) => {
                renderEstudiosList(e.target.value, document.getElementById('filtroCategoria').value);
            });
            document.getElementById('filtroCategoria').addEventListener('change', (e) => {
                renderEstudiosList(document.getElementById('buscarEstudio').value, e.target.value);
            });
        }

        function calcularTotal() {
            totalVenta = estudiosSeleccionados.reduce((sum, item) => sum + parseFloat(item.precio || 0), 0);
            document.getElementById('totalVenta').textContent = totalVenta.toFixed(2);
            document.getElementById('cantidadEstudiosVenta').textContent = estudiosSeleccionados.length;
            calcularCambio();
        }

        function selectPaymentMethod(method, element) {
            metodoPagoActual = method;

            // UI Toggle
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));
            element.classList.add('active');

            // Show/Hide Comprobante section (form original)
            const section = document.getElementById('comprobanteSection');
            const montoGroup = document.getElementById('montoRecibidoGroup');
            const montoGroupCompact = document.getElementById('montoRecibidoGroupCompact');
            const montoInput = document.getElementById('montoPagado');
            const montoCompact = document.getElementById('montoPagadoCompact');

            if (method === 'tarjeta' || method === 'transferencia') {
                // En tarjeta/transferencia el monto pagado es el total exacto
                if (section) section.style.display = 'block';
                if (montoGroup) montoGroup.style.display = 'none';
                if (montoGroupCompact) montoGroupCompact.style.display = 'none';
                if (montoInput) montoInput.value = totalVenta.toFixed(2);
                if (montoCompact) montoCompact.value = totalVenta.toFixed(2);
                montoPagado = totalVenta;
                // Abrir modal de comprobante para subir captura
                abrirModalComprobante();
            } else {
                // EFECTIVO - mostrar campo de monto y auto-rellenar con el total
                if (section) section.style.display = 'none';
                if (montoGroup) montoGroup.style.display = 'block';
                if (montoGroupCompact) montoGroupCompact.style.display = 'flex';
                if (montoInput) montoInput.value = totalVenta.toFixed(2);
                if (montoCompact) montoCompact.value = totalVenta.toFixed(2);
                montoPagado = totalVenta;
            }

            calcularCambio();
            updateCompactSelectedUI();
        }

        // ====== Modal de Alerta Personalizado ======
        function mostrarAlerta(mensaje, titulo = 'Atenci√≥n', tipo = 'warning') {
            const modal = document.getElementById('customAlertModal');
            const icono = document.getElementById('customAlertIcon');
            const tituloEl = document.getElementById('customAlertTitle');
            const mensajeEl = document.getElementById('customAlertMessage');

            // Configurar estilos seg√∫n el tipo
            const estilos = {
                warning: { bg: '#fef3c7', color: '#f59e0b', icono: 'alert' },
                error: { bg: '#fee2e2', color: '#ef4444', icono: 'error' },
                success: { bg: '#dcfce7', color: '#22c55e', icono: 'check' },
                info: { bg: '#dbeafe', color: '#3b82f6', icono: 'info' }
            };

            const estilo = estilos[tipo] || estilos.warning;
            icono.style.background = estilo.bg;
            icono.style.color = estilo.color;

            tituloEl.textContent = titulo;
            mensajeEl.textContent = mensaje;

            modal.classList.add('active');
        }

        function cerrarCustomAlert() {
            document.getElementById('customAlertModal').classList.remove('active');
        }

        // ====== Modal para subir comprobante de transferencia/dep√≥sito ======
        let comprobanteImagenUrl = null;

        function abrirModalComprobante() {
            document.getElementById('modalComprobante').classList.add('active');
        }

        function cerrarModalComprobante() {
            document.getElementById('modalComprobante').classList.remove('active');
        }

        async function subirComprobante() {
            const fileInput = document.getElementById('comprobanteFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                mostrarAlerta('Por favor selecciona una imagen del comprobante');
                return;
            }

            const file = fileInput.files[0];

            // Obtener nombre del paciente
            const nombrePaciente = document.getElementById('pacienteNombreCompact')?.value ||
                document.getElementById('pacienteNombre')?.value ||
                'SIN_NOMBRE';

            // Sanitizar nombre del paciente (quitar acentos, espacios y caracteres especiales)
            const nombreSanitizado = nombrePaciente
                .toUpperCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Quitar acentos
                .replace(/\s+/g, '_') // Espacios a guiones bajos
                .replace(/[^A-Z0-9_]/g, ''); // Solo letras, n√∫meros y _

            // Obtener fecha y hora actual
            const ahora = new Date();
            const fecha = `${ahora.getFullYear()}${String(ahora.getMonth() + 1).padStart(2, '0')}${String(ahora.getDate()).padStart(2, '0')}`;
            const hora = `${String(ahora.getHours()).padStart(2, '0')}${String(ahora.getMinutes()).padStart(2, '0')}${String(ahora.getSeconds()).padStart(2, '0')}`;

            // Obtener extensi√≥n del archivo original
            const extension = file.name.split('.').pop().toLowerCase();

            // Crear nombre final: comprobante_NOMBRECLIENTE_20260125_131234.jpg
            const fileName = `comprobante_${nombreSanitizado}_${fecha}_${hora}.${extension}`;
            console.log('Nombre generado:', fileName);

            // Mostrar loading
            const btnSubir = document.querySelector('#modalComprobante .btn-confirm');
            const previewModal = document.getElementById('comprobantePreviewModal');
            const originalBtnText = btnSubir.textContent;
            btnSubir.disabled = true;
            btnSubir.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"/></svg> Subiendo...</span>';
            previewModal.innerHTML = '<div style="text-align: center; color: #0d9488; font-size: 0.8rem; padding: 1rem;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; margin: 0 auto;"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"/></svg><br>Subiendo archivo...</div>';

            try {
                // Primero intentar subir a Supabase Storage - bucket: comprobantes
                const { data, error } = await supabaseClient.storage
                    .from('comprobantes')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    // Si el bucket no existe o hay error, guardar como base64
                    console.warn('Storage error, guardando como base64:', error.message);
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        comprobanteImagenUrl = e.target.result; // base64

                        previewModal.innerHTML = `
                            <div style="background: white; padding: 0.75rem; border-radius: 8px; border: 2px solid #22c55e;">
                                <img src="${comprobanteImagenUrl}" alt="Comprobante" style="max-width: 100%; max-height: 120px; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="color: #22c55e; font-size: 0.75rem;">‚úì Comprobante guardado</div>
                            </div>
                        `;
                        btnSubir.disabled = false;
                        btnSubir.textContent = originalBtnText;
                        setTimeout(cerrarModalComprobante, 1000);
                    };
                    reader.readAsDataURL(file);
                    return;
                }

                // Obtener URL p√∫blica
                const { data: urlData } = supabaseClient.storage
                    .from('comprobantes')
                    .getPublicUrl(fileName);

                comprobanteImagenUrl = urlData.publicUrl;

                // Mostrar preview exitoso
                previewModal.innerHTML = `
                    <div style="background: white; padding: 0.75rem; border-radius: 8px; border: 2px solid #22c55e;">
                        <img src="${comprobanteImagenUrl}" alt="Comprobante" style="max-width: 100%; max-height: 120px; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="color: #22c55e; font-size: 0.75rem;">‚úì Subido a la nube</div>
                    </div>
                `;

                btnSubir.disabled = false;
                btnSubir.textContent = originalBtnText;
                setTimeout(cerrarModalComprobante, 1000);
            } catch (err) {
                console.error('Error subiendo comprobante:', err);
                // Fallback a base64
                const reader = new FileReader();
                reader.onload = function (e) {
                    comprobanteImagenUrl = e.target.result;
                    previewModal.innerHTML = `
                        <div style="background: white; padding: 0.75rem; border-radius: 8px; border: 2px solid #f59e0b;">
                            <img src="${comprobanteImagenUrl}" alt="Comprobante" style="max-width: 100%; max-height: 120px; border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="color: #f59e0b; font-size: 0.75rem;">‚úì Guardado localmente</div>
                        </div>
                    `;
                    btnSubir.disabled = false;
                    btnSubir.textContent = originalBtnText;
                    setTimeout(cerrarModalComprobante, 1000);
                };
                reader.readAsDataURL(file);
            }
        }

        function previewComprobante(input) {
            console.log('previewComprobante llamado', input);
            const uploadArea = document.getElementById('uploadArea');
            const previewDiv = document.getElementById('comprobantePreviewModal');

            if (!uploadArea) {
                console.error('uploadArea NO encontrado');
                return;
            }
            if (!previewDiv) {
                console.error('comprobantePreviewModal NO encontrado');
                return;
            }

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(1); // KB

                // Cambiar estilo del √°rea de upload
                uploadArea.style.borderColor = '#22c55e';
                uploadArea.style.background = '#f0fdf4';

                // Mostrar loading temporal
                previewDiv.innerHTML = `
                    <div style="color: #0d9488; font-size: 0.8rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; margin: 0 auto; display: block;">
                            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                            <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"/>
                        </svg>
                        Cargando preview...
                    </div>
                `;

                const reader = new FileReader();
                reader.onload = function (e) {
                    console.log('Archivo cargado exitosamente, mostrando preview');
                    previewDiv.innerHTML = `
                        <div style="background: white; padding: 0.75rem; border-radius: 8px; border: 2px solid #22c55e;">
                            <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-bottom: 0.5rem; display: block; margin-left: auto; margin-right: auto;">
                            <div style="text-align: left; font-size: 0.7rem;">
                                <div style="color: #22c55e; font-weight: 600; margin-bottom: 0.25rem;">‚úì Archivo listo para subir</div>
                                <div style="color: #64748b; font-size: 0.65rem;">üìÑ ${fileName}</div>
                                <div style="color: #94a3b8; font-size: 0.65rem;">üìä ${fileSize} KB</div>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        function calcularCambio() {
            // Obtener el monto de cualquiera de los dos inputs (compact o original)
            const montoInput = document.getElementById('montoPagado');
            const montoInputCompact = document.getElementById('montoPagadoCompact');

            // Usar el que tenga valor
            const montoValueOrig = parseFloat(montoInput?.value) || 0;
            const montoValueCompact = parseFloat(montoInputCompact?.value) || 0;
            montoPagado = montoValueCompact || montoValueOrig;

            cambioVenta = montoPagado - totalVenta;

            // Actualizar el cambio en ambos elementos
            const cambioEl = document.getElementById('cambioVenta');
            const cambioElCompact = document.getElementById('cambioVentaCompact');

            if (cambioEl) {
                cambioEl.textContent = cambioVenta.toFixed(2);
                if (cambioVenta < 0) cambioEl.style.color = '#ef4444';
                else cambioEl.style.color = '#0f766e';
            }

            if (cambioElCompact) {
                cambioElCompact.textContent = cambioVenta.toFixed(2);
                if (cambioVenta < 0) cambioElCompact.style.color = '#ef4444';
                else cambioElCompact.style.color = '#0f766e';
            }
        }

        // --- Manual Study Functions ---
        function abrirModalEstudioManual() {
            document.getElementById('modalEstudioManual').style.display = 'flex';
            document.getElementById('manualNombre').focus();
        }

        function cerrarModalEstudioManual() {
            document.getElementById('modalEstudioManual').style.display = 'none';
            document.getElementById('manualNombre').value = '';
            document.getElementById('manualPrecio').value = '';
        }

        function agregarEstudioManual() {
            const nombre = document.getElementById('manualNombre').value.trim();
            const precio = parseFloat(document.getElementById('manualPrecio').value) || 0;

            if (!nombre) {
                alert('Ingrese el nombre del estudio');
                return;
            }

            const estudioManual = {
                id: 'manual-' + Date.now(),
                nombre: nombre + ' (Manual)',
                precio: precio,
                categoria: 'MANUAL',
                codigo: 'MANUAL',
                indicaciones: 'Estudio a√±adido manualmente'
            };

            estudiosSeleccionados.push(estudioManual);
            cerrarModalEstudioManual();
            renderEstudiosList(
                document.getElementById('buscarEstudio').value,
                document.getElementById('filtroCategoria').value
            );
            renderEstudiosSeleccionados();
            calcularTotal();
        }

        function generateTicket(citaData, folio) {
            const fecha = new Date().toLocaleString('es-MX');
            const paciente = citaData.paciente_nombre;
            const medicoStr = document.getElementById('medicoReferente').value;
            const medico = medicoStr ? medicoStr : 'Particular / Referencia General';
            const metodoPago = metodoPagoActual.toUpperCase();

            // QR Code API (using QR Server)
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=Folio:${folio}|Paciente:${paciente}`;

            const itemsHtml = estudiosSeleccionados.map(est => `
                <tr>
                    <td style="padding: 5px 0;">${est.nombre}</td>
                    <td style="text-align: right;">$${parseFloat(est.precio).toFixed(2)}</td>
                </tr>
                <tr>
                    <td colspan="2" style="font-size: 13px; color: #000; padding: 6px 8px; line-height: 1.4; background: #f5f5f5; border-left: 3px solid #d97706; margin-bottom: 8px;">
                        <strong style="font-size: 14px;">‚ö†Ô∏è Indicaciones:</strong><br>
                        <strong style="font-size: 13px;">${est.indicaciones || 'Sin indicaciones especiales.'}</strong>
                    </td>
                </tr>
            `).join('');

            const ticketWindow = window.open('', 'PRINT', 'height=700,width=450');

            ticketWindow.document.write(`
                <html>
                <head>
                    <title>Ticket #${folio} - Ar Lab</title>
                    <style>
                        body { font-family: 'Courier New', monospace; font-size: 12px; max-width: 350px; margin: 0 auto; padding: 20px; color: #000; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .logo-img { max-width: 150px; margin-bottom: 10px; }
                        .lab-name { font-size: 22px; font-weight: bold; color: #0f766e; }
                        .info { margin-bottom: 15px; border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; }
                        table { width: 100%; border-collapse: collapse; }
                        .totals { border-top: 2px solid black; margin-top: 10px; padding-top: 10px; }
                        .qr-container { text-align: center; margin: 20px 0; }
                        .footer { text-align: center; margin-top: 20px; font-size: 10px; border-top: 1px solid #ccc; padding-top: 10px;}
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="arlab_logo.png" class="logo-img" onerror="this.style.display='none'">
                        <div class="lab-name">${currentLabConfig.nombre_laboratorio}</div>
                        <div style="margin-top:5px; font-weight:bold;">LABORATORIO CL√çNICO</div>
                        <div>Folio: #${folio}</div>
                        <div>${fecha}</div>
                    </div>
                    
                    <div class="info">
                        <strong>PACIENTE:</strong> ${paciente}<br>
                        <strong>M√âDICO:</strong> ${medico}<br>
                        <strong>PAGO:</strong> ${metodoPago}
                    </div>

                    <table>
                        <thead>
                            <tr style="border-bottom: 1px solid black;">
                                <th style="text-align: left;">CONCEPTO</th>
                                <th style="text-align: right;">IMPORTE</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div class="totals">
                        <table>
                            <tr>
                                <td><strong>NETO A PAGAR:</strong></td>
                                <td style="text-align: right;"><strong>$${totalVenta.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td>EFECTIVO/PAGO:</td>
                                <td style="text-align: right;">$${montoPagado.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>CAMBIO:</td>
                                <td style="text-align: right;">$${cambioVenta.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="qr-container">
                        <img src="${qrUrl}" alt="QR Code">
                        <div style="font-size: 9px; margin-top: 5px;">Escanea para validar folio</div>
                    </div>

                    <div class="footer">
                        <p><strong>GRACIAS POR SU CONFIANZA</strong></p>
                        <p>${currentLabConfig.responsable_sanitario} - C√©d. Prof. ${currentLabConfig.cedula_profesional}</p>
                        <p>Atenci√≥n: ${currentLabConfig.telefono}</p>
                        <p>${currentLabConfig.direccion}</p>
                    </div>

                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #0d9488; color: white; border: none; border-radius: 5px; cursor: pointer;">Imprimir Ticket</button>
                    </div>
                </body>
                </html>
            `);
            ticketWindow.document.close();
        }

        async function sendWhatsAppMessage(citaData, folio) {
            const telefono = citaData.paciente_telefono.replace(/\D/g, '');
            if (!telefono) {
                alert('El paciente no tiene un n√∫mero de tel√©fono v√°lido.');
                return;
            }

            // Formatear datos para el mensaje
            const fechaObj = new Date(citaData.fecha_hora);
            const fechaLegible = fechaObj.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const horaLegible = fechaObj.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: true });
            const pacienteNombre = citaData.paciente_nombre.split(' ')[0]; // Solo primer nombre

            // Construir lista de estudios y sus indicaciones
            let estudiosLista = "";
            let indicacionesSet = new Set();

            estudiosSeleccionados.forEach(est => {
                estudiosLista += `‚Ä¢ ${est.nombre}\n`;
                if (est.indicaciones && est.indicaciones.trim() !== '' && est.indicaciones !== 'Sin indicaciones') {
                    indicacionesSet.add(est.indicaciones.trim());
                }
            });

            let indicacionesTexto = "";
            if (indicacionesSet.size > 0) {
                indicacionesTexto = "\n‚ö†Ô∏è *Indicaciones Generales:*\n";
                indicacionesSet.forEach(ind => {
                    indicacionesTexto += `‚Ä¢ ${ind}\n`;
                });
            } else {
                indicacionesTexto = "\n‚ö†Ô∏è *Indicaciones:* Sin indicaciones especiales.\n";
            }

            // Construir mensaje estructurado
            const mensaje = `üëã Hola *${pacienteNombre}*, confirmamos tu cita en *${currentLabConfig.nombre_laboratorio}*.\n\n` +
                `‚úÖ *Detalles de la Cita:*\n` +
                `üìÖ Fecha: ${fechaLegible}\n` +
                `‚è∞ Hora: ${horaLegible}\n\n` +
                `üî¨ *Estudios Solicitados:*\n${estudiosLista}` +
                `${indicacionesTexto}\n` +
                `üìç *Ubicaci√≥n:*\n${currentLabConfig.direccion}\n\n` +
                `üìû Tel: ${currentLabConfig.telefono}\n\n` +
                `¬°Te esperamos!`;

            // Codificar y abrir WhatsApp
            const waUrl = `https://wa.me/52${telefono}?text=${encodeURIComponent(mensaje)}`;
            window.open(waUrl, '_blank');

            // Redirigir al dashboard despu√©s de abrir WhatsApp
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }

        // Funci√≥n captureAndShareTicket eliminada/reemplazada por la l√≥gica de texto anterior


        /* Modal Functionality */
        function showCustomModal({ title, message, type = 'alert', onConfirm, onCancel }) {
            const overlay = document.getElementById('customModal');
            const titleEl = overlay.querySelector('.modal-title');
            const messageEl = overlay.querySelector('.modal-message');
            const btnConfirm = overlay.querySelector('.btn-confirm');
            const btnCancel = overlay.querySelector('.btn-cancel');

            titleEl.textContent = title;
            messageEl.textContent = message;
            btnCancel.style.display = type === 'confirm' ? 'block' : 'none';
            btnConfirm.textContent = type === 'confirm' ? 'Aceptar' : 'Entendido';

            overlay.classList.add('active');

            const close = () => {
                overlay.classList.remove('active');
            };

            btnConfirm.onclick = () => {
                close();
                if (onConfirm) onConfirm();
            };

            btnCancel.onclick = () => {
                close();
                if (onCancel) onCancel();
            };
        }

        async function saveAppointment(event) {
            event.preventDefault();

            if (estudiosSeleccionados.length === 0) {
                showCustomModal({
                    title: 'Atenci√≥n',
                    message: 'Debe seleccionar al menos un estudio para continuar.',
                    type: 'alert'
                });
                return;
            }

            const proceedSaving = async () => {
                const date = document.getElementById('appointmentDate').value;
                const time = document.getElementById('appointmentTime').value;
                const fechaHora = `${date}T${time}:00`;

                const primerNombre = document.getElementById('primerNombre').value;
                const segundoNombre = document.getElementById('segundoNombre').value || '';
                const primerApellido = document.getElementById('primerApellido').value;
                const segundoApellido = document.getElementById('segundoApellido').value || '';
                const nombreCompleto = `${primerNombre} ${segundoNombre} ${primerApellido} ${segundoApellido}`.replace(/\s+/g, ' ').trim();
                const medicoActual = document.getElementById('medicoReferente').value;
                const folioVenta = Math.floor(Date.now() / 1000);
                const expedienteNumero = document.getElementById('expedienteNumero').value;
                const servicio = document.getElementById('servicioHospital').value;
                const piso = document.getElementById('pisoHospital').value;
                const cama = document.getElementById('camaHabitacion').value;
                const procedencia = document.getElementById('procedenciaCompact')?.value || 'CONSULTA EXTERNA';

                const appointmentData = {
                    paciente_nombre: nombreCompleto,
                    paciente_telefono: document.getElementById('patientPhone').value,
                    fecha_hora: fechaHora,
                    tipo_servicio: 'laboratorio',
                    notas: (document.getElementById('diagnostico').value || '') + (cama ? ` | Cama: ${cama}` : ''),
                    estado: 'pendiente',
                    primer_nombre: primerNombre,
                    segundo_nombre: segundoNombre || null,
                    primer_apellido: primerApellido,
                    segundo_apellido: segundoApellido || null,
                    fecha_nacimiento: document.getElementById('fechaNacimiento').value,
                    paciente_sexo: document.getElementById('pacienteSexo').value,
                    diagnostico: document.getElementById('diagnostico').value || null,
                    total: totalVenta,
                    subtotal: (totalVenta / 1.16).toFixed(2), // Subtotal sin IVA
                    pagado: montoPagado,
                    metodo_pago: metodoPagoActual,
                    folio_venta: folioVenta,
                    medico_referente_nombre: medicoActual,
                    medico_nombre: medicoActual, // Tambi√©n guardamos en la nueva columna
                    operador_pago: currentUser ? (currentUser.nombre || currentUser.email) : 'S/I',
                    creado_por: currentUser ? currentUser.id : null,
                    expediente_numero: expedienteNumero || null,
                    // Usar el valor del dropdown de procedencia
                    procedencia: procedencia || 'CONSULTA EXTERNA',
                    // Default servicio to Laboratorio since we don't have a specific input, or user can update later
                    servicio: 'LABORATORIO',
                    cama: cama || null, // Now saving to own column
                    piso: piso || null
                };

                // Nota: Los campos de comprobante se guardan por separado si es necesario
                // (comprobante_notas, comprobante_comentarios, comprobante_url no existen en tabla citas)

                try {
                    const { data, error } = await supabaseClient
                        .from('citas')
                        .insert([appointmentData])
                        .select();

                    if (error) throw error;
                    const citaId = data[0].id;

                    const estudiosRel = estudiosSeleccionados.map(est => ({
                        cita_id: citaId,
                        estudio_id: est.id
                    }));

                    await supabaseClient.from('citas_estudios').insert(estudiosRel);

                    // Verificar si el m√©dico es nuevo y guardarlo en el cat√°logo
                    const esMedicoNuevo = !todosMedicos.some(m => m.nombre.toLowerCase() === medicoActual.toLowerCase());
                    if (esMedicoNuevo && medicoActual !== 'A Quien Corresponda' && medicoActual.trim() !== '') {
                        await supabaseClient.from('medicos_referentes').insert([{
                            nombre: medicoActual,
                            activo: true
                        }]);
                    }

                    // Actions after success
                    generateTicket(appointmentData, folioVenta);

                    // Check if in direct mode (venta directa)
                    const urlParams = new URLSearchParams(window.location.search);
                    const isDirectMode = urlParams.get('mode') === 'directo';

                    // Removed setTimeout for immediate feedback
                    if (isDirectMode) {
                        // In direct mode, just show success and go to dashboard
                        showCustomModal({
                            title: '¬°Venta Registrada!',
                            message: 'El paciente ha sido registrado exitosamente.',
                            type: 'alert',
                            onConfirm: () => {
                                setTimeout(() => {
                                    window.location.href = 'dashboard.html';
                                }, 500);
                            }
                        });
                    } else {
                        // In appointment mode, ask about WhatsApp
                        showCustomModal({
                            title: '¬°Cita Guardada!',
                            message: '¬øDeseas enviar la confirmaci√≥n por WhatsApp al paciente?',
                            type: 'confirm',
                            onConfirm: () => {
                                sendWhatsAppMessage(appointmentData, folioVenta);
                                // La redirecci√≥n ocurrir√° despu√©s de enviar el mensaje
                            },
                            onCancel: () => {
                                window.location.href = 'dashboard.html';
                            }
                        });
                    }


                } catch (err) {
                    console.error('Error saving:', err);
                    showCustomModal({
                        title: 'Error',
                        message: 'No se pudo guardar la cita: ' + err.message,
                        type: 'alert'
                    });
                }
            };

            // Para tarjeta y transferencia, el monto siempre es el total (pago completo asumido)
            if (metodoPagoActual === 'tarjeta' || metodoPagoActual === 'transferencia') {
                montoPagado = totalVenta;
                const montoInput = document.getElementById('montoPagado');
                const montoCompact = document.getElementById('montoPagadoCompact');
                if (montoInput) montoInput.value = totalVenta.toFixed(2);
                if (montoCompact) montoCompact.value = totalVenta.toFixed(2);
            }

            if (montoPagado < totalVenta) {
                showCustomModal({
                    title: 'Verificaci√≥n de Pago',
                    message: `El monto pagado ($${montoPagado}) es menor al total ($${totalVenta}). ¬øDeseas registrar la cita con deuda?`,
                    type: 'confirm',
                    onConfirm: proceedSaving
                });
            } else {
                proceedSaving();
            }
        }

        /* --- LOGIC TO LOAD PENDING QUOTATION --- */
        async function checkPendingQuotation() {
            const dataStr = sessionStorage.getItem('pendingQuotation');
            if (!dataStr) return;

            console.log("Found pending quotation data...", dataStr);

            try {
                const data = JSON.parse(dataStr);
                // Clear it so it doesn't reappear on reload unless desired
                // sessionStorage.removeItem('pendingQuotation'); 

                // 1. Fill Patient (Basic heuristic)
                if (data.nombre) {
                    const parts = data.nombre.trim().split(/\s+/);
                    if (parts.length > 0) document.getElementById('primerNombre').value = parts[0];
                    if (parts.length > 1) document.getElementById('primerApellido').value = parts[1];
                    if (parts.length > 2) document.getElementById('segundoApellido').value = parts.slice(2).join(' '); // A bit rough but works

                    document.getElementById('primerNombre').dispatchEvent(new Event('input'));
                }

                // 2. Fill Studies
                let attempts = 0;
                const maxAttempts = 50; // 10 seconds max

                const waitForEstudios = setInterval(() => {
                    attempts++;
                    if (typeof todosEstudios !== 'undefined' && todosEstudios.length > 0) {
                        clearInterval(waitForEstudios);
                        processPendingStudies(data.estudios);
                        sessionStorage.removeItem('pendingQuotation'); // Remove after successful load
                    } else if (attempts > maxAttempts) {
                        clearInterval(waitForEstudios);
                        console.warn("Timeout waiting for studies to load for quotation");
                    }
                }, 200);

            } catch (e) {
                console.error("Error creating appointment from quote", e);
            }
        }

        function processPendingStudies(quotedStudies) {
            if (!quotedStudies || !Array.isArray(quotedStudies)) return;

            // Clear current selection just in case
            estudiosSeleccionados = [];
            renderEstudiosSeleccionados();

            quotedStudies.forEach(qs => {
                const full = todosEstudios.find(e => e.id === qs.id || e.nombre === qs.nombre);
                if (full) {
                    toggleEstudio(full.id);
                }
            });

            showCustomModal({
                title: 'Cotizaci√≥n Cargada',
                message: 'Se han cargado los datos de la cotizaci√≥n seleccionada.',
                type: 'alert'
            });
        }

        // Initialize check
        document.addEventListener('DOMContentLoaded', checkPendingQuotation);

    </script>

    <!-- Custom Modal HTML -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 16v-4M12 8h.01" />
                </svg>
            </div>
            <h3 class="modal-title">T√≠tulo</h3>
            <p class="modal-message">Mensaje de notificaci√≥n.</p>
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel">Cancelar</button>
                <button type="button" class="btn-modal btn-confirm">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Doctor Selector Modal (Lista completa de m√©dicos) -->
    <div id="doctorSelectorModal" class="modal-overlay">
        <div class="modal-content doctor-selector-modal">
            <div class="modal-icon" style="background: #f0fdfa; color: var(--primary);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="8.5" cy="7" r="4" />
                    <polyline points="17 11 19 13 23 9" />
                </svg>
            </div>
            <h3 class="modal-title" style="text-align: center;">Seleccionar M√©dico Referente</h3>

            <input type="text" id="doctorSearchInput" class="doctor-search-box"
                placeholder="Buscar m√©dico por nombre..." oninput="filterDoctorList()">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-size: 0.85rem; color: #64748b;">M√©dicos registrados</span>
                <span class="doctor-count-badge" id="doctorCountBadge">0</span>
            </div>

            <div class="doctor-list-container" id="doctorListContainer">
                <!-- Lista de m√©dicos se carga din√°micamente -->
            </div>

            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn-modal btn-cancel"
                    onclick="closeDoctorSelectorModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Doctor Modal HTML -->
    <div id="doctorModal" class="modal-overlay">
        <div class="modal-content doctor-modal-content">
            <div class="modal-icon" style="background: #fff7ed; color: #f59e0b;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="8.5" cy="7" r="4" />
                    <line x1="18" y1="8" x2="23" y2="13" />
                    <line x1="23" y1="8" x2="18" y2="13" />
                </svg>
            </div>
            <h3 class="modal-title">Agregar Nuevo M√©dico</h3>

            <form id="doctorForm" onsubmit="saveDoctor(event)">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="font-size: 0.8rem;">Nombre Completo *</label>
                    <input type="text" id="docNombre" class="form-input" required placeholder="Ej: Dr. Juan P√©rez"
                        oninput="normalizeInput(this)">
                </div>

                <div class="form-row" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label" style="font-size: 0.8rem;">Especialidad</label>
                        <input type="text" id="docEspecialidad" class="form-input" placeholder="Ej: Pediatr√≠a">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size: 0.8rem;">C√©dula</label>
                        <input type="text" id="docCedula" class="form-input" placeholder="Ej: 1234567">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 2rem;">
                    <label class="form-label" style="font-size: 0.8rem;">Tel√©fono de Contacto</label>
                    <input type="tel" id="docTelefono" class="form-input" placeholder="10 d√≠gitos">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeDoctorModal()">Cancelar</button>
                    <button type="submit" class="btn-modal btn-confirm">Guardar M√©dico</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Procedencia Modal -->
    <div id="procedenciaModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-icon" style="background: #f0fdfa; color: var(--primary);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M12 5v14M5 12h14" />
                </svg>
            </div>
            <h3 class="modal-title">Nueva Procedencia</h3>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Ingrese el nombre de la nueva procedencia:</p>

            <input type="text" id="nuevaProcedenciaInput" class="form-input" placeholder="Ej: EMERGENCIAS"
                style="margin-bottom: 1.5rem; text-transform: uppercase;"
                onkeypress="if(event.key==='Enter'){guardarNuevaProcedencia();}">

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="cerrarProcedenciaModal()">Cancelar</button>
                <button type="button" class="btn-modal btn-confirm" onclick="guardarNuevaProcedencia()">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal Comprobante de Transferencia/Dep√≥sito -->
    <div id="modalComprobante" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-icon" style="background: #fef3c7; color: #f59e0b;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21 15 16 10 5 21" />
                </svg>
            </div>
            <h3 class="modal-title">Subir Comprobante</h3>
            <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.85rem;">
                Sube la captura o foto del comprobante de transferencia/dep√≥sito
            </p>

            <div id="uploadArea"
                style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 1rem; background: #f8fafc; transition: all 0.3s;">
                <input type="file" id="comprobanteFile" accept="image/*" style="display: none;">
                <label for="comprobanteFile" style="cursor: pointer; display: block;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5"
                        style="margin: 0 auto 0.5rem;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <span style="color: #64748b; font-size: 0.85rem;">
                        Clic para seleccionar imagen<br>
                        <small style="color: #94a3b8;">JPG, PNG, WEBP</small>
                    </span>
                </label>
                <div id="comprobantePreviewModal" style="margin-top: 1rem;"></div>
            </div>

            <!-- Bot√≥n alternativo para seleccionar archivo -->
            <div style="text-align: center; margin-bottom: 1rem;">
                <button type="button" onclick="document.getElementById('comprobanteFile').click()"
                    style="background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(13,148,136,0.3); transition: all 0.3s;">
                    üìÅ Seleccionar Archivo
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="cerrarModalComprobante()">Omitir</button>
                <button type="button" class="btn-modal btn-confirm" onclick="subirComprobante()">Subir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Personalizado -->
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div id="customAlertIcon" class="modal-icon" style="background: #fee2e2; color: #ef4444;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
            </div>
            <h3 id="customAlertTitle" class="modal-title" style="font-size: 1.1rem;">Atenci√≥n</h3>
            <p id="customAlertMessage"
                style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem; line-height: 1.5;"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button type="button" class="btn-modal btn-confirm" onclick="cerrarCustomAlert()"
                    style="min-width: 120px;">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // Registrar event listeners al cargar el DOM
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM cargado, registrando listeners');

            // Listener para comprobante
            const comprobanteInput = document.getElementById('comprobanteFile');
            if (comprobanteInput) {
                console.log('comprobanteFile encontrado, agregando listener');
                comprobanteInput.addEventListener('change', function (event) {
                    console.log('Change event disparado en comprobanteFile');
                    previewComprobante(this);
                });
            } else {
                console.error('comprobanteFile NO encontrado en el DOM');
            }

            // Interceptar submit del formulario para validar fecha de nacimiento
            const form = document.getElementById('appointmentFormCompact');
            if (form) {
                form.addEventListener('submit', function (event) {
                    // Validar fecha de nacimiento no sea futura
                    const fechaNacInputs = [
                        document.getElementById('fechaNacimientoCompact'),
                        document.getElementById('fechaNacimiento')
                    ];

                    for (const input of fechaNacInputs) {
                        if (input && input.value) {
                            const fechaNac = new Date(input.value);
                            const hoy = new Date();
                            hoy.setHours(0, 0, 0, 0);

                            if (fechaNac > hoy) {
                                event.preventDefault();
                                event.stopPropagation();
                                mostrarAlerta('La fecha de nacimiento no puede ser una fecha futura.', 'Fecha inv√°lida', 'warning');
                                input.value = '';
                                input.focus();
                                return false;
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>