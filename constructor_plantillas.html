<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constructor de Plantillas - Ar Lab</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="css/performance.css">
    <script src="navbar.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --secondary: #64748b;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #0f172a;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            height: 100vh;
            /* Changed from min-height to fix scroll container */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #networkCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #0077b6 0%, #023e8a 50%, #03045e 100%);
        }

        .builder-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 1rem;
            margin-top: 80px;
            /* Added to clear fixed navbar */
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .header {
            padding: 1rem 1.5rem;
            /* Reduced padding */
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #0f172a;
            color: white;
            border: 1px solid #38bdf8;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(56, 189, 248, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            color: #0f172a;
        }

        .toolbar {
            padding: 0.75rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-icon-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 1px solid #cbd5e1;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: #334155;
            transition: all 0.2s;
        }

        .btn-icon-text:hover {
            background: #f1f5f9;
            color: #0f172a;
        }

        /* Grid Styles */
        td {
            font-size: 0.8rem;
            /* Smaller font */
        }

        .cell-input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            padding: 0.25rem;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        /* Custom Confirm Modal */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal-box {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            max-width: 420px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .confirm-modal-box h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1.1rem;
            color: #0f172a;
        }

        .confirm-modal-box p {
            margin: 0 0 1.5rem 0;
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .confirm-modal-buttons button {
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .confirm-btn-accept {
            background: #0f766e;
            color: white;
            border: none;
        }

        .confirm-btn-accept:hover {
            background: #115e59;
        }

        .confirm-btn-cancel {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .confirm-btn-cancel:hover {
            background: #f8fafc;
            color: #0f172a;
        }
    </style>
</head>

<body>
    <canvas id="networkCanvas"></canvas>
    <div id="navbar-container"></div>

    <div class="builder-container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1
                    style="font-size: 1.5rem; color: #0f172a; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem;">
                    <span style="background: #0f172a; color: #38bdf8; padding: 6px; border-radius: 8px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                            </path>
                        </svg>
                    </span>
                    Constructor de Plantillas PRO
                </h1>
                <p style="color: #64748b; font-size: 0.9rem;">Crea perfiles y estudios masivamente con una interfaz tipo
                    Excel.</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <a href="configuracion.html" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    Volver
                </a>
                <button class="btn btn-primary" id="btnProcessBuilder" onclick="analyzeBuilderGrid()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Procesar y Guardar
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn-icon-text" onclick="addBuilderRow()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nueva Fila
            </button>
            <button class="btn-icon-text" onclick="clearBuilderGrid()" style="color: #ef4444; border-color: #fecaca;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Limpiar Todo
            </button>
            <div style="width: 1px; background: #cbd5e1; height: 24px; margin: 0 0.5rem;"></div>
            <button class="btn-icon-text" onclick="openCatalogModal()"
                style="color: #0f766e; border-color: #99f6e4; background: #f0fdfa;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Ver Estudios Existentes
            </button>
            <div style="width: 1px; background: #cbd5e1; height: 24px; margin: 0 0.5rem;"></div>
            <small style="display: flex; align-items: center; color: #64748b; font-size: 0.75rem;">
                <strong style="margin-right: 8px; color: #0f766e;">Tip: Escribe el Perfil solo en la primera fila para
                    agrupar.</strong>
                <span
                    style="background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 4px; margin-right: 6px; font-family: monospace;">TAB</span>
                navegar
                <span
                    style="background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 4px; margin: 0 6px; font-family: monospace;">ENTER</span>
                nueva fila
            </small>
        </div>

        <!-- Grid Container -->
        <div style="flex: 1; overflow: auto; padding: 0; background: #f1f5f9;">
            <table style="width: 100%; border-collapse: collapse; min-width: 1000px; background: white;"
                id="builderTable">
                <thead style="position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <tr>
                        <th
                            style="width: 40px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; text-align: center; color: #64748b;">
                            #</th>
                        <th
                            style="width: 180px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Nombre del Perfil <span style="color: #ef4444">*</span>
                            <div style="font-weight: normal; font-size: 0.7rem; color: #94a3b8; text-transform: none;">
                                Agrupador</div>
                        </th>
                        <th
                            style="width: 250px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Nombre del Estudio (Analito) <span style="color: #ef4444">*</span>
                            <div style="font-weight: normal; font-size: 0.7rem; color: #94a3b8; text-transform: none;">
                                Componente</div>
                        </th>
                        <th
                            style="width: 120px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Metodología</th>
                        <th
                            style="width: 80px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Unidades</th>
                        <th
                            style="width: 110px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Tipo Ref.</th>
                        <th
                            style="width: 160px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Valores de Ref.
                            <div style="font-weight: normal; font-size: 0.7rem; color: #94a3b8; text-transform: none;">
                                Min-Max o Texto</div>
                        </th>
                        <th
                            style="width: 100px; background: #f1f5f9; border-bottom: 1px solid #94a3b8; border-right: 1px solid #94a3b8; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; text-transform: uppercase;">
                            Precio ($)</th>
                        <th style="width: 40px; background: #f8fafc; border-bottom: 1px solid #94a3b8;"></th>
                    </tr>
                </thead>
                <tbody id="builderGridBody">
                    <!-- Javascript will populate rows -->
                </tbody>
            </table>
            <div onclick="addBuilderRow()"
                style="padding: 0.75rem; text-align: center; color: #64748b; font-size: 0.85rem; cursor: pointer; border-top: 1px solid #94a3b8; background: #fcfcfc;">
                + Añadir nueva fila
            </div>
        </div>
    </div>

    <!-- Catalog Modal -->
    <div id="catalogModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
        <div
            style="background: white; width: 800px; height: 80vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <div
                style="padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="color: #0d9488;">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Catálogo de Estudios Existentes
                </h3>
                <button class="btn-icon" onclick="closeCatalogModal()"
                    style="border: none; background: #fee2e2; color: #ef4444; padding: 4px 12px; border-radius: 4px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Cerrar
                </button>
            </div>

            <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                <input type="text" id="catalogSearch" placeholder="Buscar estudio..." onkeyup="filterCatalog()"
                    style="width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; outline: none;">
            </div>

            <div style="flex: 1; overflow: auto; padding: 0;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: #f1f5f9;">
                        <tr>
                            <th style="text-align: left; padding: 10px; font-size: 0.8rem; color: #64748b;">Nombre del
                                Estudio</th>
                            <th style="text-align: left; padding: 10px; font-size: 0.8rem; color: #64748b;">Metodología
                            </th>
                            <th style="text-align: left; padding: 10px; font-size: 0.8rem; color: #64748b;">Unidades
                            </th>
                            <th style="text-align: left; padding: 10px; font-size: 0.8rem; color: #64748b;">Referencia
                            </th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="catalogTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">Cargando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div
                style="padding: 0.75rem; background: #f0fdfa; border-top: 1px solid #ccfbf1; font-size: 0.85rem; color: #115e59;">
                <strong>Instrucciones:</strong> Busca un estudio y dale click en "Copiar" para llevar sus datos a la
                fila que estás editando en el constructor.
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="confirm-modal-overlay">
        <div class="confirm-modal-box">
            <h3 id="confirmModalTitle">Confirmación</h3>
            <p id="confirmModalMessage">¿Estás seguro?</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-btn-accept" id="confirmModalAccept">Aceptar</button>
                <button class="confirm-btn-cancel" id="confirmModalCancel">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="navbar.js"></script>
    <script>
        // Supabase Client Init
        const supabaseUrl = 'https://ebihobjrwcwtjfazcjmv.supabase.co';
        const supabaseKey = 'sb_publishable_31x2oYQjyxNJ2otN6TF-Kw_5VGXaGJd';
        window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', () => {
            initAnimation();
            // Init with 3 rows
            for (let i = 0; i < 3; i++) addBuilderRow();
        });

        function clearBuilderGrid() {
            showConfirmModal('Limpiar Tabla', '¿Borrar toda la tabla? Esta acción no se puede deshacer.', () => {
                document.getElementById('builderGridBody').innerHTML = '';
                addBuilderRow();
            });
        }

        function addBuilderRow(data = {}) {
            const tbody = document.getElementById('builderGridBody');
            const rowCount = tbody.children.length + 1;
            const tr = document.createElement('tr');

            // Build Row HTML
            const cellStyle = "padding: 4px 6px; border: 1px solid #94a3b8; outline: none;";
            tr.innerHTML = `
                <td style="text-align: center; color: #64748b; font-size: 0.75rem; border: 1px solid #94a3b8; background: #f8fafc;">${rowCount}</td>
                <td contenteditable="true" class="cell-profile" style="${cellStyle} background: ${data.profile ? '#eff6ff' : 'white'}; font-weight: 600;">${data.profile || ''}</td>
                <td contenteditable="true" class="cell-study" style="${cellStyle}" onblur="checkAutofill(this)">${data.study || ''}</td>
                <td contenteditable="true" class="cell-method" style="${cellStyle}">${data.method || ''}</td>
                <td contenteditable="true" class="cell-units" style="${cellStyle}">${data.units || ''}</td>
                <td style="padding: 0; border: 1px solid #94a3b8;">
                    <select class="cell-reftype" onchange="toggleRefInput(this)" style="width: 100%; border: none; padding: 0 4px; height: 100%; outline: none; background: transparent; cursor: pointer; font-size: 0.8rem;">
                        <option value="texto" ${data.refType !== 'rango' ? 'selected' : ''}>Texto</option>
                        <option value="rango" ${data.refType === 'rango' ? 'selected' : ''}>Numérico</option>
                    </select>
                </td>
                <td class="cell-refval-container" style="padding: 4px; border: 1px solid #94a3b8; background: white;">
                    <!-- Content injected by JS -->
                </td>
                <td contenteditable="true" class="cell-price" style="${cellStyle} text-align: center;">${data.price || ''}</td>
                <td style="border: 1px solid #94a3b8; padding: 0;">
                    <button class="btn-icon" style="border: none; color: #ef4444; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer;" onclick="this.parentElement.parentElement.remove()" title="Eliminar fila">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </td>
            `;

            tbody.appendChild(tr);

            // Initialize Reference Input State
            const selectInfo = tr.querySelector('.cell-reftype');
            toggleRefInput(selectInfo, data.refVal, data.refMin, data.refMax);

            // Add Profile Auto-fill logic (visual cue)
            const profileCell = tr.querySelector('.cell-profile');
            profileCell.addEventListener('input', function () {
                this.style.background = this.innerText.trim() ? '#eff6ff' : 'white';
            });

            // Enter key Adds New Row (Global for TR, but stop propagation for Textareas)
            tr.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addBuilderRow();
                }
            });

            // Focus on first cell if new
            if (!data.profile && !data.study) setTimeout(() => profileCell.focus(), 50);
        }

        function toggleRefInput(selectElement, defaultVal = '', defaultMin = '', defaultMax = '') {
            const tr = selectElement.closest('tr');
            const container = tr.querySelector('.cell-refval-container');
            const type = selectElement.value;

            if (type === 'texto') {
                container.innerHTML = `<textarea class="ref-input-text" placeholder="Escribe..." style="width: 100%; border: none; resize: vertical; font-family: monospace; font-size: 0.8rem; outline: none; min-height: 22px; height: 22px; background: transparent; overflow: hidden; line-height: 22px;">${defaultVal || ''}</textarea>`;
            } else {
                container.innerHTML = `
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <input type="number" class="ref-input-min" placeholder="Min" value="${defaultMin || ''}" style="width: 50%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem;">
                        <span style="color: #64748b;">-</span>
                        <input type="number" class="ref-input-max" placeholder="Max" value="${defaultMax || ''}" style="width: 50%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem;">
                    </div>
                `;
            }
        }

        async function analyzeBuilderGrid() {
            const rows = document.querySelectorAll('#builderGridBody tr');
            const data = [];
            let currentProfile = null;
            let currentPrice = 0;

            // 1. Parsing
            rows.forEach((tr, index) => {
                const profileText = tr.querySelector('.cell-profile').innerText.trim();
                const studyText = tr.querySelector('.cell-study').innerText.trim();
                const methodText = tr.querySelector('.cell-method').innerText.trim();
                const units = tr.querySelector('.cell-units').innerText.trim();
                const refType = tr.querySelector('.cell-reftype').value;
                const priceText = tr.querySelector('.cell-price').innerText.trim();

                let refVal = null;
                let refMin = null;
                let refMax = null;

                if (refType === 'texto') {
                    const textarea = tr.querySelector('.ref-input-text');
                    refVal = textarea ? textarea.value : ''; // Preserve newlines
                } else {
                    const inputMin = tr.querySelector('.ref-input-min');
                    const inputMax = tr.querySelector('.ref-input-max');
                    refMin = inputMin && inputMin.value !== '' ? parseFloat(inputMin.value) : null;
                    refMax = inputMax && inputMax.value !== '' ? parseFloat(inputMax.value) : null;

                    if (refMin !== null || refMax !== null) {
                        refVal = `${refMin !== null ? refMin : '?'} - ${refMax !== null ? refMax : '?'}`;
                    }
                }

                if (!studyText && !profileText) return; // Skip empty

                if (profileText) {
                    currentProfile = profileText;
                    currentPrice = parseFloat(priceText) || 0;
                }

                if (!currentProfile) {
                    tr.style.background = '#fee2e2';
                    return;
                } else {
                    tr.style.background = 'white';
                }

                data.push({
                    profileName: currentProfile,
                    profilePrice: currentPrice,
                    studyName: studyText,
                    method: methodText,
                    units: units,
                    refType: refType,
                    refVal: refVal,
                    refMin: refMin,
                    refMax: refMax,
                    studyPrice: parseFloat(priceText) || 0
                });
            });

            if (data.length === 0) {
                showToast('La tabla está vacía.', 'error');
                return;
            }

            // 2. Grouping & Code Generation
            const grouped = {};

            data.forEach(row => {
                if (!grouped[row.profileName]) {
                    const pCode = generateCode(row.profileName, 'P');
                    grouped[row.profileName] = {
                        code: pCode,
                        name: row.profileName,
                        price: row.profilePrice,
                        studies: []
                    };
                }

                const sCode = grouped[row.profileName].code + '-' + generateCode(row.studyName, 'S');

                grouped[row.profileName].studies.push({
                    code: sCode,
                    name: row.studyName,
                    method: row.method,
                    units: row.units,
                    refType: row.refType,
                    refVal: row.refVal,
                    refMin: row.refMin,
                    refMax: row.refMax,
                    price: row.studyPrice
                });
            });

            console.log('Parsed Builder Data:', grouped);

            showConfirmModal(
                'Confirmar Creación',
                `Se han detectado ${Object.keys(grouped).length} perfiles nuevos y ${data.length} estudios en total. ¿Deseas crearlos ahora?`,
                async () => {
                    await saveDirectBulk(grouped);
                }
            );
        }

        function generateCode(text, type = 'X') {
            const clean = text.toUpperCase().replace(/[^A-Z]/g, '');
            const short = clean.substring(0, 3) || 'UNK';
            return short;
        }

        async function saveDirectBulk(groupedData) {
            const btn = document.getElementById('btnProcessBuilder');
            btn.disabled = true;
            btn.innerText = 'Procesando...';

            try {
                if (!window.supabaseClient) throw new Error("Cliente Supabase no inicializado.");

                for (const pName in groupedData) {
                    const pData = groupedData[pName];

                    // A. Create Profile
                    const { data: profileObj, error: pError } = await window.supabaseClient
                        .from('estudios_laboratorio')
                        .insert({
                            nombre: pData.name,
                            codigo: pData.code + '-' + Math.floor(Math.random() * 1000),
                            categoria: 'Perfiles',
                            es_perfil: true,
                            precio: pData.price,
                            activo: true,
                            tipo_referencia: 'texto'
                        })
                        .select()
                        .single();

                    if (pError) throw new Error(`Error creando perfil ${pName}: ${pError.message}`);

                    // B. Create Studies
                    const studyLinks = [];

                    for (let i = 0; i < pData.studies.length; i++) {
                        const s = pData.studies[i];

                        const { data: studyObj, error: sError } = await window.supabaseClient
                            .from('estudios_laboratorio')
                            .insert({
                                nombre: s.name,
                                codigo: s.code + Math.floor(Math.random() * 100),
                                categoria: 'Analitos',
                                es_perfil: false,
                                precio: s.price,
                                metodologia: s.method,
                                unidades: s.units,
                                tipo_referencia: s.refType,
                                referencia_texto: s.refType === 'texto' ? s.refVal : null,
                                referencia_min: s.refMin,
                                referencia_max: s.refMax,
                                rango_referencia: s.refVal,
                                activo: true
                            })
                            .select()
                            .single();

                        if (sError) throw new Error(`Error creando estudio ${s.name}: ${sError.message}`);

                        studyLinks.push({
                            perfil_id: profileObj.id,
                            componente_id: studyObj.id,
                            orden: i
                        });
                    }

                    // C. Link them
                    if (studyLinks.length > 0) {
                        const { error: lError } = await window.supabaseClient
                            .from('estudio_componentes')
                            .insert(studyLinks);
                        if (lError) throw lError;
                    }
                }

                showToast('¡Proceso Completado! Redirigiendo...', 'success');
                setTimeout(() => window.location.href = 'configuracion.html', 1500);

            } catch (err) {
                console.error(err);
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Procesar y Guardar';
            }
        }

        // Background Animation (Copied for consistency, minimized)
        function initAnimation() {
            const canvas = document.getElementById('networkCanvas');
            const ctx = canvas.getContext('2d');
            let width = canvas.width = window.innerWidth;
            let height = canvas.height = window.innerHeight;
            // Simple static gradient for performance in builder or minimal particles
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Custom Confirm Modal Function
        function showConfirmModal(title, message, onAccept) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const acceptBtn = document.getElementById('confirmModalAccept');
            const cancelBtn = document.getElementById('confirmModalCancel');

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.style.display = 'flex';

            // Clone and replace buttons to remove old event listeners
            const newAccept = acceptBtn.cloneNode(true);
            const newCancel = cancelBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAccept, acceptBtn);
            cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

            newAccept.addEventListener('click', () => {
                modal.style.display = 'none';
                if (onAccept) onAccept();
            });

            newCancel.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        // --- Catalog & Autofill Logic ---
        let globalCatalog = [];

        document.addEventListener('DOMContentLoaded', () => {
            initAnimation();
            loadCatalogData(); // Pre-load details
            // Init with 3 rows (Now called after DOM load to ensure data is ready or simplified init)
            // Note: Original init loop is inside another DOMContentLoaded above, which is fine, but let's centralize if possible.
            // Actually, the previous DOMContentLoaded is already there. I should add these calls there?
            // No, multiple listeners are fine.
        });

        async function loadCatalogData() {
            try {
                // Fetch only needed fields for autofill
                const { data, error } = await window.supabaseClient
                    .from('estudios_laboratorio')
                    .select('id, nombre, metodologia, unidades, tipo_referencia, rango_referencia, referencia_texto, referencia_min, referencia_max, precio');
                // Removed .eq('categoria', 'Analitos') to show ALL studies

                if (error) throw error;
                globalCatalog = data || [];
                console.log("Catalog loaded:", globalCatalog.length);
            } catch (err) {
                console.error("Error loading catalog:", err);
            }
        }

        // --- Modal Functions ---
        function openCatalogModal() {
            document.getElementById('catalogModal').style.display = 'flex';
            renderCatalogTable(globalCatalog);
            setTimeout(() => document.getElementById('catalogSearch').focus(), 100);
        }

        function closeCatalogModal() {
            document.getElementById('catalogModal').style.display = 'none';
        }

        function filterCatalog() {
            const term = document.getElementById('catalogSearch').value.toLowerCase();
            const filtered = globalCatalog.filter(e =>
                (e.nombre || '').toLowerCase().includes(term) ||
                (e.metodologia || '').toLowerCase().includes(term)
            );
            renderCatalogTable(filtered);
        }

        function renderCatalogTable(items) {
            const tbody = document.getElementById('catalogTableBody');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #64748b;">No hay coincidencias</td></tr>';
                return;
            }
            // Limit to 50 for performance
            const displayItems = items.slice(0, 50);

            tbody.innerHTML = displayItems.map(e => {
                let refDisplay = e.tipo_referencia === 'rango'
                    ? `${e.referencia_min} - ${e.referencia_max}`
                    : (e.referencia_texto || e.rango_referencia || '');
                if (refDisplay.length > 20) refDisplay = refDisplay.substring(0, 20) + '...';

                // Escape quotes for onclick params
                const safeName = (e.nombre || '').replace(/'/g, "\\'");

                return `
                <tr style="border-bottom: 1px solid #f1f5f9; hover: background #f8fafc;">
                    <td style="padding: 8px 10px; font-weight: 500;">${e.nombre}</td>
                    <td style="padding: 8px 10px; color: #64748b;">${e.metodologia || '-'}</td>
                    <td style="padding: 8px 10px;">${e.unidades || '-'}</td>
                    <td style="padding: 8px 10px; font-size: 0.75rem; color: #64748b;">${refDisplay}</td>
                    <td style="padding: 8px;">
                        <button onclick="copyToActiveRow(${e.id})" 
                                style="background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600;">
                            Copiar
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // For "Copy to Active Row", we assume the user wants to add this study to the builder.
        // It's clearer if we append a NEW row with this data.
        function copyToActiveRow(id) {
            const item = globalCatalog.find(i => i.id === id);
            if (!item) return;

            // Create a pre-filled row
            addBuilderRow({
                study: item.nombre,
                method: item.metodologia,
                units: item.unidades,
                refType: item.tipo_referencia,
                refVal: item.tipo_referencia === 'texto' ? (item.referencia_texto || item.rango_referencia) : '',
                refMin: item.referencia_min,
                refMax: item.referencia_max,
                price: item.precio
            });

            showToast('Estudio agregado: ' + item.nombre);
            closeCatalogModal();
        }

        // --- Smart Autofill Logic ---
        function checkAutofill(cell) {
            const name = cell.innerText.trim();
            if (name.length < 3) return;

            // Find exact or very close match
            const match = globalCatalog.find(e => e.nombre.toLowerCase() === name.toLowerCase());

            if (match) {
                const tr = cell.parentElement;

                // Only fill if empty to avoid overwriting user edits
                const methodCell = tr.querySelector('.cell-method');
                const unitsCell = tr.querySelector('.cell-units');
                // const priceCell = tr.querySelector('.cell-price'); 

                // Keep existing values if present, otherwise fill
                if (!methodCell.innerText.trim()) methodCell.innerText = match.metodologia || '';
                if (!unitsCell.innerText.trim()) unitsCell.innerText = match.unidades || '';

                // Ref Logic is trickier, we update only if currently default/empty
                const refTypeSelect = tr.querySelector('.cell-reftype');
                const currentRefType = refTypeSelect.value;
                const refContainer = tr.querySelector('.cell-refval-container');

                // Simple heuristic: if we haven't touched the ref type (default 'texto') and it's empty
                // Update it.
                // Or better: just always suggest/update if it's a strong match? 
                // Let's go with: Update ref type and values always if match found, assuming user wants that.

                if (refTypeSelect.value !== match.tipo_referencia) {
                    refTypeSelect.value = match.tipo_referencia || 'texto';
                }

                toggleRefInput(refTypeSelect,
                    match.tipo_referencia === 'texto' ? (match.referencia_texto || match.rango_referencia) : '',
                    match.referencia_min,
                    match.referencia_max
                );

                // Highlight success
                cell.style.background = '#f0fdfa';
                setTimeout(() => cell.style.background = 'white', 1000);

                showToast('Datos autocompletados', 'success');
            }
        }
    </script>
</body>

</html>